// ç¢ºä¿ zoom æ’ä»¶æ­£ç¢ºè¨»å†Š
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chart object:', typeof Chart);
    console.log('Available Chart plugins:', Chart.registry ? Object.keys(Chart.registry.plugins.items) : 'No registry');
});

// --- ä¸»å›æ¸¬å‡½æ•¸ ---
function runBacktestInternal() {
    console.log("[Main] runBacktestInternal called");
    if (!workerUrl) { showError("èƒŒæ™¯è¨ˆç®—å¼•æ“å°šæœªæº–å‚™å°±ç·’ï¼Œè«‹ç¨å€™å†è©¦æˆ–é‡æ–°è¼‰å…¥é é¢ã€‚"); hideLoading(); return; }
    try {
        const params=getBacktestParams();
        console.log("[Main] Params:", params);
        const isValid = validateBacktestParams(params);
        console.log("[Main] Validation:", isValid);
        if(!isValid) return;

        const curSettings={stockNo:params.stockNo, startDate:params.startDate, endDate:params.endDate};
        const useCache=!needsDataFetch(curSettings);
        const msg=useCache?"âŒ› ä½¿ç”¨å¿«å–åŸ·è¡Œå›æ¸¬...":"âŒ› ç²å–æ•¸æ“šä¸¦å›æ¸¬...";
        showLoading(msg);
        clearPreviousResults(); // Clear previous results including suggestion

        if(backtestWorker) { // Ensure previous worker is terminated
            backtestWorker.terminate();
            backtestWorker = null;
            console.log("[Main] Terminated previous worker.");
        }
        console.log("[Main] WorkerUrl:", workerUrl);
        console.log("[Main] Creating worker...");
        backtestWorker=new Worker(workerUrl);

        // Unified Worker Message Handler
        backtestWorker.onmessage=e=>{
            const{type,data,progress,message,stockNo,marketType}=e.data;
            console.log("[Main] Received message from worker:", type, data); // Debug log

            if(type==='progress'){
                updateProgress(progress);
                if(message)document.getElementById('loadingText').textContent=`âŒ› ${message}`;
            } else if(type==='marketError'){
                // è™•ç†å¸‚å ´æŸ¥è©¢éŒ¯èª¤ï¼Œé¡¯ç¤ºæ™ºæ…§éŒ¯èª¤è™•ç†å°è©±æ¡†
                hideLoading();
                if (window.showMarketSwitchModal) {
                    window.showMarketSwitchModal(message, marketType, stockNo);
                } else {
                    console.error('[Main] showMarketSwitchModal function not found');
                    showError(message);
                }
            } else if(type==='stockNameInfo'){
                // è™•ç†è‚¡ç¥¨åç¨±è³‡è¨Šï¼Œé¡¯ç¤ºåœ¨UIä¸Š
                if (window.showStockName) {
                    window.showStockName(e.data.stockName, e.data.stockNo, e.data.marketType);
                }
            } else if(type==='result'){
                // Handle backtest result
                if(!useCache&&data?.rawData){
                     // workerCachedStockData is defined in worker.js, this might be an issue if not handled correctly
                     // For now, we assume cachedStockData in the main thread is the source of truth if worker needs it.
                     cachedStockData = data.rawData;
                     lastFetchSettings=curSettings;
                     console.log(`[Main] Data cached for ${curSettings.stockNo}.`);
                } else if (useCache && cachedStockData ) {
                     console.log("[Main] Using main thread cached data for worker if needed.");
                } else if(!useCache) {
                     console.warn("[Main] No rawData to cache from backtest.");
                }
                handleBacktestResult(data); // Process and display main results

                // Request suggestion AFTER processing main results
                getSuggestion();

            } else if(type==='suggestionResult'){
                const suggestionArea = document.getElementById('today-suggestion-area');
                const suggestionText = document.getElementById('suggestion-text');
                if(suggestionArea && suggestionText){
                    suggestionText.textContent = data.suggestion || 'ç„¡æ³•å–å¾—å»ºè­°';
                    suggestionArea.classList.remove('hidden', 'loading');
                     suggestionArea.className = 'my-4 p-4 border-l-4 rounded-md text-center'; // Base classes
                    if (data.suggestion === 'åšå¤šè²·å…¥' || data.suggestion === 'æŒæœ‰ (å¤š)') { suggestionArea.classList.add('bg-green-50', 'border-green-500', 'text-green-800'); }
                    else if (data.suggestion === 'åšç©ºè³£å‡º' || data.suggestion === 'æŒæœ‰ (ç©º)') { suggestionArea.classList.add('bg-red-50', 'border-red-500', 'text-red-800'); }
                    else if (data.suggestion === 'åšå¤šè³£å‡º' || data.suggestion === 'åšç©ºå›è£œ') { suggestionArea.classList.add('bg-yellow-50', 'border-yellow-500', 'text-yellow-800'); }
                    else if (data.suggestion === 'ç­‰å¾…') { suggestionArea.classList.add('bg-gray-100', 'border-gray-400', 'text-gray-600'); }
                     else { suggestionArea.classList.add('bg-gray-100', 'border-gray-400', 'text-gray-600'); }

                    hideLoading();
                    showSuccess("å›æ¸¬å®Œæˆï¼");
                    if(backtestWorker) backtestWorker.terminate(); backtestWorker = null;
                }
            } else if(type==='suggestionError'){
                const suggestionArea = document.getElementById('today-suggestion-area');
                const suggestionText = document.getElementById('suggestion-text');
                if(suggestionArea && suggestionText){
                    suggestionText.textContent = data.message || 'è¨ˆç®—å»ºè­°æ™‚ç™¼ç”ŸéŒ¯èª¤';
                    suggestionArea.classList.remove('hidden', 'loading');
                    suggestionArea.className = 'my-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md text-center';
                }
                 hideLoading();
                 showError("å›æ¸¬å®Œæˆï¼Œä½†è¨ˆç®—å»ºè­°æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚");
                 if(backtestWorker) backtestWorker.terminate(); backtestWorker = null;
            } else if(type==='error'){
                showError(data?.message||'å›æ¸¬éç¨‹éŒ¯èª¤');
                if(backtestWorker)backtestWorker.terminate(); backtestWorker=null;
                hideLoading();
                const suggestionArea = document.getElementById('today-suggestion-area');
                 if (suggestionArea) suggestionArea.classList.add('hidden');
            }
        };

        backtestWorker.onerror=e=>{
             showError(`WorkeréŒ¯èª¤: ${e.message}`); console.error("[Main] Worker Error:",e);
             if(backtestWorker)backtestWorker.terminate(); backtestWorker=null;
             hideLoading();
             const suggestionArea = document.getElementById('today-suggestion-area');
              if (suggestionArea) suggestionArea.classList.add('hidden');
        };

        const workerMsg={type:'runBacktest', params:params, useCachedData:useCache};
        if(useCache && cachedStockData) {
            workerMsg.cachedData = cachedStockData; // Send main thread cache to worker
            console.log("[Main] Sending cached data to worker for backtest.");
        } else {
            console.log("[Main] Fetching new data for backtest.");
        }
        backtestWorker.postMessage(workerMsg);

    } catch (error) {
        console.error("[Main] Error in runBacktestInternal:", error);
        showError(`åŸ·è¡Œå›æ¸¬æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
        hideLoading();
        const suggestionArea = document.getElementById('today-suggestion-area');
        if (suggestionArea) suggestionArea.classList.add('hidden');
        if(backtestWorker)backtestWorker.terminate(); backtestWorker = null;
    }
}

// **ä¿®æ”¹ï¼šclearPreviousResults - ç¢ºä¿è¨Šæ¯å€é‡ç½®**
function clearPreviousResults() {
    document.getElementById("backtest-result").innerHTML=`<p class="text-gray-500">è«‹åŸ·è¡Œå›æ¸¬</p>`;
    document.getElementById("trade-results").innerHTML=`<p class="text-gray-500">è«‹åŸ·è¡Œå›æ¸¬</p>`;
    document.getElementById("optimization-results").innerHTML=`<p class="text-gray-500">è«‹åŸ·è¡Œå„ªåŒ–</p>`;
    document.getElementById("performance-table-container").innerHTML=`<p class="text-gray-500">è«‹å…ˆåŸ·è¡Œå›æ¸¬ä»¥ç”ŸæˆæœŸé–“ç¸¾æ•ˆæ•¸æ“šã€‚</p>`;
    if(stockChart){
        stockChart.destroy(); 
        stockChart=null; 
        const chartContainer = document.getElementById('chart-container');
        if (chartContainer) {
            chartContainer.innerHTML = '<canvas id="chart" class="w-full h-full absolute inset-0"></canvas><div class="text-muted text-center" style="color: var(--muted-foreground);"><i data-lucide="bar-chart-3" class="lucide w-12 h-12 mx-auto mb-2 opacity-50"></i><p>åŸ·è¡Œå›æ¸¬å¾Œå°‡é¡¯ç¤ºæ·¨å€¼æ›²ç·š</p></div>';
            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
        }
    }
    const resEl=document.getElementById("result");
    resEl.className = 'my-6 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-700 rounded-md';
    resEl.innerHTML = `<i class="fas fa-info-circle mr-2"></i> è«‹è¨­å®šåƒæ•¸ä¸¦åŸ·è¡Œã€‚`;
    lastOverallResult = null; lastSubPeriodResults = null;
    
    // ä¸è¦åœ¨é€™è£¡éš±è—å„ªåŒ–é€²åº¦ï¼Œè®“å„ªåŒ–å‡½æ•¸è‡ªå·±æ§åˆ¶
    // hideOptimizationProgress();
    
    const suggestionArea = document.getElementById('today-suggestion-area');
    const suggestionText = document.getElementById('suggestion-text');
    if (suggestionArea && suggestionText) {
        suggestionArea.classList.add('hidden');
        suggestionArea.className = 'my-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 rounded-md text-center hidden'; // Reset style and hide
        suggestionText.textContent = "-";
    }
}
// --- çµæœé¡¯ç¤ºå‡½æ•¸ ---
function displayPerformanceTable(subPeriodResults) { const container = document.getElementById('performance-table-container'); if (!lastOverallResult) { container.innerHTML = `<p class="text-gray-500">è«‹å…ˆåŸ·è¡Œå›æ¸¬ä»¥ç”Ÿæˆç¸¾æ•ˆæ•¸æ“šã€‚</p>`; return; } const periods = subPeriodResults ? Object.keys(subPeriodResults) : []; const periodOrder = {'1M': 1, '6M': 2, '1Y': 3, '2Y': 4, '3Y': 5, '4Y': 6, '5Y': 7, '6Y': 8, '7Y': 9, '8Y': 10, '9Y': 11, '10Y': 12}; periods.sort((a, b) => (periodOrder[a] || 99) - (periodOrder[b] || 99)); let tableHtml = ` <div class="overflow-x-auto"> <table class="w-full text-sm text-left text-gray-500"> <thead class="text-xs text-gray-700 uppercase bg-gray-50"> <tr> <th scope="col" class="px-4 py-3">æœŸé–“</th> <th scope="col" class="px-4 py-3">ç­–ç•¥ç´¯ç©å ±é…¬ (%)</th> <th scope="col" class="px-4 py-3">è²·å…¥æŒæœ‰ç´¯ç©å ±é…¬ (%)</th> <th scope="col" class="px-4 py-3">å¤æ™®å€¼ (ç­–ç•¥)</th> <th scope="col" class="px-4 py-3">ç´¢æè«¾æ¯”ç‡ (ç­–ç•¥)</th> <th scope="col" class="px-4 py-3">æœ€å¤§å›æ’¤ (ç­–ç•¥ %)</th> </tr> </thead> <tbody>`; periods.forEach(period => { const data = subPeriodResults ? subPeriodResults[period] : null; if (data) { const totalReturn = data.totalReturn?.toFixed(2) ?? 'N/A'; const totalBhReturn = data.totalBuyHoldReturn?.toFixed(2) ?? 'N/A'; const sharpe = data.sharpeRatio?.toFixed(2) ?? 'N/A'; const sortino = data.sortinoRatio ? (isFinite(data.sortinoRatio) ? data.sortinoRatio.toFixed(2) : 'âˆ') : 'N/A'; const maxDD = data.maxDrawdown?.toFixed(2) ?? 'N/A'; const returnClass = (data.totalReturn ?? 0) >= 0 ? 'text-green-600' : 'text-red-600'; const bhReturnClass = (data.totalBuyHoldReturn ?? 0) >= 0 ? 'text-green-600' : 'text-red-600'; tableHtml += ` <tr class="border-b hover:bg-gray-50"> <td class="px-4 py-2 font-medium text-gray-900 whitespace-nowrap">${period}</td> <td class="px-4 py-2 ${returnClass}">${totalReturn === 'N/A' ? totalReturn : totalReturn + '%'}</td> <td class="px-4 py-2 ${bhReturnClass}">${totalBhReturn === 'N/A' ? totalBhReturn : totalBhReturn + '%'}</td> <td class="px-4 py-2">${sharpe}</td> <td class="px-4 py-2">${sortino}</td> <td class="px-4 py-2 text-red-600">${maxDD}%</td> </tr>`; } }); tableHtml += `</tbody></table></div>`; container.innerHTML = tableHtml; } function handleBacktestResult(result) { console.log("[Main] handleBacktestResult received:", result); const suggestionArea = document.getElementById('today-suggestion-area'); if(!result||!result.dates||result.dates.length===0){ showError("å›æ¸¬çµæœç„¡æ•ˆæˆ–ç„¡æ•¸æ“š"); lastOverallResult = null; lastSubPeriodResults = null; if (suggestionArea) suggestionArea.classList.add('hidden'); hideLoading(); return; } try { lastOverallResult = result; lastSubPeriodResults = result.subPeriodResults; displayBacktestResult(result); displayTradeResults(result); renderChart(result); displayPerformanceTable(lastSubPeriodResults); activateTab('summary'); // å›æ¸¬çµæŸå¾Œè‡ªå‹•æ»¾å‹•åˆ°æ·¨å€¼æ›²ç·šåœ– setTimeout(() => { const chartContainer = document.getElementById('chart-container'); if (chartContainer) { chartContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }, 500); // ç­‰å¾…500msç¢ºä¿åœ–è¡¨å·²æ¸²æŸ“å®Œæˆ } catch (error) { console.error("[Main] Error processing backtest result:", error); showError(`è™•ç†å›æ¸¬çµæœæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`); if (suggestionArea) suggestionArea.classList.add('hidden'); hideLoading(); if(backtestWorker) backtestWorker.terminate(); backtestWorker = null; } } function displayBacktestResult(result) { console.log("[Main] displayBacktestResult called."); const el = document.getElementById("backtest-result"); if (!el) { console.error("[Main] Element 'backtest-result' not found"); return; } if (!result) { el.innerHTML = `<p class="text-gray-500">ç„¡æ•ˆçµæœ</p>`; return; } const entryKey = result.entryStrategy; const exitKeyRaw = result.exitStrategy; const exitInternalKey = (['ma_cross','macd_cross','k_d_cross','ema_cross'].includes(exitKeyRaw)) ? `${exitKeyRaw}_exit` : exitKeyRaw; const entryDesc = strategyDescriptions[entryKey] || { name: result.entryStrategy || 'N/A', desc: 'N/A' }; const exitDesc = strategyDescriptions[exitInternalKey] || { name: result.exitStrategy || 'N/A', desc: 'N/A' }; let shortEntryDesc = null, shortExitDesc = null; if (result.enableShorting && result.shortEntryStrategy && result.shortExitStrategy) { shortEntryDesc = strategyDescriptions[result.shortEntryStrategy] || { name: result.shortEntryStrategy, desc: 'N/A' }; shortExitDesc = strategyDescriptions[result.shortExitStrategy] || { name: result.shortExitStrategy, desc: 'N/A' }; } const avgP = result.completedTrades?.length > 0 ? result.completedTrades.reduce((s, t) => s + (t.profit||0), 0) / result.completedTrades.length : 0; const maxCL = result.maxConsecutiveLosses || 0; const bhR = parseFloat(result.buyHoldReturns?.[result.buyHoldReturns.length - 1] ?? 0); const bhAnnR = result.buyHoldAnnualizedReturn ?? 0; const sharpe = result.sharpeRatio?.toFixed(2) ?? 'N/A'; const sortino = result.sortinoRatio ? (isFinite(result.sortinoRatio) ? result.sortinoRatio.toFixed(2) : 'âˆ') : 'N/A'; const maxDD = result.maxDrawdown?.toFixed(2) ?? 0; const totalTrades = result.tradesCount ?? 0; const winTrades = result.winTrades ?? 0; const winR = totalTrades > 0 ? (winTrades / totalTrades * 100).toFixed(1) : 0; const totalProfit = result.totalProfit ?? 0; const returnRate = result.returnRate ?? 0; const annualizedReturn = result.annualizedReturn ?? 0; const finalValue = result.finalValue ?? result.initialCapital; let annReturnRatioStr = 'N/A'; let sharpeRatioStr = 'N/A'; if (result.annReturnHalf1 !== null && result.annReturnHalf2 !== null && result.annReturnHalf1 !== 0) { annReturnRatioStr = (result.annReturnHalf2 / result.annReturnHalf1).toFixed(2); } if (result.sharpeHalf1 !== null && result.sharpeHalf2 !== null && result.sharpeHalf1 !== 0) { sharpeRatioStr = (result.sharpeHalf2 / result.sharpeHalf1).toFixed(2); } const overfittingTooltip = `æ¯”è¼ƒå›æ¸¬æœŸé–“å‰å¾Œå…©åŠæ®µçš„è¡¨ç¾ï¼Œä»¥è©•ä¼°ç­–ç•¥çš„ç©©å®šæ€§ã€‚
æ¯”å€¼æ¥è¿‘ 1 è¡¨ç¤ºç­–ç•¥åœ¨ä¸åŒæ™‚æœŸè¡¨ç¾ä¸€è‡´ï¼Œéé«˜æˆ–éä½å¯èƒ½è¡¨ç¤ºéæ“¬åˆã€‚
å…¬å¼ï¼šå¾ŒåŠæ®µæŒ‡æ¨™ / å‰åŠæ®µæŒ‡æ¨™`; let performanceHtml = ` <div class="mb-8"> <h4 class="text-lg font-semibold mb-6" style="color: var(--foreground);">ç¸¾æ•ˆæŒ‡æ¨™</h4> <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4"> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, var(--primary) 8%, var(--background)) 0%, color-mix(in srgb, var(--primary) 4%, var(--background)) 100%); border-color: color-mix(in srgb, var(--primary) 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--primary);">å¹´åŒ–å ±é…¬ç‡</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">å°‡ç¸½å ±é…¬ç‡æ ¹æ“šå¯¦éš›å›æ¸¬æœŸé–“ï¼ˆå¾ç¬¬ä¸€å€‹æœ‰æ•ˆæ•¸æ“šé»åˆ°æœ€å¾Œä¸€å€‹æ•¸æ“šé»ï¼‰è½‰æ›ç‚ºå¹´å¹³å‡è¤‡åˆ©å ±é…¬ç‡ã€‚<br>å…¬å¼ï¼š((æœ€çµ‚åƒ¹å€¼ / åˆå§‹æœ¬é‡‘)^(1 / å¹´æ•¸) - 1) * 100%<br>æ³¨æ„ï¼šæ­¤æ•¸å€¼å°å›æ¸¬æ™‚é–“é•·åº¦æ•æ„Ÿï¼ŒçŸ­æœŸé«˜å ±é…¬å¯èƒ½å°è‡´æ¥µé«˜çš„å¹´åŒ–å ±é…¬ç‡ã€‚</span> </span> </div> <p class="text-2xl font-bold ${annualizedReturn>=0?'text-emerald-600':'text-rose-600'}">${annualizedReturn>=0?'+':''}${annualizedReturn.toFixed(2)}%</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: color-mix(in srgb, var(--muted) 15%, var(--background)); border-color: color-mix(in srgb, var(--border) 80%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--muted-foreground);">è²·å…¥æŒæœ‰å¹´åŒ–</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">åœ¨ç›¸åŒå¯¦éš›å›æ¸¬æœŸé–“å…§ï¼Œå–®ç´”è²·å…¥ä¸¦æŒæœ‰è©²è‚¡ç¥¨çš„å¹´åŒ–å ±é…¬ç‡ã€‚å…¬å¼åŒä¸Šï¼Œä½†ä½¿ç”¨è‚¡åƒ¹è¨ˆç®—ã€‚</span> </span> </div> <p class="text-2xl font-bold ${bhAnnR>=0?'text-emerald-600':'text-rose-600'}">${bhAnnR>=0?'+':''}${bhAnnR.toFixed(2)}%</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, #10b981 8%, var(--background)) 0%, color-mix(in srgb, #10b981 4%, var(--background)) 100%); border-color: color-mix(in srgb, #10b981 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium text-emerald-600">ç¸½å ±é…¬ç‡</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">ç­–ç•¥æœ€çµ‚ç¸½è³‡ç”¢ç›¸å°æ–¼åˆå§‹æœ¬é‡‘çš„å ±é…¬ç‡ã€‚<br>å…¬å¼ï¼š(æœ€çµ‚åƒ¹å€¼ - åˆå§‹æœ¬é‡‘) / åˆå§‹æœ¬é‡‘ * 100%<br>æ­¤ç‚ºç·šæ€§å ±é…¬ç‡ï¼Œä¸è€ƒæ…®æ™‚é–“å› ç´ ã€‚</span> </span> </div> <p class="text-2xl font-bold ${returnRate>=0?'text-emerald-600':'text-rose-600'}">${returnRate>=0?'+':''}${returnRate.toFixed(2)}%</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 8%, var(--background)) 0%, color-mix(in srgb, var(--accent) 4%, var(--background)) 100%); border-color: color-mix(in srgb, var(--accent) 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--accent);">Buy & Hold</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">è²·å…¥æŒæœ‰ç¸½å ±é…¬ç‡</span> </span> </div> <p class="text-2xl font-bold ${bhR>=0?'text-emerald-600':'text-rose-600'}">${bhR>=0?'+':''}${bhR.toFixed(2)}%</p> </div> </div> </div> </div>`; let riskHtml = ` <div class="mb-8"> <h4 class="text-lg font-semibold mb-6" style="color: var(--foreground);">é¢¨éšªæŒ‡æ¨™</h4> <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4"> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, #ef4444 8%, var(--background)) 0%, color-mix(in srgb, #ef4444 4%, var(--background)) 100%); border-color: color-mix(in srgb, #ef4444 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium text-rose-600">æœ€å¤§å›æ’¤</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">ç­–ç•¥**ç¸½è³‡é‡‘**æ›²ç·šå¾æ­·å²æœ€é«˜é»å›è½åˆ°æœ€ä½é»çš„æœ€å¤§ç™¾åˆ†æ¯”è·Œå¹…ã€‚å…¬å¼ï¼š(å³°å€¼ - è°·å€¼) / å³°å€¼ * 100%</span> </span> </div> <p class="text-2xl font-bold text-rose-600">${maxDD}%</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, var(--primary) 8%, var(--background)) 0%, color-mix(in srgb, var(--primary) 4%, var(--background)) 100%); border-color: color-mix(in srgb, var(--primary) 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--primary);">å¤æ™®å€¼</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">è¡¡é‡æ¯å–®ä½ç¸½é¢¨éšª(æ¨™æº–å·®)æ‰€ç²å¾—çš„è¶…é¡å ±é…¬ã€‚é€šå¸¸ > 1 è¡¨ç¤ºä¸éŒ¯ï¼Œ> 2 ç›¸ç•¶å¥½ï¼Œ> 3 éå¸¸å„ªç§€ (ç›¸å°æ–¼ç„¡é¢¨éšªåˆ©ç‡)ã€‚</span> </span> </div> <p class="text-2xl font-bold" style="color: var(--primary);">${sharpe}</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background:  color-mix(in srgb, var(--muted) 12%, var(--background)); border-color: color-mix(in srgb, var(--border) 60%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--muted-foreground);">ç´¢æè«¾æ¯”ç‡</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">è¡¡é‡æ¯å–®ä½ 'ä¸‹æª”é¢¨éšª' æ‰€ç²å¾—çš„è¶…é¡å ±é…¬ (åªè€ƒæ…®è™§æçš„æ³¢å‹•)ã€‚è¶Šé«˜è¶Šå¥½ï¼Œé€šå¸¸ç”¨æ–¼æ¯”è¼ƒä¸åŒç­–ç•¥æ‰¿å—è™§æé¢¨éšªçš„èƒ½åŠ›ã€‚</span> </span> </div> <p class="text-2xl font-bold" style="color: var(--muted-foreground);">${sortino}</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 8%, var(--background)) 0%, color-mix(in srgb, var(--accent) 4%, var(--background)) 100%); border-color: color-mix(in srgb, var(--accent) 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--accent);">éæ“¬åˆ(å ±é…¬ç‡æ¯”)</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">${overfittingTooltip}</span> </span> </div> <p class="text-2xl font-bold" style="color: var(--accent);">${annReturnRatioStr}</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: color-mix(in srgb, var(--secondary) 6%, var(--background)); border-color: color-mix(in srgb, var(--secondary) 20%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--secondary);">éæ“¬åˆ(å¤æ™®å€¼æ¯”)</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">${overfittingTooltip}</span> </span> </div> <p class="text-2xl font-bold" style="color: var(--secondary);">${sharpeRatioStr}</p> </div> </div> </div> </div>`; let tradeStatsHtml = ` <div class="mb-8"> <h4 class="text-lg font-semibold mb-6" style="color: var(--foreground);">äº¤æ˜“çµ±è¨ˆ</h4> <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: color-mix(in srgb, var(--muted) 12%, var(--background)); border-color: color-mix(in srgb, var(--border) 60%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--muted-foreground);">å‹ç‡</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">åŒ…å«åšå¤šèˆ‡åšç©ºäº¤æ˜“</span> </span> </div> <p class="text-2xl font-bold" style="color: var(--foreground);">${winR}%</p> <p class="text-sm mt-1" style="color: var(--muted-foreground);">(${winTrades}/${totalTrades})</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: color-mix(in srgb, var(--muted) 12%, var(--background)); border-color: color-mix(in srgb, var(--border) 60%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--muted-foreground);">ç¸½äº¤æ˜“æ¬¡æ•¸</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">åŒ…å«åšå¤šèˆ‡åšç©ºäº¤æ˜“</span> </span> </div> <p class="text-2xl font-bold" style="color: var(--foreground);">${totalTrades}</p> <p class="text-sm mt-1" style="color: var(--muted-foreground);">æ¬¡</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: color-mix(in srgb, var(--muted) 12%, var(--background)); border-color: color-mix(in srgb, var(--border) 60%, transparent);"> <div class="text-center"> <p class="text-sm font-medium mb-3" style="color: var(--muted-foreground);">å¹³å‡äº¤æ˜“ç›ˆè™§</p> <p class="text-2xl font-bold ${avgP>=0?'text-emerald-600':'text-rose-600'}">${avgP>=0?'+':''}${Math.round(avgP).toLocaleString()}å…ƒ</p> <p class="text-sm mt-1" style="color: var(--muted-foreground);">å…ƒ</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: color-mix(in srgb, var(--muted) 12%, var(--background)); border-color: color-mix(in srgb, var(--border) 60%, transparent);"> <div class="text-center"> <p class="text-sm font-medium mb-3" style="color: var(--muted-foreground);">æœ€å¤§é€£è™§æ¬¡æ•¸</p> <p class="text-2xl font-bold" style="color: var(--foreground);">${maxCL}</p> <p class="text-sm mt-1" style="color: var(--muted-foreground);">æ¬¡</p> </div> </div> </div> </div>`; let strategySettingsHtml = ` <div> <h4 class="text-lg font-semibold mb-6" style="color: var(--foreground);">ç­–ç•¥è¨­å®š</h4> <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, #10b981 8%, var(--background)) 0%, color-mix(in srgb, #10b981 4%, var(--background)) 100%); border-color: color-mix(in srgb, #10b981 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium text-emerald-600">ğŸ“ˆ é€²å ´ç­–ç•¥</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">${entryDesc.desc.replace(/\n/g,'<br>')}</span> </span> </div> <p class="text-base font-semibold" style="color: var(--foreground);">${entryDesc.name}</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, #ef4444 8%, var(--background)) 0%, color-mix(in srgb, #ef4444 4%, var(--background)) 100%); border-color: color-mix(in srgb, #ef4444 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium text-rose-600">ğŸ“‰ å‡ºå ´ç­–ç•¥</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">${exitDesc.desc.replace(/\n/g,'<br>')}</span> </span> </div> <p class="text-base font-semibold" style="color: var(--foreground);">${exitDesc.name}</p> </div> </div> ${ result.enableShorting && shortEntryDesc && shortExitDesc ? ` <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 8%, var(--background)) 0%, color-mix(in srgb, var(--accent) 4%, var(--background)) 100%); border-color: color-mix(in srgb, var(--accent) 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--accent);">ğŸ“‰ åšç©ºç­–ç•¥</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">${shortEntryDesc.desc.replace(/\n/g,'<br>')}</span> </span> </div> <p class="text-base font-semibold" style="color: var(--foreground);">${shortEntryDesc.name}</p> </div> </div> <div class="p-6 rounded-xl border shadow-sm transition-all duration-200 hover:shadow-md" style="background: linear-gradient(135deg, color-mix(in srgb, var(--primary) 8%, var(--background)) 0%, color-mix(in srgb, var(--primary) 4%, var(--background)) 100%); border-color: color-mix(in srgb, var(--primary) 25%, transparent);"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm font-medium" style="color: var(--primary);">ğŸ“ˆ å›è£œç­–ç•¥</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs rounded-full cursor-help" style="background-color: var(--primary); color: var(--primary-foreground);">?</span> <span class="tooltiptext">${shortExitDesc.desc.replace(/\n/g,'<br>')}</span> </span> </div> <p class="text-base font-semibold" style="color: var(--foreground);">${shortExitDesc.name}</p> </div> </div>` : ` <div class="p-6 rounded-xl border shadow-sm" style="background: color-mix(in srgb, var(--muted) 15%, var(--background)); border-color: color-mix(in srgb, var(--border) 80%, transparent);"> <div class="text-center"> <p class="text-sm font-medium" style="color: var(--muted-foreground);">ğŸ“‰ åšç©ºç­–ç•¥æœªå•Ÿç”¨</p> </div> </div> <div class="bg-gray-100 p-6 rounded-xl border border-gray-200 shadow-sm"> <div class="text-center"> <p class="text-sm text-gray-500 font-medium">ğŸ“ˆ å›è£œç­–ç•¥æœªå•Ÿç”¨</p> </div> </div> `} <div class="bg-orange-50 p-6 rounded-xl border border-orange-200 shadow-sm"> <div class="text-center"> <div class="flex items-center justify-center mb-3"> <p class="text-sm text-orange-600 font-medium">âš ï¸ å…¨å±€é¢¨æ§</p> <span class="tooltip ml-2"> <span class="info-icon inline-flex items-center justify-center w-5 h-5 text-xs bg-blue-600 text-white rounded-full cursor-help">?</span> <span class="tooltiptext">åœæ/åœåˆ©è¨­å®š (å¤šç©ºå…±ç”¨)</span> </span> </div> <p class="text-base font-semibold text-gray-800">æ:${result.stopLoss>0?result.stopLoss+'%':'N/A'} / åˆ©:${result.takeProfit>0?result.takeProfit+'%':'N/A'}</p> </div> </div> <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 shadow-sm"> <div class="text-center"> <p class="text-sm text-indigo-600 font-medium mb-3">â° è²·è³£æ™‚é–“é»</p> <p class="text-base font-semibold text-gray-800">${result.tradeTiming==='open'?'éš”æ—¥é–‹ç›¤':'ç•¶æ—¥æ”¶ç›¤'}</p> </div> </div> <div class="bg-blue-50 p-6 rounded-xl border border-blue-200 shadow-sm"> <div class="text-center"> <p class="text-sm text-blue-600 font-medium mb-3">ğŸ’° åˆå§‹æœ¬é‡‘</p> <p class="text-base font-semibold text-gray-800">${result.initialCapital.toLocaleString()}å…ƒ</p> </div> </div> <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-200 shadow-sm"> <div class="text-center"> <p class="text-sm text-yellow-600 font-medium mb-3">ğŸ† æœ€çµ‚è³‡ç”¢</p> <p class="text-base font-semibold text-gray-800">${Math.round(finalValue).toLocaleString()}å…ƒ</p> </div> </div> </div> </div>`; // å°‡å››å€‹å€å¡Šå‚ç›´æ’åˆ—ï¼Œä¸¦æ·»åŠ é©ç•¶çš„é–“è· el.innerHTML = ` <div class="space-y-8"> ${performanceHtml} ${riskHtml} ${tradeStatsHtml} ${strategySettingsHtml} </div> `; console.log("[Main] displayBacktestResult finished."); } const checkDisplay = (v) => v !== null && v !== undefined && !isNaN(v); const formatIndicatorValues = (indicatorValues) => { try { if (!indicatorValues || typeof indicatorValues !== 'object' || Object.keys(indicatorValues).length === 0) return ''; const formatV = (v) => checkDisplay(v) ? v.toFixed(2) : '--'; const parts = Object.entries(indicatorValues).map(([label, values]) => { if (Array.isArray(values) && values.length === 3) { return `<span class="mr-2 whitespace-nowrap text-xs" style="color: var(--muted-foreground);">${label}: ${formatV(values[0])} / ${formatV(values[1])} / ${formatV(values[2])}</span>`; } else if (checkDisplay(values)) { return `<span class="mr-2 whitespace-nowrap text-xs" style="color: var(--muted-foreground);">${label}: ${formatV(values)}</span>`; } else if (Array.isArray(values) && values.length === 2){ return `<span class="mr-2 whitespace-nowrap text-xs" style="color: var(--muted-foreground);">${label}: ${formatV(values[0])} / ${formatV(values[1])}</span>`; } return `<span class="mr-2 whitespace-nowrap text-xs" style="color: var(--muted-foreground);">${label}: ?</span>`; }).filter(part => part !== null); return parts.length > 0 ? '<div class="mt-1 text-xs" style="color: var(--muted-foreground);">(' + parts.join(' ') + ')</div>' : ''; } catch (e) { console.error("[Main] Error in formatIndicatorValues:", e, indicatorValues); return '<div class="mt-1 text-xs" style="color: #dc2626;">(æŒ‡æ¨™å€¼æ ¼å¼éŒ¯èª¤)</div>'; } }; const formatKDParams = (kdVals) => { try { if (!kdVals || typeof kdVals !== 'object') { console.warn("[Main] Invalid kdValues passed to formatKDParams:", kdVals); return ''; } const formatV = (v) => checkDisplay(v) ? v.toFixed(2) : '--'; const kPrev = kdVals?.kPrev; const dPrev = kdVals?.dPrev; const kNow = kdVals?.kNow; const dNow = kdVals?.dNow; const kNext = kdVals?.kNext; const dNext = kdVals?.dNext; return `<div class="mt-1 text-xs" style="color: var(--muted-foreground);"> (K/D å‰:${formatV(kPrev)}/${formatV(dPrev)},ç•¶:${formatV(kNow)}/${formatV(dNow)}, æ¬¡:${formatV(kNext)}/${formatV(dNext)})</div>`; } catch (e) { console.error("[Main] Error in formatKDParams:", e, kdVals); return '<div class="mt-1 text-xs" style="color: #dc2626;">(KDå€¼æ ¼å¼éŒ¯èª¤)</div>'; } }; const formatMACDParams = (macdValues) => { try { if (!macdValues || typeof macdValues !== 'object') { console.warn("[Main] Invalid macdValues passed to formatMACDParams:", macdValues); return ''; } const formatV = (v) => checkDisplay(v) ? v.toFixed(2) : '--'; const difPrev = macdValues?.difPrev; const deaPrev = macdValues?.deaPrev; const difNow = macdValues?.difNow; const deaNow = macdValues?.deaNow; const difNext = macdValues?.difNext; const deaNext = macdValues?.deaNext; return `<div class="mt-1 text-xs" style="color: var(--muted-foreground);"> (DIF/DEA å‰:${formatV(difPrev)}/${formatV(deaPrev)},ç•¶:${formatV(difNow)}/${formatV(deaNow)}, æ¬¡:${formatV(difNext)}/${formatV(deaNext)})</div>`; } catch (e) { console.error("[Main] Error in formatMACDParams:", e, macdValues); return '<div class="mt-1 text-xs" style="color: #dc2626;">(MACDå€¼æ ¼å¼éŒ¯èª¤)</div>'; } }; function displayTradeResults(result) { console.log("[Main] displayTradeResults called"); const tradeResultsEl = document.getElementById("trade-results"); if (!tradeResultsEl) { console.error("[Main] Element 'trade-results' not found"); return; } const tradeTiming = result?.tradeTiming; if (!result || !result.completedTrades || !Array.isArray(result.completedTrades)) { tradeResultsEl.innerHTML = `<p class="text-xs text-muted-foreground text-center py-8" style="color: var(--muted-foreground);">äº¤æ˜“è¨˜éŒ„æ•¸æ“šç„¡æ•ˆæˆ–ç¼ºå¤±</p>`; console.error("[Main] Invalid completedTrades data:", result); return; } if (result.completedTrades.length === 0) { tradeResultsEl.innerHTML = `<p class="text-xs text-muted-foreground text-center py-8" style="color: var(--muted-foreground);">æ²’æœ‰äº¤æ˜“è¨˜éŒ„</p>`; return; } try { let tradeHtml = result.completedTrades.map((tradePair, index) => { if (!tradePair || !tradePair.entry || !tradePair.exit || !tradePair.entry.type || !tradePair.exit.type) { console.warn(`[Main] Invalid trade pair structure at index ${index}:`, tradePair); return `<div class="trade-signal p-3 border-b last:border-b-0" style="border-color: var(--border);"><p class="text-xs text-red-600">éŒ¯èª¤ï¼šæ­¤ç­†äº¤æ˜“å°æ•¸æ“šçµæ§‹ä¸å®Œæ•´ (Index: ${index})</p></div>`; } try { const entryTrade = tradePair.entry; const exitTrade = tradePair.exit; const profit = tradePair.profit; const profitPercent = tradePair.profitPercent; const isShortTrade = entryTrade.type === 'short'; let entryParamsDisplay = ''; try { if (entryTrade?.kdValues) entryParamsDisplay = formatKDParams(entryTrade.kdValues); else if (entryTrade?.macdValues) entryParamsDisplay = formatMACDParams(entryTrade.macdValues); else if (entryTrade?.indicatorValues) entryParamsDisplay = formatIndicatorValues(entryTrade.indicatorValues); } catch (entryFormatError) { console.error(`[Main] Error formatting entry display for trade index ${index}:`, entryFormatError, entryTrade); entryParamsDisplay = '<span class="block text-xs text-red-500 mt-1">(é€²å ´ä¿¡æ¯æ ¼å¼éŒ¯èª¤)</span>'; } let exitParamsDisplay = ''; const sl = exitTrade?.triggeredByStopLoss || false; const tp = exitTrade?.triggeredByTakeProfit || false; let trigger = ''; if(sl) trigger='<span class="ml-2 text-xs font-medium px-2 py-0.5 rounded" style="background-color: #fee2e2; color: #dc2626;">ğŸ›‘åœæ</span>'; else if(tp) trigger='<span class="ml-2 text-xs font-medium px-2 py-0.5 rounded" style="background-color: #dcfce7; color: #16a34a;">âœ…åœåˆ©</span>'; try { if (exitTrade?.kdValues) exitParamsDisplay = formatKDParams(exitTrade.kdValues); else if (exitTrade?.macdValues) exitParamsDisplay = formatMACDParams(exitTrade.macdValues); else if (exitTrade?.indicatorValues) exitParamsDisplay = formatIndicatorValues(exitTrade.indicatorValues); } catch (exitFormatError) { console.error(`[Main] Error formatting exit display for trade index ${index}:`, exitFormatError, exitTrade); exitParamsDisplay = '<span class="block text-xs text-red-500 mt-1">(å‡ºå ´ä¿¡æ¯æ ¼å¼éŒ¯èª¤)</span>'; } const entryDate = entryTrade.date || 'N/A'; const entryPrice = typeof entryTrade.price === 'number' ? entryTrade.price.toFixed(2) : 'N/A'; const entryShares = entryTrade.shares || 'N/A'; const entryActionText = isShortTrade ? 'åšç©º' : 'è²·å…¥'; const entryActionClass = isShortTrade ? 'short-signal' : 'buy-signal'; const entryActionStyle = isShortTrade ? 'background-color: #fef3c7; color: #d97706;' : 'background-color: #fee2e2; color: #dc2626;'; const exitDate = exitTrade.date || 'N/A'; const exitPrice = typeof exitTrade.price === 'number' ? exitTrade.price.toFixed(2) : 'N/A'; const exitActionText = isShortTrade ? 'å›è£œ' : 'è³£å‡º'; const exitActionClass = isShortTrade ? 'cover-signal' : 'sell-signal'; const exitActionStyle = isShortTrade ? 'background-color: #e0e7ff; color: #7c3aed;' : 'background-color: #dcfce7; color: #16a34a;'; const profitValue = typeof profit === 'number' ? Math.round(profit) : 'N/A'; const profitColor = typeof profit === 'number' ? (profit >= 0 ? '#16a34a' : '#dc2626') : 'var(--foreground)'; const profitSign = typeof profit === 'number' ? (profit >= 0 ? '+' : '') : ''; return ` <div class="trade-signal py-3 px-4 border-b last:border-b-0 hover:bg-opacity-50 transition duration-150" style="border-color: var(--border); background-color: var(--background);" onmouseover="this.style.backgroundColor='var(--muted)'" onmouseout="this.style.backgroundColor='var(--background)'"> <div class="mb-2"> <div class="flex justify-between items-center flex-wrap gap-2"> <div class="flex items-center gap-2"> <span class="text-xs" style="color: var(--muted-foreground);">${entryDate}</span> <span class="trade-action text-xs font-medium px-2 py-1 rounded ${entryActionClass}" style="${entryActionStyle}">${entryActionText}</span> <span class="text-sm font-semibold" style="color: var(--foreground);">${entryPrice}</span> <span class="text-xs" style="color: var(--muted-foreground);">${entryShares} è‚¡</span> </div> </div> ${entryParamsDisplay} </div> <div> <div class="flex justify-between items-center flex-wrap gap-2"> <div class="flex items-center gap-2"> <span class="text-xs" style="color: var(--muted-foreground);">${exitDate}</span> <span class="trade-action text-xs font-medium px-2 py-1 rounded ${exitActionClass}" style="${exitActionStyle}">${exitActionText}</span> <span class="text-sm font-semibold" style="color: var(--foreground);">${exitPrice}</span> </div> <div class="flex items-center"> <span class="text-sm font-bold" style="color: ${profitColor};">${profitSign}${profitValue}å…ƒ</span> ${trigger} </div> </div> ${exitParamsDisplay} </div> </div> `; } catch (mapError) { console.error(`[Main] Error formatting trade pair at index ${index}:`, mapError); console.error("[Main] Problematic trade pair object:", tradePair); return `<div class="trade-signal p-3 border-b" style="border-color: var(--border);"><p class="text-xs text-red-600">éŒ¯èª¤ï¼šæ ¼å¼åŒ–æ­¤ç­†äº¤æ˜“å°æ™‚å‡ºéŒ¯ (Index: ${index})</p></div>`; } }).join(''); tradeResultsEl.innerHTML = `<div class="trade-list rounded-md max-h-80 overflow-y-auto" style="border: 1px solid var(--border);">${tradeHtml}</div>`; } catch (error) { console.error("[Main] Error rendering trade results list:", error); tradeResultsEl.innerHTML = `<p class="text-xs text-red-600 text-center py-8">é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</p>`; showError("é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„æ™‚å‡ºéŒ¯ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°ã€‚"); } } function renderChart(result) { const chartContainer = document.getElementById('chart-container'); if (!chartContainer) { console.error("[Main] Chart container not found"); return; } if (!result || !result.dates || result.dates.length === 0) { chartContainer.innerHTML = `<div class="text-center text-muted py-8" style="color: var(--muted-foreground);"><i data-lucide="bar-chart-3" class="lucide w-12 h-12 mx-auto mb-2 opacity-50"></i><p>ç„¡æ³•æ¸²æŸ“åœ–è¡¨ï¼šæ•¸æ“šä¸è¶³ã€‚</p></div>`; if (typeof lucide !== 'undefined' && lucide.createIcons) { lucide.createIcons(); } return; } chartContainer.innerHTML = '<canvas id="chart" class="w-full h-full absolute inset-0"></canvas>'; const chartElement = document.getElementById('chart'); if (!chartElement) { console.error("[Main] Failed to create chart canvas element"); return; } const ctx = chartElement.getContext('2d'); if (stockChart) { stockChart.destroy(); stockChart = null; } const dates = result.dates; const check = (v) => v !== null && !isNaN(v) && isFinite(v); const validReturns = result.strategyReturns.map((v, i) => ({ index: i, value: check(v) ? parseFloat(v) : null })).filter(item => item.value !== null); if (validReturns.length === 0) { console.warn("[Main] No valid strategy return data points to render chart."); return; } const firstValidReturnIndex = validReturns[0].index; const lastValidReturnIndex = validReturns[validReturns.length - 1].index; const filterSignals = (signals) => { return (signals || []).filter(s => s.index >= firstValidReturnIndex && s.index <= lastValidReturnIndex && check(result.strategyReturns[s.index])).map(s => ({ x: dates[s.index], y: result.strategyReturns[s.index] })); }; const buySigs = filterSignals(result.chartBuySignals); const sellSigs = filterSignals(result.chartSellSignals); const shortSigs = filterSignals(result.chartShortSignals); const coverSigs = filterSignals(result.chartCoverSignals); const stratData = result.strategyReturns.map(v => check(v) ? parseFloat(v) : null); const bhData = result.buyHoldReturns.map(v => check(v) ? parseFloat(v) : null); const datasets = [ { label: 'è²·å…¥ä¸¦æŒæœ‰ %', data: bhData, borderColor: '#6b7280', borderWidth: 1.5, tension: 0.1, pointRadius: 0, yAxisID: 'y', spanGaps: true }, { label: 'ç­–ç•¥ %', data: stratData, borderColor: '#3b82f6', borderWidth: 2, tension: 0.1, pointRadius: 0, yAxisID: 'y', spanGaps: true } ]; if (buySigs.length > 0) { datasets.push({ type:'scatter', label:'è²·å…¥', data:buySigs, backgroundColor:'#ef4444', radius:6, pointStyle:'triangle', rotation:0, yAxisID:'y' }); } if (sellSigs.length > 0) { datasets.push({ type:'scatter', label:'è³£å‡º', data:sellSigs, backgroundColor:'#22c55e', radius:6, pointStyle:'triangle', rotation:180, yAxisID:'y' }); } if (result.enableShorting) { if (shortSigs.length > 0) { datasets.push({ type:'scatter', label:'åšç©º', data:shortSigs, backgroundColor:'#f59e0b', radius:7, pointStyle:'rectRot', yAxisID:'y' }); } if (coverSigs.length > 0) { datasets.push({ type:'scatter', label:'å›è£œ', data:coverSigs, backgroundColor:'#8b5cf6', radius:7, pointStyle:'rect', yAxisID:'y' }); } } console.log('Creating chart with plugins:', Chart.registry.plugins.items); stockChart = new Chart(ctx, { type: 'line', data: { labels: dates, datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, onHover: (event, activeElements) => { event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'grab'; }, interaction: { mode: 'index', intersect: false, }, plugins: { legend: { position: 'top', labels: { usePointStyle: true } }, tooltip: { mode: 'index', intersect: false, }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } } }, scales: { y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'æ”¶ç›Šç‡ (%)' }, ticks: { callback: v => v + '%' }, grid: { color: '#e5e7eb' } }, x: { type: 'category', grid: { display: false }, ticks: { autoSkip: true, maxTicksLimit: 15, maxRotation: 40, minRotation: 0 } } } }); const canvas = stockChart.canvas; let isPanning = false; let lastX = 0; canvas.addEventListener('mousedown', (e) => { if (e.button === 0 || e.button === 2) { isPanning = true; lastX = e.clientX; canvas.style.cursor = 'grabbing'; e.preventDefault(); } }); canvas.addEventListener('mousemove', (e) => { if (isPanning) { const deltaX = e.clientX - lastX; const scale = stockChart.scales.x; const canvasPosition = Chart.helpers.getRelativePosition(e, stockChart); const dataX = scale.getValueForPixel(canvasPosition.x); const range = scale.max - scale.min; const panAmount = (deltaX / canvas.width) * range; stockChart.zoomScale('x', {min: scale.min - panAmount, max: scale.max - panAmount}, 'none'); lastX = e.clientX; e.preventDefault(); } }); canvas.addEventListener('mouseup', (e) => { isPanning = false; canvas.style.cursor = 'grab'; }); canvas.addEventListener('mouseleave', (e) => { isPanning = false; canvas.style.cursor = 'default'; }); canvas.addEventListener('contextmenu', (e) => { e.preventDefault(); }); } // å„ªåŒ–å°ˆç”¨é€²åº¦é¡¯ç¤ºå‡½æ•¸ function showOptimizationProgress(message) { console.log('[Main] showOptimizationProgress è¢«èª¿ç”¨:', message); const progressSection = document.getElementById('optimization-progress-section'); const statusText = document.getElementById('optimization-status-text'); const progressBar = document.getElementById('optimization-progress-bar'); const progressText = document.getElementById('optimization-progress-text'); console.log('[Main] é€²åº¦å…ƒç´ æª¢æŸ¥:', { progressSection: !!progressSection, statusText: !!statusText, progressBar: !!progressBar, progressText: !!progressText }); if (progressSection && statusText) { progressSection.classList.remove('hidden'); statusText.textContent = message || 'âŒ› å„ªåŒ–é€²è¡Œä¸­...'; if (progressBar) progressBar.style.width = '0%'; if (progressText) progressText.textContent = '0%'; console.log('[Main] é¡¯ç¤ºå„ªåŒ–é€²åº¦:', message); console.log('[Main] é€²åº¦å€åŸŸ class list:', progressSection.classList.toString()); } else { console.error('[Main] ç„¡æ³•æ‰¾åˆ°å„ªåŒ–é€²åº¦é¡¯ç¤ºå…ƒç´ !'); } } function updateOptimizationProgress(progress, message) { const progressBar = document.getElementById('optimization-progress-bar'); const progressText = document.getElementById('optimization-progress-text'); const statusText = document.getElementById('optimization-status-text'); const safeProgress = Math.max(0, Math.min(100, progress || 0)); if (progressBar) { progressBar.style.width = `${safeProgress}%`; } if (progressText) { progressText.textContent = `${Math.round(safeProgress)}%`; } if (statusText && message) { statusText.textContent = message; } console.log(`[Main] æ›´æ–°å„ªåŒ–é€²åº¦: ${safeProgress}%`, message); } function hideOptimizationProgress() { console.log('[Main] hideOptimizationProgress è¢«èª¿ç”¨'); const progressSection = document.getElementById('optimization-progress-section'); if (progressSection) { progressSection.classList.add('hidden'); console.log('[Main] éš±è—å„ªåŒ–é€²åº¦é¡¯ç¤º'); console.log('[Main] é€²åº¦å€åŸŸ class list:', progressSection.classList.toString()); } else { console.error('[Main] æ‰¾ä¸åˆ° optimization-progress-section å…ƒç´ '); } } function runOptimizationInternal(optimizeType) { if (!workerUrl) { showError(