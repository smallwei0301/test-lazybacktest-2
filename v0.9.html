<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票收益紀錄 (專業版 V0.9)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .card { background-color: #1f2937; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .form-input { background-color: #374151; border: 1px solid #4b5563; color: #f3f4f6; border-radius: 0.5rem; padding: 0.75rem 1rem; width: 100%; }
        /* 移除type=number時的箭頭 */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          appearance: none;
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
          appearance: textfield;
        }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #6b7280; }
        .loader { border: 4px solid #4b5563; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .details-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        #toast-notification {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            transition: top 0.5s ease-in-out;
            z-index: 100;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen">
    <!-- 訊息提示框 -->
    <div id="toast-notification" class="p-4 rounded-lg shadow-lg text-white">
        <span id="toast-message"></span>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-white mb-2">股票收益紀錄 V0.9</h1>
            <p class="text-gray-400">自動追蹤您的台股投資組合表現</p>
        </header>

        <!-- 新增股票表單 -->
        <div class="card mb-8">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold text-white">新增股票紀錄</h2>
                 <div>
                    <label for="imageUpload" class="btn btn-secondary cursor-pointer">
                        <i data-lucide="image-plus" class="mr-2 h-5 w-5"></i>
                        <span id="imageUploadText">圖片輸入</span>
                        <div id="imageUploadLoader" class="loader h-5 w-5 ml-2 hidden"></div>
                    </label>
                    <input type="file" id="imageUpload" class="hidden" accept="image/*">
                 </div>
            </div>
            <form id="addStockForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                 <div><label for="stockId" class="block text-sm font-medium text-gray-400 mb-2">股票代碼</label><input type="text" id="stockId" class="form-input" placeholder="例如: 2330" required></div>
                 <div><label for="purchaseDate" class="block text-sm font-medium text-gray-400 mb-2">購買日期</label><input type="date" id="purchaseDate" class="form-input" required></div>
                 <div><label for="purchaseShares" class="block text-sm font-medium text-gray-400 mb-2">購買張數</label><input type="number" id="purchaseShares" class="form-input" min="0.001" step="0.001" placeholder="1張 = 1000股" required></div>
                 <div><label for="purchasePrice" class="block text-sm font-medium text-gray-400 mb-2">購買成本 (每股)</label><input type="number" id="purchasePrice" class="form-input" min="0" step="0.01" placeholder="例如: 688.5" required></div>
                 <button type="submit" class="btn btn-primary w-full lg:w-auto"><i data-lucide="plus-circle" class="mr-2 h-5 w-5"></i><span>新增紀錄</span></button>
            </form>
        </div>

        <div id="portfolio" class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">我的投資組合</h2>
                <div class="flex gap-2">
                    <button id="toggleCompactMode" class="btn btn-secondary py-1 px-3 text-sm">
                        <i data-lucide="list" class="mr-2 h-4 w-4"></i>
                        <span>精簡模式</span>
                    </button>
                    <button id="deleteAllBtn" class="btn btn-secondary py-1 px-3 text-sm">
                        <i data-lucide="trash-2" class="mr-2 h-4 w-4"></i>
                        <span>刪除全部</span>
                    </button>
                </div>
            </div>
            <div id="stockList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            <div id="stockListCompact" class="hidden flex flex-wrap gap-2"></div>
        </div>
        
        <div id="history" class="mb-8 hidden">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">歷史紀錄</h2>
                <button id="toggleHistoryCompactMode" class="btn btn-secondary py-1 px-3 text-sm">
                    <i data-lucide="list" class="mr-2 h-4 w-4"></i>
                    <span>精簡模式</span>
                </button>
            </div>
            <div id="historyList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            <div id="historyListCompact" class="hidden flex flex-wrap gap-2"></div>
        </div>

        <div id="summary" class="card mb-8">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                <h2 class="text-2xl font-bold text-white">年度總覽</h2>
                <div class="flex items-center gap-2">
                     <label for="fiscalYearStart" class="text-sm text-gray-400 whitespace-nowrap">統計起始月份:</label>
                    <select id="fiscalYearStart" class="form-input text-sm py-2">
                        <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
                        <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
                        <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
                        <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
                    </select>
                </div>
            </div>
            <div id="summaryTableContainer" class="overflow-x-auto"></div>
        </div>

        <div id="financialPlanning" class="card mb-8">
            <h2 class="text-2xl font-bold text-white mb-4">財務規劃</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 items-end mb-6">
                <div><label for="initialAge" class="block text-sm font-medium text-gray-400 mb-2">初始年齡</label><input type="number" id="initialAge" class="form-input" placeholder="30"></div>
                <div><label for="initialInvestmentYear" class="block text-sm font-medium text-gray-400 mb-2">開始年份 (X)</label><input type="number" id="initialInvestmentYear" class="form-input" placeholder="2024" oninput="this.value=this.value.slice(0,4)"></div>
                <div><label for="planningEndYear" class="block text-sm font-medium text-gray-400 mb-2">結束年份 (N)</label><input type="number" id="planningEndYear" class="form-input" placeholder="2044" oninput="this.value=this.value.slice(0,4)"></div>
                <div><label for="initialInvestmentAmount" class="block text-sm font-medium text-gray-400 mb-2">初始金額 (B)</label><input type="number" id="initialInvestmentAmount" class="form-input" placeholder="1000000"></div>
                <div><label for="annualIncreaseAmount" class="block text-sm font-medium text-gray-400 mb-2">每年加碼 (C)</label><input type="number" id="annualIncreaseAmount" class="form-input" placeholder="120000"></div>
                <div><label for="expectedReturnRate" class="block text-sm font-medium text-gray-400 mb-2">報酬率 (A%)</label><input type="number" id="expectedReturnRate" class="form-input" placeholder="8"></div>
            </div>
            <div class="flex items-center mb-4">
                <input type="checkbox" id="hideZeroGainRows" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                <label for="hideZeroGainRows" class="ml-2 text-sm text-gray-300">隱藏「已實現總獲益」為 0 的列</label>
            </div>
            <button id="generatePlanBtn" class="btn btn-primary w-full md:w-auto mb-6"><i data-lucide="calculator" class="mr-2 h-5 w-5"></i>計算並同步目標</button>
            <div id="financialPlanResult" class="overflow-x-auto"></div>
        </div>
    </div>
    
    <div id="addDividendModal" class="modal-backdrop hidden">
        <div class="card w-full max-w-md">
            <h2 class="text-xl font-semibold text-white mb-4">手動新增股利</h2>
            <form id="addDividendForm">
                <input type="hidden" id="modalStockId">
                <div class="mb-4"><label for="modalDividendExDate" class="block text-sm font-medium text-gray-400 mb-2">除息日</label><input type="date" id="modalDividendExDate" class="form-input" required></div>
                <div class="mb-6"><label for="modalDividendAmount" class="block text-sm font-medium text-gray-400 mb-2">現金股利 (每股)</label><input type="number" step="0.0001" id="modalDividendAmount" class="form-input" required></div>
                <div class="flex justify-end gap-4"><button type="button" id="cancelAddDividend" class="btn btn-secondary">取消</button><button type="submit" class="btn btn-primary">確認新增</button></div>
            </form>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal-backdrop hidden">
        <div class="card w-full max-w-md">
            <h2 class="text-xl font-semibold text-white mb-2">確認刪除</h2>
            <p class="text-gray-400 mb-6">您確定要刪除所有股票紀錄嗎？此操作無法復原。</p>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancelDeleteAll" class="btn btn-secondary">取消</button>
                <button type="button" id="confirmDeleteAllBtn" class="btn btn-danger">確認刪除</button>
            </div>
        </div>
    </div>


    <script>
        lucide.createIcons();

        const BUY_FEE_RATE = 0.001425;
        const DEFAULT_SELL_FEE_STOCK = 0.001425 + 0.003;
        const DEFAULT_SELL_FEE_ETF = 0.001425 + 0.001;

        let portfolio = [];
        let sales = {};
        let feeSettings = {};
        let settings = { fiscalYearStart: 1, manualOverrides: {}, targetProfits: {}, isCompactMode: false, isHistoryCompactMode: false, financialPlan: {}, hideZeroGainRows: false };
        
        // 全域變數，用於在不同渲染函數間傳遞數據
        let allMetricsForSummary_global = [];
        let allSalesHistoryForSummary_global = [];
        let stockDataMap_global = {};

        const addStockForm = document.getElementById('addStockForm');
        const stockListContainer = document.getElementById('stockList');
        const stockListCompactContainer = document.getElementById('stockListCompact');
        const historyContainer = document.getElementById('history');
        const historyListContainer = document.getElementById('historyList');
        const historyListCompactContainer = document.getElementById('historyListCompact');
        const summaryContainer = document.getElementById('summaryTableContainer');
        const fiscalYearStartSelect = document.getElementById('fiscalYearStart');
        const addDividendModal = document.getElementById('addDividendModal');
        const addDividendForm = document.getElementById('addDividendForm');
        const cancelAddDividendBtn = document.getElementById('cancelAddDividend');
        const imageUploadInput = document.getElementById('imageUpload');
        const imageUploadText = document.getElementById('imageUploadText');
        const imageUploadLoader = document.getElementById('imageUploadLoader');
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        const toggleCompactModeBtn = document.getElementById('toggleCompactMode');
        const toggleHistoryCompactModeBtn = document.getElementById('toggleHistoryCompactMode');
        const generatePlanBtn = document.getElementById('generatePlanBtn');
        const financialPlanResultContainer = document.getElementById('financialPlanResult');
        const deleteAllBtn = document.getElementById('deleteAllBtn');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const cancelDeleteAllBtn = document.getElementById('cancelDeleteAll');
        const confirmDeleteAllBtn = document.getElementById('confirmDeleteAllBtn');
        const hideZeroGainRowsCheckbox = document.getElementById('hideZeroGainRows');

        function sanitizeForId(text) { if (!text) return ''; return text.replace(/[^\w\u4e00-\u9fa5-]/g, '_'); }

        async function fetchStockData(stockId, purchaseDateStr) {
            // 備註：此函數負責獲取股票數據。它會依序嘗試不同的API來源。
            // 優先級 1: 台灣證交所 MIS API (即時數據)
            // 優先級 2: Yahoo Finance Chart API (最近5日歷史數據，可從中找到昨日收盤價)
            // 優先級 3: 台灣證交所每日收盤行情 (昨日收盤價)
            // 優先級 4: FinMind API (昨日收盤價)
            if (stockId.includes('(需手動更正)')) {
                return { price: null, priceDate: 'N/A', stockName: stockId.replace('(需手動更正)', ''), priceStatus: 'failed', dividends: [], dividendStatus: 'failed' };
            }
            let price = null, priceDate = null, stockName = null, priceStatus = 'ok';
            let dividends = [], dividendStatus = 'ok';
            const proxyUrl = `https://corsproxy.io/?`;
            let tickerSuffix = '.TW';
            if (stockId.toUpperCase().endsWith('B')) { tickerSuffix = '.TWO'; } else if (stockId.length === 4 && !stockId.startsWith('00')) { const otcPrefixes = ['3', '4', '5', '6', '8']; if (otcPrefixes.includes(stockId[0])) { tickerSuffix = '.TWO'; } }
            const yahooTicker = `${stockId}${tickerSuffix}`;
            
            // 來源 1: 台灣證交所 MIS API (即時數據)
            try {
                const tseUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=tse_${stockId}.tw`;
                const otcUrl = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=otc_${stockId}.tw`;
                const parseTwseData = (data) => { if (data.msgArray && data.msgArray.length > 0) { const info = data.msgArray[0]; if (info.n) { stockName = info.n; } const rawDate = info.d; if (rawDate && rawDate.length === 8) { const formattedDateStr = `${rawDate.substring(0, 4)}-${rawDate.substring(4, 6)}-${rawDate.substring(6, 8)}`; priceDate = new Date(formattedDateStr).toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'}); } else { priceDate = 'N/A'; } const currentPrice = parseFloat(info.z); if (!isNaN(currentPrice) && currentPrice > 0) { price = currentPrice; return true; } } return false; };
                let response = await fetch(`${proxyUrl}${encodeURIComponent(tseUrl)}`);
                let data = await response.json();
                if (!parseTwseData(data)) { response = await fetch(`${proxyUrl}${encodeURIComponent(otcUrl)}`); data = await response.json(); parseTwseData(data); }
                if (price === null) { priceStatus = 'nodata'; }
            } catch (e) { console.error(`來源1 (MIS) 獲取 ${stockId} 失敗:`, e); priceStatus = 'failed'; }
            
            // 來源 2: Yahoo Finance (最近5日歷史數據)
            if (priceStatus !== 'ok') {
                try {
                    const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooTicker}?range=5d&interval=1d`;
                    const response = await fetch(`${proxyUrl}${encodeURIComponent(yahooUrl)}`);
                    const data = await response.json();
                    if (data.chart.result && data.chart.result[0]) { const result = data.chart.result[0]; const closePrices = result.indicators.quote[0].close; const timestamps = result.timestamp; for (let i = timestamps.length - 1; i >= 0; i--) { if (closePrices[i] !== null && timestamps[i] !== null) { price = closePrices[i]; const date = new Date(timestamps[i] * 1000); priceDate = date.toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }); priceStatus = 'historical'; if (!stockName) { stockName = result.meta.shortName || result.meta.symbol; } break; } } }
                    if (price === null) { priceStatus = 'failed'; }
                } catch (e) { console.error(`來源2 (Yahoo) 獲取 ${stockId} 失敗:`, e); priceStatus = 'failed'; }
            }
            
            // 來源 3: 台灣證交所每日收盤行情
            if (priceStatus === 'failed' || priceStatus === 'nodata') {
                 try {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const y_str = yesterday.getFullYear();
                    const m_str = String(yesterday.getMonth() + 1).padStart(2, '0');
                    const d_str = String(yesterday.getDate()).padStart(2, '0');
                    const dateStr = `${y_str}${m_str}${d_str}`;
                    const twseDailyUrl = `https://www.twse.com.tw/exchangeReport/MI_INDEX?response=json&date=${dateStr}&type=ALLBUT0999`;
                    const response = await fetch(`${proxyUrl}${encodeURIComponent(twseDailyUrl)}`);
                    const data = await response.json();
                    if (data.stat === 'OK' && data.data9) {
                        const stockInfo = data.data9.find(item => item[0].trim() === stockId);
                        if (stockInfo) {
                            const closePrice = parseFloat(stockInfo[8].replace(/,/g, ''));
                            if (!isNaN(closePrice) && closePrice > 0) {
                                price = closePrice;
                                priceDate = `${m_str}/${d_str}`;
                                priceStatus = 'historical';
                                if (!stockName) stockName = stockInfo[1].trim();
                            }
                        }
                    }
                 } catch (e) { console.error(`來源3 (TWSE Daily) 獲取 ${stockId} 失敗:`, e); }
            }

            // 來源 4: FinMind API
            if (priceStatus === 'failed' || priceStatus === 'nodata') {
                 try {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const dateStr = yesterday.toISOString().split('T')[0];
                    const finmindUrl = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${stockId}&start_date=${dateStr}&end_date=${dateStr}`;
                    const response = await fetch(finmindUrl);
                    const data = await response.json();
                    if (data.data && data.data.length > 0 && data.data[0].close) {
                        price = data.data[0].close;
                        priceDate = new Date(data.data[0].date).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });
                        priceStatus = 'historical';
                    }
                 } catch (e) { console.error(`來源4 (Finmind) 獲取 ${stockId} 失敗:`, e); }
            }

            // 股利資訊獲取 (維持原狀)
            try {
                const startDate = new Date(purchaseDateStr);
                startDate.setDate(startDate.getDate());
                const period1 = Math.floor(startDate.getTime() / 1000);
                const period2 = Math.floor(new Date().getTime() / 1000);
                const yahooDivUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooTicker}?period1=${period1}&period2=${period2}&interval=1d&events=div`;
                const response = await fetch(`${proxyUrl}${encodeURIComponent(yahooDivUrl)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.chart.result && data.chart.result[0] && data.chart.result[0].events && data.chart.result[0].events.dividends) {
                        const dividendEvents = data.chart.result[0].events.dividends;
                        dividends = Object.values(dividendEvents).map(event => ({
                            date: new Date(event.date * 1000).toISOString().split('T')[0],
                            dividend: event.amount
                        }));
                        dividendStatus = 'ok';
                    } else { dividendStatus = 'nodata'; }
                } else { console.warn(`Yahoo Dividend API for ${stockId} returned status: ${response.status}`); dividendStatus = 'failed'; }
            } catch (e) { console.error(`無法從 Yahoo Finance 獲取 ${stockId} 的配息歷史:`, e); dividendStatus = 'failed'; }

            if (price === null) priceStatus = 'failed';
            return { price, priceDate, stockName, priceStatus, dividends, dividendStatus };
        }
        
        function calculateStockMetrics(stock, currentPrice, finalDividends) { const stockData = { ...stock }; const totalShares = stockData.shares * 1000; stockData.totalCost = (stockData.price * totalShares) * (1 + BUY_FEE_RATE); stockData.dividends = finalDividends.filter(d => new Date(d.date) >= new Date(stockData.date)); stockData.cumulativeDividend = stockData.dividends.reduce((acc, curr) => acc + (curr.dividend * totalShares), 0); stockData.avgHoldingCost = totalShares > 0 ? (stockData.totalCost - stockData.cumulativeDividend) / totalShares : 0; stockData.currentValue = currentPrice * totalShares; stockData.returnAmount = (stockData.currentValue + stockData.cumulativeDividend) - stockData.totalCost; stockData.returnRate = stockData.totalCost > 0 ? (stockData.returnAmount / stockData.totalCost) * 100 : 0; const oneYearAgo = new Date(new Date().setFullYear(new Date().getFullYear() - 1)); const lastYearTotalDividendPerShare = finalDividends.filter(d => new Date(d.date) > oneYearAgo).reduce((sum, d) => sum + d.dividend, 0); stockData.projectedAnnualDividend = lastYearTotalDividendPerShare * totalShares; return stockData; }
        function calculateGroupMetrics(transactions, stockId) { const group = { id: stockId, totalShares: 0, totalCost: 0, cumulativeDividend: 0, currentValue: 0, projectedAnnualDividend: 0, returnAmount: 0, returnRate: 0, avgHoldingCost: 0, dividends: [] }; const allDividends = []; transactions.forEach(tx => { group.totalShares += tx.shares; group.totalCost += tx.totalCost; group.cumulativeDividend += tx.cumulativeDividend; group.currentValue += tx.currentValue; group.projectedAnnualDividend += tx.projectedAnnualDividend; allDividends.push(...tx.dividends); }); group.dividends = Array.from(new Map(allDividends.map(d => [d.originalDate, d])).values()).sort((a,b) => new Date(b.date) - new Date(a.date)); if (settings.manualOverrides[stockId]?.projected !== undefined) { group.projectedAnnualDividend = settings.manualOverrides[stockId].projected; } const totalSharesInUnits = group.totalShares * 1000; group.avgHoldingCost = totalSharesInUnits > 0 ? (group.totalCost - group.cumulativeDividend) / totalSharesInUnits : 0; group.returnAmount = (group.currentValue + group.cumulativeDividend) - group.totalCost; group.returnRate = group.totalCost > 0 ? (group.returnAmount / group.totalCost) * 100 : 0; return group; }
        function processTransactions(stockId, originalPurchases, originalSales, finalDividends) { let totalRealizedPL = 0; let totalRealizedDividends = 0; const salesHistory = []; const sellFeeRate = getSellFeeRate(stockId); const sortedPurchases = [...originalPurchases].sort((a, b) => new Date(a.date) - new Date(b.date)); const sortedSales = originalSales ? [...originalSales].sort((a, b) => new Date(a.date) - new Date(b.date)) : []; let purchaseQueue = JSON.parse(JSON.stringify(sortedPurchases)); for (const sale of sortedSales) { let sharesToSell = sale.shares * 1000; const saleProceeds = sale.price * sharesToSell; let costOfSoldShares = 0; while (sharesToSell > 0 && purchaseQueue.length > 0) { const currentPurchaseLot = purchaseQueue[0]; const sharesAvailableInLot = currentPurchaseLot.shares * 1000; const sharesToTakeFromLot = Math.min(sharesToSell, sharesAvailableInLot); const purchaseDate = new Date(currentPurchaseLot.date); const saleDate = new Date(sale.date); const relevantDividends = finalDividends.filter(d => { const exDivDate = new Date(d.date); return exDivDate >= purchaseDate && exDivDate < saleDate; }); totalRealizedDividends += relevantDividends.reduce((acc, curr) => acc + (curr.dividend * sharesToTakeFromLot), 0); const costPerShareInLot = currentPurchaseLot.price * (1 + BUY_FEE_RATE); costOfSoldShares += sharesToTakeFromLot * costPerShareInLot; currentPurchaseLot.shares = (sharesAvailableInLot - sharesToTakeFromLot) / 1000; sharesToSell -= sharesToTakeFromLot; if (currentPurchaseLot.shares <= 1e-9) { purchaseQueue.shift(); } } const saleFee = saleProceeds * sellFeeRate; const realizedPLForThisSale = saleProceeds - costOfSoldShares - saleFee; totalRealizedPL += realizedPLForThisSale; salesHistory.push({ ...sale, realizedPL: realizedPLForThisSale }); } return { realizedPL: totalRealizedPL, realizedDividends: totalRealizedDividends, remainingPurchases: purchaseQueue, salesHistory }; }
        function getSellFeeRate(stockId) { if (feeSettings[stockId]) { return feeSettings[stockId]; } return stockId.startsWith('00') ? DEFAULT_SELL_FEE_ETF : DEFAULT_SELL_FEE_STOCK; }
        function groupTransactionsIntoCycles(allPurchases, allSales) { const cycles = []; const purchasesById = allPurchases.reduce((acc, p) => { if (!acc[p.id]) acc[p.id] = []; acc[p.id].push(p); return acc; }, {}); for (const stockId in purchasesById) { const stockPurchases = purchasesById[stockId].map(p => ({ ...p, type: 'purchase' })); const stockSales = (allSales[stockId] || []).map(s => ({ ...s, type: 'sale' })); const allTransactions = [...stockPurchases, ...stockSales].sort((a, b) => new Date(a.date) - new Date(b.date)); let activePurchases = []; let activeSales = []; let currentShares = 0; for (const tx of allTransactions) { if (tx.type === 'purchase') { activePurchases.push(tx); currentShares += tx.shares; } else { activeSales.push(tx); currentShares -= tx.shares; if (currentShares < 1e-9) { cycles.push({ stockId: stockId, isHistorical: true, purchases: JSON.parse(JSON.stringify(activePurchases)), sales: JSON.parse(JSON.stringify(activeSales)), cycleId: `${stockId}-${tx.date}` }); activePurchases = []; activeSales = []; currentShares = 0; } } } if (activePurchases.length > 0) { cycles.push({ stockId: stockId, isHistorical: false, purchases: activePurchases, sales: activeSales, cycleId: `${stockId}-active` }); } } return cycles; }

        async function renderPortfolio() { stockListContainer.innerHTML = ''; stockListCompactContainer.innerHTML = ''; historyListContainer.innerHTML = ''; historyListCompactContainer.innerHTML = ''; if (portfolio.length === 0) { stockListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">尚未新增任何股票紀錄。</p>'; historyContainer.classList.add('hidden'); const summaryGains = renderSummary([], [], {}); renderFinancialPlan(summaryGains); return; } stockListContainer.style.display = settings.isCompactMode ? 'none' : 'grid'; stockListCompactContainer.style.display = settings.isCompactMode ? 'flex' : 'none'; historyListContainer.style.display = settings.isHistoryCompactMode ? 'none' : 'grid'; historyListCompactContainer.style.display = settings.isHistoryCompactMode ? 'flex' : 'none'; const transactionCycles = groupTransactionsIntoCycles(portfolio, sales); if (transactionCycles.length === 0) { stockListContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center py-8">處理交易紀錄時發生錯誤。</p>'; historyContainer.classList.add('hidden'); const summaryGains = renderSummary([], [], {}); renderFinancialPlan(summaryGains); return; } transactionCycles.forEach(cycle => { const card = document.createElement('div'); card.className = 'card'; card.innerHTML = `<div class="flex items-center justify-center h-48"><div class="loader"></div><p class="ml-4 text-gray-400">正在獲取 ${cycle.stockId} 數據...</p></div>`; const container = cycle.isHistorical ? historyListContainer : stockListContainer; container.appendChild(card); }); lucide.createIcons(); let allMetricsForSummary = []; let allSalesHistoryForSummary = []; let hasHistory = false; const uniqueStockIds = [...new Set(transactionCycles.map(c => c.stockId))]; const allStockDataPromises = uniqueStockIds.map(stockId => { const allPurchasesForId = portfolio.filter(p => p.id === stockId); const earliestPurchaseDate = allPurchasesForId.reduce((earliest, tx) => new Date(tx.date) < new Date(earliest) ? tx.date : earliest, allPurchasesForId[0].date); return fetchStockData(stockId, earliestPurchaseDate); }); const allStockDataResults = await Promise.all(allStockDataPromises); const stockDataMap = uniqueStockIds.reduce((map, id, index) => { map[id] = allStockDataResults[index]; return map; }, {}); allMetricsForSummary_global = allMetricsForSummary; allSalesHistoryForSummary_global = allSalesHistoryForSummary; stockDataMap_global = stockDataMap; stockListContainer.innerHTML = ''; historyListContainer.innerHTML = ''; for (const cycle of transactionCycles) { const { stockId, isHistorical, purchases: originalPurchases, sales: stockSales, cycleId } = cycle; const sanitizedCycleId = sanitizeForId(cycleId); const stockData = stockDataMap[stockId]; const manualDividends = originalPurchases.flatMap(p => p.manualDividends || []); const combinedDividends = [...stockData.dividends, ...manualDividends]; const uniqueDividends = Array.from(new Map(combinedDividends.map(d => [d.date, d])).values()); const stockOverrides = (settings.manualOverrides[stockId] && settings.manualOverrides[stockId].dividends) || {}; const finalDividends = uniqueDividends.map(div => { const override = stockOverrides[div.date]; if (override && override.deleted) return null; return { ...div, date: override?.newDate || div.date, dividend: override?.newAmount ?? div.dividend, isOverridden: !!override, originalDate: div.date } }).filter(Boolean); const originalTotalCost = originalPurchases.reduce((sum, tx) => sum + (tx.price * tx.shares * 1000 * (1 + BUY_FEE_RATE)), 0); const { realizedPL, realizedDividends, remainingPurchases, salesHistory } = processTransactions(stockId, originalPurchases, stockSales, finalDividends); allSalesHistoryForSummary.push(...salesHistory); const apiPriceFailed = stockData.price === null || isNaN(stockData.price); let priceForCalc, priceForDisplay, priceInfoForDisplay, priceClass = ''; if (apiPriceFailed) { const totalSharesInUnits = remainingPurchases.reduce((sum, tx) => sum + (tx.shares * 1000), 0); const totalOriginalCostOfRemaining = remainingPurchases.reduce((sum, tx) => sum + (tx.price * tx.shares * 1000), 0); const avgPurchasePrice = totalSharesInUnits > 0 ? totalOriginalCostOfRemaining / totalSharesInUnits : 0; priceForCalc = priceForDisplay = avgPurchasePrice; priceInfoForDisplay = '平均購入價'; priceClass = 'text-red-400'; } else { priceForCalc = priceForDisplay = stockData.price; priceInfoForDisplay = stockData.priceDate || 'N/A'; } const transactionMetrics = remainingPurchases.map(tx => calculateStockMetrics(tx, priceForCalc, finalDividends)); if (!isHistorical) { allMetricsForSummary.push(...transactionMetrics); } const groupMetrics = calculateGroupMetrics(transactionMetrics, stockId); const unrealizedDividends = groupMetrics.cumulativeDividend; const totalCumulativeDividend = realizedDividends + unrealizedDividends; const unrealizedPL = groupMetrics.returnAmount; const totalPL = realizedPL + unrealizedPL + realizedDividends; const overallReturnRate = originalTotalCost > 0 ? (totalPL / originalTotalCost) * 100 : 0; if(isHistorical) hasHistory = true; const dividendYield = groupMetrics.totalCost > 0 ? (groupMetrics.projectedAnnualDividend / groupMetrics.totalCost) * 100 : 0; const priceLineHTML = `<div class="flex justify-between items-center"><span class="text-gray-400">目前股價</span><div><span class="font-semibold ${priceClass}">${priceForDisplay.toFixed(2)}</span><span class="text-xs text-gray-400 ml-1 ${priceClass}">(${priceInfoForDisplay})</span></div></div>`; const isProjectedOverridden = settings.manualOverrides[stockId]?.projected !== undefined; const projectedDividendValue = `<span class="font-semibold ${isProjectedOverridden ? 'text-yellow-400' : 'text-blue-400'}" ${isProjectedOverridden ? 'title="手動設定值"' : ''}>${Math.round(groupMetrics.projectedAnnualDividend).toLocaleString()} ${!isHistorical ? `(${dividendYield.toFixed(2)}%)` : ''}</span>`; const projectedDividendHTML = stockData.dividendStatus !== 'ok' && !isProjectedOverridden ? `<span class="font-semibold text-sm text-yellow-500">股利資料載入失敗</span>` : projectedDividendValue; const resetProjectedBtnHTML = isProjectedOverridden ? `<button onclick="handleResetProjectedDividend('${stockId}')" class="ml-1 text-gray-500 hover:text-yellow-400" title="恢復為自動計算"><i data-lucide="rotate-ccw" class="h-4 w-4"></i></button>` : ''; const realizedPLColor = realizedPL >= 0 ? 'text-green-400' : 'text-red-400'; const realizedPLLineHTML = `<div class="flex justify-between"><span class="text-gray-400">已實現損益</span><span class="font-semibold ${realizedPLColor}">${realizedPL >= 0 ? '+' : ''}${Math.round(realizedPL).toLocaleString()}</span></div>`; const unrealizedPLColor = unrealizedPL >= 0 ? 'text-green-400' : 'text-red-400'; const unrealizedPLLineHTML = `<div class="flex justify-between"><span class="text-gray-400">含息未實現損益</span><span class="font-semibold ${unrealizedPLColor}">${unrealizedPL >= 0 ? '+' : ''}${Math.round(unrealizedPL).toLocaleString()}</span></div>`; const buyHistoryHTML = originalPurchases.map(tx => `<div><div id="buy-display-${tx.uuid}" class="flex justify-between items-center text-xs py-2 border-b border-gray-700 last:border-b-0"><div class="text-gray-400"><span>${tx.date}</span><span class="ml-2">${tx.shares} 張 @ ${tx.price}</span></div><div class="flex items-center gap-2"><button class="text-gray-500 hover:text-blue-400" onclick="showEditBuyForm('${tx.uuid}')"><i data-lucide="pencil" class="h-4 w-4"></i></button><button class="text-gray-500 hover:text-red-400" onclick="deleteStock('${tx.uuid}')"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div></div><div id="buy-edit-${tx.uuid}" class="hidden items-end gap-2 text-xs py-2 border-b border-gray-700 last:border-b-0"><input type="date" value="${tx.date}" id="input-buy-date-${tx.uuid}" class="form-input text-xs p-1 w-1/3"><input type="number" step="0.001" value="${tx.shares}" id="input-buy-shares-${tx.uuid}" class="form-input text-xs p-1 w-1/4"><input type="number" step="0.01" value="${tx.price}" id="input-buy-price-${tx.uuid}" class="form-input text-xs p-1 w-1/4"><div class="flex gap-1"><button onclick="handleUpdatePurchase('${tx.uuid}')" class="btn btn-primary p-1"><i data-lucide="check" class="h-3 w-3"></i></button><button onclick="hideEditBuyForm('${tx.uuid}')" class="btn btn-secondary p-1"><i data-lucide="x" class="h-3 w-3"></i></button></div></div></div>`).join(''); const salesHistoryHTML = salesHistory.map(sale => `<div><div id="sale-display-${sale.uuid}" class="flex justify-between items-center text-xs py-2 border-b border-gray-700 last:border-b-0"><div class="text-gray-400 flex-grow"><span>${sale.date}</span><span class="ml-2">${sale.shares} 張 @ ${sale.price}</span></div><div class="font-semibold text-xs ${sale.realizedPL >= 0 ? 'text-green-400' : 'text-red-400'}">${sale.realizedPL >= 0 ? '+' : ''}${Math.round(sale.realizedPL).toLocaleString()}</div><div class="flex items-center gap-2 ml-2"><button class="text-gray-500 hover:text-blue-400" onclick="showEditSaleForm('${sale.uuid}', '${stockId}')"><i data-lucide="pencil" class="h-4 w-4"></i></button><button class="text-gray-500 hover:text-red-400" onclick="deleteSale('${stockId}', '${sale.uuid}')"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div></div><div id="sale-edit-${sale.uuid}" class="hidden items-end gap-2 text-xs py-2 border-b border-gray-700 last:border-b-0"><input type="date" value="${sale.date}" id="input-sale-date-${sale.uuid}" class="form-input text-xs p-1 w-1/3"><input type="number" step="0.001" value="${sale.shares}" id="input-sale-shares-${sale.uuid}" class="form-input text-xs p-1 w-1/4"><input type="number" step="0.01" value="${sale.price}" id="input-sale-price-${sale.uuid}" class="form-input text-xs p-1 w-1/4"><div class="flex gap-1"><button onclick="handleUpdateSale('${sale.uuid}', '${stockId}')" class="btn btn-primary p-1"><i data-lucide="check" class="h-3 w-3"></i></button><button onclick="hideEditSaleForm('${sale.uuid}')" class="btn btn-secondary p-1"><i data-lucide="x" class="h-3 w-3"></i></button></div></div></div>`).join(''); const isFeeOverridden = feeSettings[stockId] !== undefined; const currentSellFee = getSellFeeRate(stockId); const feeDisplayHTML = `<div id="fee-display-${sanitizedCycleId}" class="flex items-center gap-2"><span class="font-semibold ${isFeeOverridden ? 'text-yellow-400' : ''}" ${isFeeOverridden ? 'title="手動設定值"' : ''}>${(currentSellFee * 100).toFixed(4)}%</span><button onclick="showEditFeeForm('${sanitizedCycleId}', '${stockId}')" class="text-gray-500 hover:text-blue-400"><i data-lucide="pencil" class="h-4 w-4"></i></button>${isFeeOverridden ? `<button onclick="handleResetFee('${stockId}')" class="text-gray-500 hover:text-yellow-400" title="恢復預設值"><i data-lucide="rotate-ccw" class="h-4 w-4"></i></button>` : ''}</div><div id="fee-edit-${sanitizedCycleId}" class="hidden w-full flex gap-2"><input type="number" step="0.000001" value="${currentSellFee}" id="input-fee-${sanitizedCycleId}" class="form-input text-sm p-1"><button onclick="handleUpdateFee('${stockId}', '${sanitizedCycleId}')" class="btn btn-primary p-1"><i data-lucide="check" class="h-4 w-4"></i></button><button onclick="hideEditFeeForm('${sanitizedCycleId}')" class="btn btn-secondary p-1"><i data-lucide="x" class="h-4 w-4"></i></button></div>`; const dividendDetailsHTML = groupMetrics.dividends.length > 0 ? groupMetrics.dividends.map(div => { const isDivOverridden = div.isOverridden; const dividendValue = `<span class="font-semibold ${isDivOverridden ? 'text-yellow-400' : ''}" ${isDivOverridden ? 'title="手動設定值"' : ''}>${div.dividend.toFixed(4)}</span>`; const resetDivBtnHTML = isDivOverridden ? `<button onclick="handleResetIndividualDividend('${stockId}', '${div.originalDate}')" class="ml-1 text-gray-500 hover:text-yellow-400" title="恢復為自動計算"><i data-lucide="rotate-ccw" class="h-4 w-4"></i></button>` : ''; return `<div class="flex justify-between items-center text-xs py-2 border-b border-gray-700 last:border-b-0"><div id="div-display-${sanitizedCycleId}-${div.originalDate}" class="flex items-center justify-between w-full"><span class="text-gray-400">${div.date}</span><div class="flex items-center">${dividendValue}<button onclick="showEditDividendRow('${sanitizedCycleId}', '${stockId}', '${div.originalDate}')" class="ml-1 text-gray-500 hover:text-blue-400"><i data-lucide="pencil" class="h-4 w-4"></i></button>${resetDivBtnHTML}</div></div><div id="div-edit-${sanitizedCycleId}-${div.originalDate}" class="hidden w-full flex gap-1 items-center"><input type="date" value="${div.date}" id="input-div-date-${sanitizedCycleId}-${div.originalDate}" class="form-input text-xs p-1 w-2/5"><input type="number" step="0.0001" value="${div.dividend}" id="input-div-amount-${sanitizedCycleId}-${div.originalDate}" class="form-input text-xs p-1 w-1/4"><button onclick="handleUpdateIndividualDividend('${stockId}', '${div.originalDate}', '${sanitizedCycleId}')" class="btn btn-primary p-1"><i data-lucide="check" class="h-3 w-3"></i></button><button onclick="handleDeleteIndividualDividend('${stockId}', '${div.originalDate}')" class="btn btn-secondary p-1"><i data-lucide="trash-2" class="h-3 w-3"></i></button><button onclick="hideEditDividendRow('${sanitizedCycleId}', '${div.originalDate}')" class="btn btn-secondary p-1"><i data-lucide="x" class="h-3 w-3"></i></button></div></div>` }).join('') : '<p class="text-xs text-gray-500 text-center py-2">無配息紀錄</p>'; const overallReturnColor = totalPL >= 0 ? 'text-green-400' : 'text-red-400'; const card = document.createElement('div'); card.className = 'card'; card.id = `card-${sanitizedCycleId}`; const cardHeaderHTML = `<div class="flex justify-between items-start mb-4"><div id="header-display-${sanitizedCycleId}"><h3 class="text-2xl font-bold text-white flex items-center">${stockData.stockName || stockId}<button onclick="showEditStockIdForm('${sanitizedCycleId}', '${stockId}')" title="編輯股票代碼" class="ml-2 text-gray-500 hover:text-blue-400"><i data-lucide="pencil" class="h-4 w-4"></i></button></h3><p class="text-sm text-gray-400">${stockId}・${originalPurchases.length} 筆買入</p></div><div id="header-edit-${sanitizedCycleId}" class="hidden w-full"><div class="flex gap-2"><input type="text" value="${stockId}" id="input-stockId-${sanitizedCycleId}" class="form-input text-lg" placeholder="股票代碼"><button onclick="handleUpdateStockId('${sanitizedCycleId}', '${stockId}')" class="btn btn-primary p-2"><i data-lucide="check" class="h-5 w-5"></i></button><button onclick="hideEditStockIdForm('${sanitizedCycleId}')" class="btn btn-secondary p-2"><i data-lucide="x" class="h-5 w-5"></i></button><button onclick="deleteStockGroup('${stockId}')" class="btn bg-red-600 hover:bg-red-700 p-2" title="刪除此股票所有紀錄"><i data-lucide="trash-2" class="h-5 w-5"></i></button></div></div></div>`; const cardStatsHTML = `<div class="space-y-3 text-sm">${!isHistorical ? priceLineHTML : ''}<div class="flex justify-between"><span class="text-gray-400">${isHistorical ? '總賣出張數' : '持有張數'}</span><span class="font-semibold">${isHistorical ? stockSales.reduce((s, t) => s + t.shares, 0).toLocaleString() : groupMetrics.totalShares.toLocaleString()}</span></div><div class="flex justify-between"><span class="text-gray-400">${isHistorical ? '總投入成本' : '持有成本'}</span><span class="font-semibold">${Math.round(isHistorical ? originalTotalCost : groupMetrics.totalCost).toLocaleString()}</span></div>${!isHistorical ? `<div class="flex justify-between"><span class="text-gray-400">含息持有均價</span><span class="font-semibold">${groupMetrics.avgHoldingCost > 0 ? groupMetrics.avgHoldingCost.toFixed(2) : 'N/A'}</span></div>` : ''}<div class="flex flex-col"><div class="flex justify-between items-center"><span class="text-gray-400" title="自您購入股票後，實際已收到的現金股利總和">累積股利</span><div class="flex items-center"><span class="font-semibold text-green-400">+${Math.round(totalCumulativeDividend).toLocaleString()}</span><button onclick="handleResetAllDividendsForStock('${stockId}')" class="ml-1 text-gray-500 hover:text-yellow-400" title="還原所有股利為自動計算"><i data-lucide="rotate-ccw" class="h-4 w-4"></i></button><i data-lucide="chevron-down" class="h-4 w-4 text-gray-500 cursor-pointer ml-1" onclick="toggleDividendDetails('${sanitizedCycleId}')"></i></div></div><div class="details-container pl-4 mt-2" id="dividend-details-${sanitizedCycleId}">${dividendDetailsHTML}<div class="pt-2 mt-2 border-t border-gray-700"><button onclick="showAddDividendModalByStockId('${stockId}')" class="w-full text-xs btn btn-secondary py-1 px-2"><i data-lucide="plus" class="h-3 w-3 mr-1"></i> 手動新增一筆股利</button></div></div></div>${!isHistorical ? `<div class="flex justify-between items-center"><span class="text-gray-400">預計一年利息</span><div id="dividend-display-${sanitizedCycleId}" class="flex items-center">${projectedDividendHTML} <button onclick="showEditDividendForm('${sanitizedCycleId}', '${stockId}')" class="ml-1 text-gray-500 hover:text-blue-400"><i data-lucide="pencil" class="h-4 w-4"></i></button>${resetProjectedBtnHTML}</div><div id="dividend-edit-${sanitizedCycleId}" class="hidden w-full flex gap-2"><input type="number" value="${Math.round(groupMetrics.projectedAnnualDividend)}" id="input-dividend-${sanitizedCycleId}" class="form-input text-sm"><button onclick="handleUpdateProjectedDividend('${stockId}', '${sanitizedCycleId}')" class="btn btn-primary p-2"><i data-lucide="check" class="h-4 w-4"></i></button><button onclick="hideEditDividendForm('${sanitizedCycleId}')" class="btn btn-secondary p-2"><i data-lucide="x" class="h-4 w-4"></i></button></div></div>` : ''}${realizedPLLineHTML}${!isHistorical ? unrealizedPLLineHTML : ''}</div>`; const cardTransactionHistoryHTML = `<div class="details-container" id="details-${sanitizedCycleId}"><div class="mt-4 pt-4 border-t border-gray-700"><h4 class="font-semibold text-base mb-2">買入紀錄</h4>${buyHistoryHTML || '<p class="text-xs text-gray-500 text-center py-2">無買入紀錄</p>'}<h4 class="font-semibold text-base mt-4 mb-2">賣出紀錄</h4><div class="text-xs text-gray-400 mb-2 flex justify-between items-center"><span>賣出手續費率:</span>${feeDisplayHTML}</div>${salesHistoryHTML || '<p class="text-xs text-gray-500 text-center py-2">無賣出紀錄</p>'}${!isHistorical ? `<form id="addSaleForm-${sanitizedCycleId}" class="grid grid-cols-4 gap-2 items-end mt-4 pt-4 border-t border-gray-800"><input type="hidden" name="stockId" value="${stockId}"><div><label class="block text-xs font-medium text-gray-400 mb-1">賣出日期</label><input type="date" name="saleDate" class="form-input text-xs p-1" required></div><div><label class="block text-xs font-medium text-gray-400 mb-1">賣出張數</label><input type="number" name="saleShares" min="0.001" step="0.001" class="form-input text-xs p-1" required></div><div><label class="block text-xs font-medium text-gray-400 mb-1">賣出價格</label><input type="number" name="salePrice" min="0" step="0.01" class="form-input text-xs p-1" required></div><button type="submit" class="btn btn-primary btn-sm p-1 text-xs">新增賣出</button></form>` : ''}</div></div>`; const cardFooterHTML = `<div class="mt-6 pt-4 border-t border-gray-600 relative"><div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-[#1f2937] px-2"><i data-lucide="chevron-down" id="chevron-${sanitizedCycleId}" class="h-6 w-6 text-gray-500 transition-transform cursor-pointer" onclick="toggleDetails('${sanitizedCycleId}')"></i></div><div class="flex justify-between items-center mt-1"><span class="text-gray-400">整體報酬率</span><div class="text-right"><span class="text-xl font-bold ${overallReturnColor}">${overallReturnRate.toFixed(2)}%</span><p class="text-sm font-semibold ${overallReturnColor}">${totalPL >= 0 ? '+' : ''}${Math.round(totalPL).toLocaleString()}</p></div></div></div>`; const compactItem = document.createElement('div'); compactItem.className = 'bg-gray-800 p-3 rounded-lg flex items-center gap-4 text-sm w-auto'; const returnColor = totalPL >= 0 ? 'text-green-400' : 'text-red-400'; if (!isHistorical) { compactItem.innerHTML = `<div class="font-semibold text-white">${stockData.stockName || stockId} <span class="text-gray-400 text-xs">${stockId}</span></div><div class="text-right"><div class="text-gray-300 ${priceClass}">${priceForDisplay.toFixed(2)}</div><div class="text-xs text-gray-500">目前股價</div></div><div class="text-right"><div class="text-gray-300">${groupMetrics.avgHoldingCost > 0 ? groupMetrics.avgHoldingCost.toFixed(2) : 'N/A'}</div><div class="text-xs text-gray-500">含息均價</div></div><div class="text-right"><div class="font-semibold ${returnColor}">${overallReturnRate.toFixed(2)}%</div><div class="text-xs ${returnColor}">${totalPL >= 0 ? '+' : ''}${Math.round(totalPL).toLocaleString()}</div></div>`; stockListCompactContainer.appendChild(compactItem); } else { compactItem.innerHTML = `<div class="font-semibold text-white">${stockData.stockName || stockId} <span class="text-gray-400 text-xs">${stockId}</span></div><div class="text-right"><div class="font-semibold ${returnColor}">${overallReturnRate.toFixed(2)}%</div><div class="text-xs text-gray-500">整體報酬率</div></div><div class="text-right"><div class="font-semibold ${returnColor}">${totalPL >= 0 ? '+' : ''}${Math.round(totalPL).toLocaleString()}</div><div class="text-xs text-gray-500">總損益</div></div>`; historyListCompactContainer.appendChild(compactItem); } card.innerHTML = `<div>${cardHeaderHTML}${cardStatsHTML}${cardFooterHTML}${cardTransactionHistoryHTML}</div>`; const targetContainer = isHistorical ? historyListContainer : stockListContainer; targetContainer.appendChild(card); if (!isHistorical) { document.getElementById(`addSaleForm-${sanitizedCycleId}`).addEventListener('submit', handleAddSale); document.querySelector(`#addSaleForm-${sanitizedCycleId} input[name='saleDate']`).valueAsDate = new Date(); } } historyContainer.classList.toggle('hidden', !hasHistory); lucide.createIcons(); const summaryGains = renderSummary(allMetricsForSummary, allSalesHistoryForSummary, stockDataMap); renderFinancialPlan(summaryGains); }
        window.toggleDetails = function(sanitizedCycleId) { const detailsContainer = document.getElementById(`details-${sanitizedCycleId}`); const chevron = document.getElementById(`chevron-${sanitizedCycleId}`); if (detailsContainer.style.maxHeight && detailsContainer.style.maxHeight !== '0px') { detailsContainer.style.maxHeight = null; chevron.style.transform = 'rotate(0deg)'; } else { detailsContainer.style.maxHeight = detailsContainer.scrollHeight + "px"; chevron.style.transform = 'rotate(180deg)'; } }
        window.toggleDividendDetails = function(sanitizedCycleId) { const detailsContainer = document.getElementById(`dividend-details-${sanitizedCycleId}`); if (detailsContainer.style.maxHeight) { detailsContainer.style.maxHeight = null; } else { detailsContainer.style.maxHeight = detailsContainer.scrollHeight + "px"; } }
        
        function renderSummary(allMetrics, allSalesHistory, stockDataMap) {
            summaryContainer.innerHTML = '';
            let summaryGainsByYear = {};
            if (portfolio.length === 0 && Object.keys(settings.targetProfits).length === 0) {
                summaryContainer.innerHTML = '<p class="text-gray-400 text-center py-8">無資料可供統計。</p>';
                return summaryGainsByYear;
            }

            let summaryData = {};
            let totalProjectedDividends = 0;
            let currentTotalInvestment = 0;
            let totalUnrealizedPL = 0;

            allMetrics.forEach(metric => {
                currentTotalInvestment += metric.totalCost;
                totalUnrealizedPL += metric.returnAmount;
            });

            const groupedMetrics = allMetrics.reduce((acc, tx) => {
                if (!acc[tx.id]) { acc[tx.id] = []; }
                acc[tx.id].push(tx);
                return acc;
            }, {});

            for (const stockId in groupedMetrics) {
                const group = calculateGroupMetrics(groupedMetrics[stockId], stockId);
                totalProjectedDividends += group.projectedAnnualDividend;
            }

            const allCycles = groupTransactionsIntoCycles(portfolio, sales);
            for (const cycle of allCycles) {
                const { stockId, purchases, sales: cycleSales } = cycle;
                const stockData = stockDataMap[stockId];
                if (!stockData) continue;
                const manualDividends = portfolio.filter(p => p.id === stockId).flatMap(p => p.manualDividends || []);
                const combinedDividends = [...stockData.dividends, ...manualDividends];
                const uniqueDividends = Array.from(new Map(combinedDividends.map(d => [d.date, d])).values());
                const stockOverrides = (settings.manualOverrides[stockId] && settings.manualOverrides[stockId].dividends) || {};
                const finalDividends = uniqueDividends.map(div => {
                    const override = stockOverrides[div.date];
                    if (override && override.deleted) return null;
                    return { ...div, date: override?.newDate || div.date, dividend: override?.newAmount ?? div.dividend };
                }).filter(Boolean);

                let purchaseQueue = JSON.parse(JSON.stringify(purchases.sort((a, b) => new Date(a.date) - new Date(b.date))));
                for (const sale of cycleSales.sort((a, b) => new Date(a.date) - new Date(b.date))) {
                    let sharesToSell = sale.shares * 1000;
                    while (sharesToSell > 0 && purchaseQueue.length > 0) {
                        const lot = purchaseQueue[0];
                        const sharesAvailable = lot.shares * 1000;
                        const sharesToTake = Math.min(sharesToSell, sharesAvailable);
                        const purchaseDate = new Date(lot.date);
                        const saleDate = new Date(sale.date);
                        finalDividends.forEach(div => {
                            const exDivDate = new Date(div.date);
                            if (exDivDate >= purchaseDate && exDivDate < saleDate) {
                                let fiscalYear = exDivDate.getFullYear();
                                if (exDivDate.getMonth() + 1 < settings.fiscalYearStart) fiscalYear--;
                                if (!summaryData[fiscalYear]) summaryData[fiscalYear] = { receivedDividends: 0, investment: 0, realizedPL: 0 };
                                summaryData[fiscalYear].receivedDividends += div.dividend * sharesToTake;
                            }
                        });
                        lot.shares -= sharesToTake / 1000;
                        sharesToSell -= sharesToTake;
                        if (lot.shares < 1e-9) purchaseQueue.shift();
                    }
                }
                for (const lot of purchaseQueue) {
                    const sharesHeld = lot.shares * 1000;
                    const purchaseDate = new Date(lot.date);
                    finalDividends.forEach(div => {
                        const exDivDate = new Date(div.date);
                        if (exDivDate >= purchaseDate) {
                            let fiscalYear = exDivDate.getFullYear();
                            if (exDivDate.getMonth() + 1 < settings.fiscalYearStart) fiscalYear--;
                            if (!summaryData[fiscalYear]) summaryData[fiscalYear] = { receivedDividends: 0, investment: 0, realizedPL: 0 };
                            summaryData[fiscalYear].receivedDividends += div.dividend * sharesHeld;
                        }
                    });
                }
            }

            for (const sale of allSalesHistory) {
                const saleDate = new Date(sale.date);
                let fiscalYear = saleDate.getFullYear();
                if (saleDate.getMonth() + 1 < settings.fiscalYearStart) fiscalYear--;
                if (!summaryData[fiscalYear]) summaryData[fiscalYear] = { receivedDividends: 0, investment: 0, realizedPL: 0 };
                summaryData[fiscalYear].realizedPL += sale.realizedPL;
            }

            const today = new Date();
            const oneYearFromNow = new Date(new Date().setFullYear(today.getFullYear() + 1));
            let cutoffFiscalYear = oneYearFromNow.getFullYear();
            if (oneYearFromNow.getMonth() + 1 < settings.fiscalYearStart) {
                cutoffFiscalYear--;
            }

            const allYears = new Set([...Object.keys(summaryData), ...Object.keys(settings.targetProfits)]);
            const sortedYears = Array.from(allYears).sort((a, b) => a - b);
            const yearsToDisplay = sortedYears.filter(year => year <= cutoffFiscalYear);

            let tableHTML = `<table class="w-full text-left"><thead class="border-b border-gray-700"><tr><th class="p-4 text-sm font-semibold text-gray-300">年度</th><th class="p-4 text-sm font-semibold text-gray-300 text-right">已獲利息總額</th><th class="p-4 text-sm font-semibold text-gray-300 text-right">已實現損益</th><th class="p-4 text-sm font-semibold text-gray-300 text-right">總獲益</th><th class="p-4 text-sm font-semibold text-gray-300 text-right">目標獲益</th></tr></thead><tbody>`;
            
            yearsToDisplay.forEach(year => {
                const yearData = summaryData[year] || { receivedDividends: 0, realizedPL: 0 };
                const receivedDividends = yearData.receivedDividends;
                const realizedPL = yearData.realizedPL;
                
                const startMonth = settings.fiscalYearStart;
                const endMonth = (startMonth - 2 + 12) % 12 + 1;
                const endYear = parseInt(year) + 1;
                const yearDisplay = `${year}/${String(startMonth).padStart(2, '0')} ~ ${endYear}/${String(endMonth).padStart(2, '0')}`;
                
                let dividendCellHTML;
                if (Math.round(receivedDividends) === 0) {
                    dividendCellHTML = `<td class="p-4 text-right text-blue-400">+${Math.round(totalProjectedDividends).toLocaleString()} (預估)</td>`;
                } else {
                    dividendCellHTML = `<td class="p-4 text-right text-green-400">+${Math.round(receivedDividends).toLocaleString()}</td>`;
                }

                const targetProfit = settings.targetProfits?.[year] || 0;
                const totalGain = receivedDividends + realizedPL;
                summaryGainsByYear[year] = totalGain;
                const gainPercentage = targetProfit > 0 ? (totalGain / targetProfit) * 100 : 0;
                const realizedPLColor = realizedPL >= 0 ? 'text-green-400' : 'text-red-400';
                const totalGainColor = totalGain >= 0 ? 'text-green-400' : 'text-red-400';
                
                tableHTML += `<tr class="border-b border-gray-800">
                                <td class="p-4 font-semibold">${yearDisplay}</td>
                                ${dividendCellHTML}
                                <td class="p-4 text-right ${realizedPLColor}">${realizedPL >= 0 ? '+' : ''}${Math.round(realizedPL).toLocaleString()}</td>
                                <td class="p-4 text-right font-semibold ${totalGainColor}">${totalGain >= 0 ? '+' : ''}${Math.round(totalGain).toLocaleString()} <span class="text-xs text-gray-400">(${gainPercentage.toFixed(1)}%)</span></td>
                                <td class="p-4 text-right text-yellow-400 cursor-pointer hover:bg-gray-700" contenteditable="true" data-year="${year}">${targetProfit.toLocaleString()}</td>
                              </tr>`;
            });

            const totalDividendYield = currentTotalInvestment > 0 ? (totalProjectedDividends / currentTotalInvestment) * 100 : 0;
            const holdingReturnRate = currentTotalInvestment > 0 ? (totalUnrealizedPL / currentTotalInvestment) * 100 : 0;
            const holdingReturnColor = totalUnrealizedPL >= 0 ? 'text-green-400' : 'text-red-400';
            
            tableHTML += `</tbody><tfoot class="font-bold">
                            <tr class="border-t-2 border-gray-600"><td class="p-4">總計</td><td class="p-4 text-right" colspan="4"></td></tr>
                            <tr><td class="px-4 pb-2 text-gray-400">目前持有成本</td><td class="px-4 pb-2 text-right" colspan="4">${Math.round(currentTotalInvestment).toLocaleString()}</td></tr>
                            <tr><td class="px-4 pb-2 text-gray-400">持有總報酬率 (未實現損益)</td><td class="px-4 pb-2 text-right ${holdingReturnColor}" colspan="4">${totalUnrealizedPL >= 0 ? '+' : ''}${Math.round(totalUnrealizedPL).toLocaleString()} (${holdingReturnRate.toFixed(2)}%)</td></tr>
                            <tr><td class="px-4 pb-4 text-gray-400">預計年利息總額</td><td class="px-4 pb-4 text-right text-blue-400" colspan="4">${Math.round(totalProjectedDividends).toLocaleString()} (${totalDividendYield.toFixed(2)}%)</td></tr>
                          </tfoot></table>`;
            
            summaryContainer.innerHTML = tableHTML;
            document.querySelectorAll('#summaryTableContainer [contenteditable="true"]').forEach(cell => {
                cell.addEventListener('blur', (e) => {
                    const year = e.target.dataset.year;
                    const value = parseInt(e.target.textContent.replace(/,/g, ''), 10) || 0;
                    if (!settings.targetProfits) settings.targetProfits = {};
                    settings.targetProfits[year] = value;
                    saveData();
                    e.target.textContent = value.toLocaleString();
                    renderFinancialPlan(summaryGainsByYear);
                });
                cell.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.target.blur();
                    }
                });
            });
            return summaryGainsByYear;
        }

        function calculateActualHoldingsByYear(planningYears) {
            // 此函數採用先進先出(FIFO)原則，計算每個指定會計年度結束時的持股總成本。
            // 它會根據當前日期，精確判斷每個規劃年度的計算截止點。
            const holdingsByYear = {};
            const allSalesFlat = Object.entries(sales).flatMap(([stockId, salesArray]) => salesArray.map(sale => ({ ...sale, stockId })));
            const today = new Date();

            // 為了避免重複計算，先找出當前日期所在的會計年度
            let currentFiscalYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            if (currentMonth < settings.fiscalYearStart) {
                currentFiscalYear--;
            }

            for (const year of planningYears) {
                const fiscalYearInt = parseInt(year);
                
                // [V0.6 LOGIC] 判斷計算的截止日期
                let calculationCutoffDate;

                if (fiscalYearInt < currentFiscalYear) {
                    // 1. 對於已完全過去的會計年度，計算到該年度的最後一天
                    calculationCutoffDate = new Date(fiscalYearInt + 1, settings.fiscalYearStart - 1, 0);
                } else if (fiscalYearInt === currentFiscalYear) {
                    // 2. 對於當前所在的會計年度，計算到今天為止，以反映即時持股狀況
                    calculationCutoffDate = today;
                } else {
                    // 3. 對於未來的會計年度，持有量為0，因為尚未開始
                    holdingsByYear[year] = 0;
                    continue; // 直接跳到下一年
                }

                // 獲取在此計算截止日期前發生過的所有買入和賣出紀錄。
                const purchasesBefore = portfolio.filter(p => new Date(p.date) <= calculationCutoffDate);
                const salesBefore = allSalesFlat.filter(s => new Date(s.date) <= calculationCutoffDate);

                const purchasesById = purchasesBefore.reduce((acc, p) => {
                    if (!acc[p.id]) acc[p.id] = [];
                    acc[p.id].push(p);
                    return acc;
                }, {});

                let totalHoldingCostForYear = 0;

                // 對於每支股票，應用FIFO邏輯處理賣出與買入。
                for (const stockId in purchasesById) {
                    // 為避免修改原始數據，創建此股票買入紀錄的深度副本，並按日期排序以實現FIFO。
                    let purchaseQueue = JSON.parse(JSON.stringify(purchasesById[stockId].sort((a, b) => new Date(a.date) - new Date(b.date))));
                    const relevantSales = salesBefore.filter(s => s.stockId === stockId).sort((a, b) => new Date(a.date) - new Date(b.date));

                    for (const sale of relevantSales) {
                        let sharesToSell = sale.shares * 1000;
                        while (sharesToSell > 0 && purchaseQueue.length > 0) {
                            const lot = purchaseQueue[0];
                            const sharesAvailable = lot.shares * 1000;
                            const sharesToTake = Math.min(sharesToSell, sharesAvailable);

                            lot.shares -= sharesToTake / 1000; // 從最早的買入批次中扣除股數。
                            sharesToSell -= sharesToTake;

                            if (lot.shares < 1e-9) {
                                purchaseQueue.shift(); // 如果批次已完全賣出，則將其移除。
                            }
                        }
                    }
                    // 處理完此年度結束前的所有賣出後，計算隊列中剩餘股票的成本。
                    const remainingCost = purchaseQueue.reduce((sum, lot) => sum + (lot.price * lot.shares * 1000 * (1 + BUY_FEE_RATE)), 0);
                    totalHoldingCostForYear += remainingCost;
                }
                holdingsByYear[year] = totalHoldingCostForYear;
            }
            return holdingsByYear;
        }

        function renderFinancialPlan(summaryGains = {}) { const plan = settings.financialPlan || {}; const initialAge = parseInt(plan.initialAge) || ''; const startYear = parseInt(plan.initialInvestmentYear) || ''; const endYear = parseInt(plan.planningEndYear) || ''; const initialAmount = parseFloat(plan.initialInvestmentAmount) || 0; const annualIncrease = parseFloat(plan.annualIncreaseAmount) || 0; const returnRate = parseFloat(plan.expectedReturnRate) / 100 || 0; hideZeroGainRowsCheckbox.checked = settings.hideZeroGainRows; document.getElementById('initialAge').value = initialAge; document.getElementById('initialInvestmentYear').value = startYear; document.getElementById('planningEndYear').value = endYear; document.getElementById('initialInvestmentAmount').value = initialAmount; document.getElementById('annualIncreaseAmount').value = annualIncrease; document.getElementById('expectedReturnRate').value = (returnRate * 100); if (!initialAge || !startYear || !endYear || !initialAmount || returnRate <= 0) { financialPlanResultContainer.innerHTML = '<p class="text-gray-400 text-center py-4">請輸入完整的規劃參數。</p>'; return; } const planningYears = Array.from({length: endYear - startYear + 1}, (_, i) => startYear + i); const actualHoldings = calculateActualHoldingsByYear(planningYears); let tableHTML = `<table class="w-full text-left"><thead class="border-b border-gray-700"><tr><th class="p-4 text-sm font-semibold text-gray-300">年度</th><th class="p-4 text-sm font-semibold text-gray-300">年齡</th><th class="p-4 text-sm font-semibold text-gray-300 text-right">預計持有股票</th><th class="p-4 text-sm font-semibold text-gray-300 text-right">實際持有股票</th><th class="p-4 text-sm font-semibold text-gray-300 text-right">已實現總獲益</th><th class="p-4 text-sm font-semibold text-gray-300 text-right">目標獲益</th></tr></thead><tbody>`; let currentTotal = initialAmount; let currentAge = initialAge; let newTargetProfits = {}; for (const year of planningYears) { const startMonth = settings.fiscalYearStart; const endMonth = (startMonth - 2 + 12) % 12 + 1; const endYear = parseInt(year) + 1; const yearDisplay = `${year}/${String(startMonth).padStart(2, '0')} ~ ${endYear}/${String(endMonth).padStart(2, '0')}`; let targetProfit = settings.targetProfits[year] !== undefined ? settings.targetProfits[year] : 0; if (targetProfit === 0) { if (year > startYear) { targetProfit = currentTotal * returnRate; } else { targetProfit = initialAmount * returnRate; } } if (year > startYear) { currentTotal += annualIncrease + (settings.targetProfits[year-1] || currentTotal * returnRate); } newTargetProfits[year] = Math.round(targetProfit); const realizedGain = summaryGains[year] || 0; if (settings.hideZeroGainRows && realizedGain === 0) { currentAge++; continue; } const actualHolding = actualHoldings[year]; const actualHoldingDisplay = (typeof actualHolding === 'number') ? Math.round(actualHolding).toLocaleString() : '0'; const realizedGainColor = realizedGain >= 0 ? 'text-green-400' : 'text-red-400'; const gainPercentage = targetProfit > 0 ? (realizedGain / targetProfit) * 100 : 0; tableHTML += `<tr class="border-b border-gray-800"><td class="p-4">${yearDisplay}</td><td class="p-4">${currentAge}</td><td class="p-4 text-right">${Math.round(currentTotal).toLocaleString()}</td><td class="p-4 text-right">${actualHoldingDisplay}</td><td class="p-4 text-right ${realizedGainColor}">${realizedGain >= 0 ? '+' : ''}${Math.round(realizedGain).toLocaleString()} <span class="text-xs text-gray-400">(${gainPercentage.toFixed(1)}%)</span></td><td class="p-4 text-right text-yellow-400 cursor-pointer hover:bg-gray-700" contenteditable="true" data-year="${year}">${Math.round(targetProfit).toLocaleString()}</td></tr>`; currentAge++; } tableHTML += `</tbody></table>`; financialPlanResultContainer.innerHTML = tableHTML; document.querySelectorAll('#financialPlanResult [contenteditable="true"]').forEach(cell => { cell.addEventListener('blur', (e) => { const year = e.target.dataset.year; const value = parseInt(e.target.textContent.replace(/,/g, ''), 10) || 0; if (!settings.targetProfits) settings.targetProfits = {}; settings.targetProfits[year] = value; saveData(); e.target.textContent = value.toLocaleString(); const summaryGains = renderSummary(allMetricsForSummary_global, allSalesHistoryForSummary_global, stockDataMap_global); renderFinancialPlan(summaryGains); }); cell.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }); }); return newTargetProfits; }
        function handleGeneratePlan() { settings.financialPlan = { initialAge: document.getElementById('initialAge').value, initialInvestmentYear: document.getElementById('initialInvestmentYear').value, planningEndYear: document.getElementById('planningEndYear').value, initialInvestmentAmount: document.getElementById('initialInvestmentAmount').value, annualIncreaseAmount: document.getElementById('annualIncreaseAmount').value, expectedReturnRate: document.getElementById('expectedReturnRate').value }; const newTargets = renderFinancialPlan({}); if (newTargets) { settings.targetProfits = { ...settings.targetProfits, ...newTargets }; saveData(); renderPortfolio(); showToast('財務規劃已更新並同步目標至年度總覽！'); } }

        function handleAddStock(e) { e.preventDefault(); const newStock = { uuid: self.crypto.randomUUID(), id: document.getElementById('stockId').value.trim(), date: document.getElementById('purchaseDate').value, shares: parseFloat(document.getElementById('purchaseShares').value), price: parseFloat(document.getElementById('purchasePrice').value), manualDividends: [] }; portfolio.push(newStock); saveData(); renderPortfolio(); addStockForm.reset(); document.getElementById('purchaseDate').valueAsDate = new Date(); }
        function handleAddSale(e) { e.preventDefault(); const form = e.target; const stockId = form.elements.stockId.value; const newSale = { uuid: self.crypto.randomUUID(), date: form.elements.saleDate.value, shares: parseFloat(form.elements.saleShares.value), price: parseFloat(form.elements.salePrice.value) }; if (!sales[stockId]) { sales[stockId] = []; } sales[stockId].push(newSale); saveData(); renderPortfolio(); }
        window.deleteStock = function(uuid) { portfolio = portfolio.filter(stock => stock.uuid !== uuid); saveData(); renderPortfolio(); }
        window.deleteSale = function(stockId, uuid) { if (sales[stockId]) { sales[stockId] = sales[stockId].filter(sale => sale.uuid !== uuid); if (sales[stockId].length === 0) { delete sales[stockId]; } saveData(); renderPortfolio(); } }
        window.deleteStockGroup = function(stockId) { portfolio = portfolio.filter(tx => tx.id !== stockId); delete sales[stockId]; delete feeSettings[stockId]; delete settings.manualOverrides[stockId]; saveData(); renderPortfolio(); showToast(`已刪除 ${stockId} 的所有相關紀錄。`); }
        function handleSettingsChange() { settings.fiscalYearStart = parseInt(fiscalYearStartSelect.value); saveData(); renderPortfolio(); }
        window.showAddDividendModalByStockId = function(stockId) { document.getElementById('modalStockId').value = stockId; addDividendModal.classList.remove('hidden'); }
        function hideAddDividendModal() { addDividendModal.classList.add('hidden'); addDividendForm.reset(); }
        function handleAddDividend(e) { e.preventDefault(); const stockId = document.getElementById('modalStockId').value; const stock = portfolio.find(s => s.id === stockId); if (stock) { if (!stock.manualDividends) stock.manualDividends = []; stock.manualDividends.push({ date: document.getElementById('modalDividendExDate').value, dividend: parseFloat(document.getElementById('modalDividendAmount').value) }); saveData(); renderPortfolio(); } hideAddDividendModal(); }
        window.showEditStockIdForm = (sanitizedCycleId, stockId) => { document.getElementById(`header-display-${sanitizedCycleId}`).classList.add('hidden'); document.getElementById(`header-edit-${sanitizedCycleId}`).classList.remove('hidden'); lucide.createIcons(); }
        window.hideEditStockIdForm = (sanitizedCycleId) => { document.getElementById(`header-display-${sanitizedCycleId}`).classList.remove('hidden'); document.getElementById(`header-edit-${sanitizedCycleId}`).classList.add('hidden'); }
        window.showEditBuyForm = (uuid) => { document.getElementById(`buy-display-${uuid}`).classList.add('hidden'); document.getElementById(`buy-edit-${uuid}`).classList.remove('hidden'); lucide.createIcons(); }
        window.hideEditBuyForm = (uuid) => { document.getElementById(`buy-display-${uuid}`).classList.remove('hidden'); document.getElementById(`buy-edit-${uuid}`).classList.add('hidden'); }
        window.showEditSaleForm = (uuid) => { document.getElementById(`sale-display-${uuid}`).classList.add('hidden'); document.getElementById(`sale-edit-${uuid}`).classList.remove('hidden'); lucide.createIcons(); }
        window.hideEditSaleForm = (uuid) => { document.getElementById(`sale-display-${uuid}`).classList.remove('hidden'); document.getElementById(`sale-edit-${uuid}`).classList.add('hidden'); }
        window.handleUpdatePurchase = (uuid) => { const tx = portfolio.find(p => p.uuid === uuid); if (tx) { tx.date = document.getElementById(`input-buy-date-${uuid}`).value; tx.shares = parseFloat(document.getElementById(`input-buy-shares-${uuid}`).value); tx.price = parseFloat(document.getElementById(`input-buy-price-${uuid}`).value); saveData(); renderPortfolio(); } };
        window.handleUpdateSale = (uuid, stockId) => { const tx = sales[stockId]?.find(s => s.uuid === uuid); if (tx) { tx.date = document.getElementById(`input-sale-date-${uuid}`).value; tx.shares = parseFloat(document.getElementById(`input-sale-shares-${uuid}`).value); tx.price = parseFloat(document.getElementById(`input-sale-price-${uuid}`).value); saveData(); renderPortfolio(); } };
        window.handleUpdateStockId = (sanitizedCycleId, oldStockId) => { const newStockId = document.getElementById(`input-stockId-${sanitizedCycleId}`).value.trim(); if (newStockId && newStockId !== oldStockId) { portfolio.forEach(tx => { if (tx.id === oldStockId) { tx.id = newStockId; } }); if (sales[oldStockId]) { if (sales[newStockId]) { sales[newStockId] = sales[newStockId].concat(sales[oldStockId]); } else { sales[newStockId] = sales[oldStockId]; } delete sales[oldStockId]; } if (feeSettings[oldStockId]) { feeSettings[newStockId] = feeSettings[oldStockId]; delete feeSettings[oldStockId]; } if (settings.manualOverrides[oldStockId]) { settings.manualOverrides[newStockId] = settings.manualOverrides[oldStockId]; delete settings.manualOverrides[oldStockId]; } saveData(); renderPortfolio(); } else { hideEditStockIdForm(sanitizedCycleId); } }
        window.showEditDividendForm = (sanitizedCycleId, stockId) => { document.getElementById(`dividend-display-${sanitizedCycleId}`).classList.add('hidden'); document.getElementById(`dividend-edit-${sanitizedCycleId}`).classList.remove('hidden'); lucide.createIcons(); }
        window.hideEditDividendForm = (sanitizedCycleId) => { document.getElementById(`dividend-display-${sanitizedCycleId}`).classList.remove('hidden'); document.getElementById(`dividend-edit-${sanitizedCycleId}`).classList.add('hidden'); }
        window.handleUpdateProjectedDividend = (stockId, sanitizedCycleId) => { const inputEl = document.getElementById(`input-dividend-${sanitizedCycleId}`); const newDividend = parseFloat(inputEl.value); if (!isNaN(newDividend)) { if (!settings.manualOverrides[stockId]) settings.manualOverrides[stockId] = {}; settings.manualOverrides[stockId].projected = newDividend; saveData(); renderPortfolio(); } else { hideEditDividendForm(sanitizedCycleId); } }
        window.handleResetProjectedDividend = (stockId) => { if (settings.manualOverrides[stockId]?.projected !== undefined) { delete settings.manualOverrides[stockId].projected; saveData(); renderPortfolio(); showToast(`已將 ${stockId} 的預計利息恢復為自動計算。`); } }
        window.showEditDividendRow = (sanitizedCycleId, stockId, originalDate) => { document.getElementById(`div-display-${sanitizedCycleId}-${originalDate}`).classList.add('hidden'); document.getElementById(`div-edit-${sanitizedCycleId}-${originalDate}`).classList.remove('hidden'); lucide.createIcons(); }
        window.hideEditDividendRow = (sanitizedCycleId, originalDate) => { document.getElementById(`div-display-${sanitizedCycleId}-${originalDate}`).classList.remove('hidden'); document.getElementById(`div-edit-${sanitizedCycleId}-${originalDate}`).classList.add('hidden'); }
        window.handleUpdateIndividualDividend = (stockId, originalDate, sanitizedCycleId) => { const dateInputEl = document.getElementById(`input-div-date-${sanitizedCycleId}-${originalDate}`); const amountInputEl = document.getElementById(`input-div-amount-${sanitizedCycleId}-${originalDate}`); const newDate = dateInputEl.value; const newAmount = parseFloat(amountInputEl.value); if (newDate && !isNaN(newAmount)) { if (!settings.manualOverrides[stockId]) settings.manualOverrides[stockId] = {}; if (!settings.manualOverrides[stockId].dividends) settings.manualOverrides[stockId].dividends = {}; settings.manualOverrides[stockId].dividends[originalDate] = { newDate, newAmount }; saveData(); renderPortfolio(); } else { hideEditDividendRow(sanitizedCycleId, originalDate); } }
        window.handleResetIndividualDividend = (stockId, originalDate) => { if (settings.manualOverrides[stockId]?.dividends?.[originalDate] !== undefined) { delete settings.manualOverrides[stockId].dividends[originalDate]; saveData(); renderPortfolio(); showToast(`已將 ${stockId} 於 ${originalDate} 的股利恢復為自動計算。`); } }
        window.handleDeleteIndividualDividend = (stockId, originalDate) => { if (!settings.manualOverrides[stockId]) settings.manualOverrides[stockId] = {}; if (!settings.manualOverrides[stockId].dividends) settings.manualOverrides[stockId].dividends = {}; settings.manualOverrides[stockId].dividends[originalDate] = { deleted: true }; saveData(); renderPortfolio(); showToast(`已刪除 ${stockId} 於 ${originalDate} 的股利紀錄。`); }
        window.handleResetAllDividendsForStock = (stockId) => { portfolio.forEach(tx => { if (tx.id === stockId) { tx.manualDividends = []; } }); if (settings.manualOverrides[stockId]?.dividends) { delete settings.manualOverrides[stockId].dividends; } saveData(); renderPortfolio(); showToast(`已將 ${stockId} 的所有股利紀錄恢復為自動計算。`); }
        window.showEditFeeForm = (sanitizedCycleId, stockId) => { document.getElementById(`fee-display-${sanitizedCycleId}`).classList.add('hidden'); document.getElementById(`fee-edit-${sanitizedCycleId}`).classList.remove('hidden'); lucide.createIcons(); }
        window.hideEditFeeForm = (sanitizedCycleId) => { document.getElementById(`fee-display-${sanitizedCycleId}`).classList.remove('hidden'); document.getElementById(`fee-edit-${sanitizedCycleId}`).classList.add('hidden'); }
        window.handleUpdateFee = (stockId, sanitizedCycleId) => { const newFee = parseFloat(document.getElementById(`input-fee-${sanitizedCycleId}`).value); if (!isNaN(newFee)) { feeSettings[stockId] = newFee; saveData(); renderPortfolio(); } else { hideEditFeeForm(sanitizedCycleId); } }
        window.handleResetFee = (stockId) => { if (feeSettings[stockId] !== undefined) { delete feeSettings[stockId]; saveData(); renderPortfolio(); showToast(`已將 ${stockId} 的手續費恢復為預設值。`); } }
        function showToast(message, isError = false) { toastMessage.textContent = message; toast.className = `p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`; toast.style.top = '20px'; setTimeout(() => { toast.style.top = '-100px'; }, 3000); }
        function parseAndFormatDate(dateStr) { if (!dateStr) return null; let date = new Date(dateStr.replace(/\//g, '-')); if (!isNaN(date.getTime())) { return date.toISOString().split('T')[0]; } const minguoMatch = dateStr.match(/(\d{2,3})[.\/](\d{1,2})[.\/](\d{1,2})/); if (minguoMatch) { const year = parseInt(minguoMatch[1]) + 1911; const month = parseInt(minguoMatch[2]); const day = parseInt(minguoMatch[3]); date = new Date(year, month - 1, day); if (!isNaN(date.getTime())) { return date.toISOString().split('T')[0]; } } return null; }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0]; if (!file) return;
            imageUploadText.textContent = '辨識中...'; imageUploadLoader.classList.remove('hidden');
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64ImageData = reader.result.split(',')[1];
                try {
                    const prompt = `你是一位極度嚴謹且精確的台灣股市交易紀錄辨識AI。你的**首要且不可違背的任務**是，只要圖片中含有看似「買進」、「賣出」或「成交日期」的任何紀錄，就**必須**建立一筆交易資料，確保零遺漏。\n\n**核心辨識流程與鐵則：**\n\n1.  **強制擷取，零遺漏 (最高優先級)**: 只要圖片中的某一列含有「日期」和任何數字（如價格、股數、金額），就**必須**將其視為一筆交易紀錄進行處理。**絕對不可以因為資訊不完整、格式不標準或不確定而丟棄任何一筆可能的交易紀錄。**\n\n2.  **辨識交易類型**: 盡力判斷每一筆紀錄是「買進」還是「賣出」。如果圖片中沒有明確標示，請**一律預設為「買進」** (\`buy\`)。\n\n3.  **嚴格的股名與代碼匹配**: \n    * **步驟 A (辨識)**: 首先，精確地辨識出圖片中的「股票名稱」。\n    * **步驟 B (查詢)**: 接著，用你辨識出的名稱去查詢其在台灣股市中**唯一且完全符合**的官方股票代碼。\n    * **步驟 C (輸出)**: \n        * **如果查詢成功**：將 \`stockTicker\` 欄位設定為找到的官方股票代碼 (例如: "00878")。\n        * **如果查詢失敗**：將 \`stockTicker\` 欄位設定為 **你在步驟 A 中辨識出的原始名稱**，並在後面附加上 \`(需手動更正)\`。例如，如果辨識到 "凱基優選"，但找不到代碼，就回傳 "凱基優選(需手動更正)"。\n\n4. **避免重複**: 在單次辨識任務中，如果發現多筆完全相同的交易紀錄（股票名稱、日期、張數、價格完全一樣），請只回傳一筆。\n\n**提取資訊的詳細規則：**\n\n* **type (交易類型)**: 字串格式，必須是 \`"buy"\` 或 \`"sell"\`。\n* **stockTicker (股票代碼)**：嚴格遵守上述第3點規則的輸出格式。\n* **date (交易日期)**：將圖片中的日期（可能是民國年或西元年）一律轉換為標準西元年格式 \`"YYYY-MM-DD"\`。\n* **shares (張數)**：輸出的單位必須是「張」。如果圖片單位是「股」，請將其數值除以1000。\n* **price (成交單價)**：每股的成交單價。\n\n**輸出格式：**\n請將所有辨識出的交易，以一個 JSON 陣列格式回傳。每一筆交易都是一個物件。\n\n如果整張圖真的完全沒有任何可辨識的交易資訊，才回傳一個空的 JSON 陣列 \`[]\`。`;
                    const payload = { contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: file.type, data: base64ImageData } } ] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { type: { type: "STRING", enum: ["buy", "sell"] }, stockTicker: { type: "STRING" }, date: { type: "STRING" }, shares: { type: "NUMBER" }, price: { type: "NUMBER" } }, required: ["type", "stockTicker", "date", "shares", "price"] } } } };
                    const apiKey = "AIzaSyBsLRa-hBR4jb42QvDdqp-vUxb2Ks0_pV8"; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { const errorData = await response.json().catch(() => null); const message = errorData?.error?.message || `API 請求失敗，狀態碼: ${response.status}`; throw new Error(message); }
                    const result = await response.json();
                    if (result.candidates?.[0]?.content?.parts?.[0]) {
                        const jsonText = result.candidates[0].content.parts[0].text;
                        const transactions = JSON.parse(jsonText);
                        let addedCount = 0; let skippedCount = 0;
                        if (transactions.length > 0) {
                            transactions.forEach(tx => {
                                const formattedDate = parseAndFormatDate(tx.date); const stockId = tx.stockTicker.trim(); const shares = parseFloat(tx.shares); const price = parseFloat(tx.price);
                                if (!stockId || !formattedDate || isNaN(shares) || isNaN(price)) { console.warn("Skipping invalid transaction from image:", tx); return; }
                                let isDuplicate = false;
                                if (tx.type === 'buy') { isDuplicate = portfolio.some(existingTx => existingTx.id === stockId && existingTx.date === formattedDate && existingTx.shares === shares && existingTx.price === price);
                                } else if (tx.type === 'sell') { const existingSales = sales[stockId] || []; isDuplicate = existingSales.some(existingTx => existingTx.date === formattedDate && existingTx.shares === shares && existingTx.price === price); }
                                if (isDuplicate) { skippedCount++; return; }
                                if (tx.type === 'buy') { const newStock = { uuid: self.crypto.randomUUID(), id: stockId, date: formattedDate, shares: shares, price: price, manualDividends: [] }; portfolio.push(newStock); addedCount++;
                                } else if (tx.type === 'sell') { if (stockId.includes('(需手動更正)')) { showToast(`一筆賣出紀錄 "${stockId.replace('(需手動更正)','')}" 因無法識別代碼，需手動新增。`, true); } else { const newSale = { uuid: self.crypto.randomUUID(), date: formattedDate, shares: shares, price: price }; if (!sales[stockId]) { sales[stockId] = []; } sales[stockId].push(newSale); addedCount++; } }
                            });
                            let messages = [];
                            if (addedCount > 0) messages.push(`成功新增 ${addedCount} 筆紀錄`);
                            if (skippedCount > 0) messages.push(`略過 ${skippedCount} 筆重複紀錄`);
                            if (messages.length > 0) { saveData(); renderPortfolio(); showToast(messages.join('，') + '。'); } else { showToast('圖片中的紀錄皆為重複或無效資料。', true); }
                        } else { showToast('圖片中未找到可辨識的交易紀錄。', true); }
                    } else { throw new Error('無法解析 API 回應。可能是 API 金鑰問題或圖片內容無法辨識。'); }
                } catch (error) { console.error('圖片辨識失敗:', error); showToast(`圖片辨識失敗: ${error.message}`, true); } finally { imageUploadText.textContent = '圖片輸入'; imageUploadLoader.classList.add('hidden'); imageUploadInput.value = ''; }
            };
            reader.readAsDataURL(file);
        }

        function saveData() { localStorage.setItem('stockPortfolio', JSON.stringify(portfolio)); localStorage.setItem('stockSales', JSON.stringify(sales)); localStorage.setItem('stockFeeSettings', JSON.stringify(feeSettings)); localStorage.setItem('stockSettings', JSON.stringify(settings)); }
        function loadData() { const savedPortfolio = localStorage.getItem('stockPortfolio'); const savedSales = localStorage.getItem('stockSales'); const savedFeeSettings = localStorage.getItem('stockFeeSettings'); const savedSettings = localStorage.getItem('stockSettings'); if (savedPortfolio) portfolio = JSON.parse(savedPortfolio); if (savedSales) sales = JSON.parse(savedSales); if (savedFeeSettings) feeSettings = JSON.parse(savedFeeSettings); if (savedSettings) { settings = JSON.parse(savedSettings); fiscalYearStartSelect.value = settings.fiscalYearStart || 1; if (!settings.manualOverrides) settings.manualOverrides = {}; if (!settings.targetProfits) settings.targetProfits = {}; if (!settings.financialPlan) settings.financialPlan = {}; if (settings.hideZeroGainRows === undefined) settings.hideZeroGainRows = false; } }
        function init() { 
            loadData(); 
            renderPortfolio(); 
            addStockForm.addEventListener('submit', handleAddStock); 
            fiscalYearStartSelect.addEventListener('change', handleSettingsChange); 
            addDividendForm.addEventListener('submit', handleAddDividend); 
            cancelAddDividendBtn.addEventListener('click', hideAddDividendModal); 
            imageUploadInput.addEventListener('change', handleImageUpload); 
            generatePlanBtn.addEventListener('click', handleGeneratePlan); 
            deleteAllBtn.addEventListener('click', () => confirmDeleteModal.classList.remove('hidden'));
            cancelDeleteAllBtn.addEventListener('click', () => confirmDeleteModal.classList.add('hidden'));
            confirmDeleteAllBtn.addEventListener('click', () => {
                portfolio = [];
                sales = {};
                feeSettings = {};
                settings.manualOverrides = {};
                settings.targetProfits = {};
                saveData();
                renderPortfolio();
                confirmDeleteModal.classList.add('hidden');
                showToast('已刪除所有紀錄。');
            });
            hideZeroGainRowsCheckbox.addEventListener('change', (e) => {
                settings.hideZeroGainRows = e.target.checked;
                saveData();
                renderPortfolio();
            });
            toggleCompactModeBtn.addEventListener('click', () => { settings.isCompactMode = !settings.isCompactMode; if (settings.isCompactMode) { toggleCompactModeBtn.innerHTML = `<i data-lucide="layout-grid" class="mr-2 h-4 w-4"></i><span>卡片模式</span>`; } else { toggleCompactModeBtn.innerHTML = `<i data-lucide="list" class="mr-2 h-4 w-4"></i><span>精簡模式</span>`; } lucide.createIcons(); saveData(); renderPortfolio(); }); 
            toggleHistoryCompactModeBtn.addEventListener('click', () => { settings.isHistoryCompactMode = !settings.isHistoryCompactMode; if (settings.isHistoryCompactMode) { toggleHistoryCompactModeBtn.innerHTML = `<i data-lucide="layout-grid" class="mr-2 h-4 w-4"></i><span>卡片模式</span>`; } else { toggleHistoryCompactModeBtn.innerHTML = `<i data-lucide="list" class="mr-2 h-4 w-4"></i><span>精簡模式</span>`; } lucide.createIcons(); saveData(); renderPortfolio(); }); 
            document.getElementById('purchaseDate').valueAsDate = new Date(); 
        }
        init();
    </script>
</body>
</html>