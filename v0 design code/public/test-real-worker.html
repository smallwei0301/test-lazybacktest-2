<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸå¯¦ Worker ç’°å¢ƒæ¸¬è©¦</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .log {
            margin: 5px 0;
            padding: 8px;
            background: #252526;
            border-left: 3px solid #007acc;
            font-size: 12px;
        }

        .success {
            border-left-color: #4ec9b0;
        }

        .error {
            border-left-color: #f48771;
        }

        .warn {
            border-left-color: #dcdcaa;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007acc;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #005a9e;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        pre {
            background: #2d2d2d;
            padding: 10px;
            overflow-x: auto;
            max-height: 400px;
        }

        #status {
            font-size: 14px;
            margin: 10px 0;
            padding: 10px;
            background: #2d2d2d;
        }
    </style>
</head>

<body>
    <h1>çœŸå¯¦ Worker.js ç’°å¢ƒæ¸¬è©¦</h1>
    <p><strong>âš ï¸ æœ¬æ¸¬è©¦ä½¿ç”¨å¯¦éš›çš„ app/js/worker.js æ–‡ä»¶</strong></p>

    <div id="status">ç‹€æ…‹: æœªé–‹å§‹</div>

    <button onclick="clearDB()">1. æ¸…é™¤è³‡æ–™åº«</button>
    <button onclick="testWorker()" id="testBtn">2. æ¸¬è©¦ Worker</button>
    <button onclick="checkIDB()">3. æª¢æŸ¥ IndexedDB</button>

    <div id="output"></div>

    <script>
        let worker = null;
        let testRunning = false;

        function log(message, type = 'log') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            const timestamp = new Date().toISOString().substr(11, 12);
            div.textContent = `[${timestamp}] ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = `ç‹€æ…‹: ${text}`;
        }

        async function clearDB() {
            log('â”â”â” æ¸…é™¤è³‡æ–™åº« â”â”â”', 'log');
            updateStatus('æ¸…é™¤ä¸­...');

            const deleteRequest = indexedDB.deleteDatabase('LazyBacktestDB');
            deleteRequest.onsuccess = () => {
                log('âœ… è³‡æ–™åº«å·²æ¸…é™¤', 'success');
                updateStatus('è³‡æ–™åº«å·²æ¸…é™¤');
            };
            deleteRequest.onerror = () => {
                log('âŒ æ¸…é™¤è³‡æ–™åº«å¤±æ•—', 'error');
                updateStatus('æ¸…é™¤å¤±æ•—');
            };
        }

        async function testWorker() {
            if (testRunning) {
                log('âš ï¸ æ¸¬è©¦å·²åœ¨é‹è¡Œä¸­', 'warn');
                return;
            }

            log('â”â”â” é–‹å§‹æ¸¬è©¦çœŸå¯¦ Worker â”â”â”', 'log');
            updateStatus('æ¸¬è©¦ä¸­...');
            testRunning = true;
            document.getElementById('testBtn').disabled = true;

            try {
                // å‰µå»º Workerï¼ˆä½¿ç”¨ç›¸å°è·¯å¾‘æŒ‡å‘çœŸå¯¦çš„ worker.jsï¼‰
                worker = new Worker('app/js/worker.js');

                // ç›£è½ Worker æ¶ˆæ¯
                worker.onmessage = (e) => {
                    const { type, data } = e.data;

                    if (type === 'progress') {
                        log(`ğŸ“Š é€²åº¦: ${data}`, 'log');
                    } else if (type === 'result') {
                        log('âœ… Worker å›æ¸¬å®Œæˆ', 'success');
                        log(`ğŸ“ˆ æœ€çµ‚è³‡æœ¬: ${data.finalValue}`, 'log');
                        updateStatus('Worker åŸ·è¡Œå®Œæˆ');
                        testRunning = false;
                        document.getElementById('testBtn').disabled = false;

                        // ç­‰å¾…ä¸€ä¸‹è®“ IDB å¯«å…¥å®Œæˆ
                        setTimeout(() => {
                            log('ğŸ’¡ è«‹é»æ“Šã€Œ3. æª¢æŸ¥ IndexedDBã€æŸ¥çœ‹å¯«å…¥çµæœ', 'warn');
                        }, 500);
                    } else if (type === 'error') {
                        log(`âŒ Worker éŒ¯èª¤: ${data.message}`, 'error');
                        updateStatus('Worker éŒ¯èª¤');
                        testRunning = false;
                        document.getElementById('testBtn').disabled = false;
                    } else {
                        log(`ğŸ“¨ Worker æ¶ˆæ¯: ${type}`, 'log');
                    }
                };

                worker.onerror = (error) => {
                    log(`âŒ Worker éŒ¯èª¤: ${error.message}`, 'error');
                    updateStatus('Worker éŒ¯èª¤');
                    testRunning = false;
                    document.getElementById('testBtn').disabled = false;
                };

                // ç™¼é€ç°¡åŒ–çš„å›æ¸¬è«‹æ±‚çµ¦ Worker
                // é€™æœƒè§¸ç™¼ fetchStockDataï¼Œé€²è€Œè§¸ç™¼ç„¡æ•ˆè³‡æ–™åµæ¸¬å’Œ idbSetPermanentInvalid
                const params = {
                    stockNo: '2317',
                    startDate: '2024-12-03',
                    endDate: '2025-12-03',
                    initialCapital: 100000,
                    positionSize: 100,
                    strategy: 'ma_cross',
                    shortPeriod: 5,
                    longPeriod: 20,
                    market: 'TWSE',
                    splitAdjustment: false
                };

                log('ğŸ“¤ ç™¼é€å›æ¸¬è«‹æ±‚åˆ° Worker...', 'log');
                log(`ğŸ“ è‚¡ç¥¨: ${params.stockNo}, æ—¥æœŸ: ${params.startDate} ~ ${params.endDate}`, 'log');
                worker.postMessage(params);

            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                updateStatus('æ¸¬è©¦å¤±æ•—');
                testRunning = false;
                document.getElementById('testBtn').disabled = false;
            }
        }

        async function checkIDB() {
            log('â”â”â” æª¢æŸ¥ IndexedDB å…§å®¹ â”â”â”', 'log');
            updateStatus('æª¢æŸ¥ä¸­...');

            try {
                const request = indexedDB.open('LazyBacktestDB', 4);

                request.onerror = () => {
                    log('âŒ ç„¡æ³•é–‹å•Ÿè³‡æ–™åº«', 'error');
                    updateStatus('æª¢æŸ¥å¤±æ•—');
                };

                request.onsuccess = () => {
                    const db = request.result;
                    log(`âœ… è³‡æ–™åº«ç‰ˆæœ¬: ${db.version}`, 'success');
                    log(`ğŸ“‚ Object Stores: ${Array.from(db.objectStoreNames).join(', ')}`, 'log');

                    if (!db.objectStoreNames.contains('permanentInvalidDates')) {
                        log('âš ï¸ permanentInvalidDates store ä¸å­˜åœ¨', 'warn');
                        updateStatus('Store ä¸å­˜åœ¨');
                        db.close();
                        return;
                    }

                    const tx = db.transaction(['permanentInvalidDates'], 'readonly');
                    const store = tx.objectStore('permanentInvalidDates');
                    const getAllRequest = store.getAll();

                    getAllRequest.onsuccess = () => {
                        const records = getAllRequest.result;
                        log(`âœ… permanentInvalidDates ä¸­å…±æœ‰ ${records.length} ç­†è¨˜éŒ„`, 'success');

                        if (records.length > 0) {
                            const pre = document.createElement('pre');
                            pre.textContent = JSON.stringify(records, null, 2);
                            document.getElementById('output').appendChild(pre);

                            // æª¢æŸ¥ 2317|2025-07-30 æ˜¯å¦å­˜åœ¨
                            const target = records.find(r => r.id === '2317|2025-07-30');
                            if (target) {
                                log('ğŸ¯ æ‰¾åˆ°ç›®æ¨™è¨˜éŒ„: 2317|2025-07-30', 'success');
                                log(`   âœ… stockNo: ${target.stockNo}`, 'success');
                                log(`   âœ… date: ${target.date}`, 'success');
                                log(`   âœ… recordedAt: ${new Date(target.recordedAt).toISOString()}`, 'success');
                                updateStatus('âœ… æ¸¬è©¦æˆåŠŸï¼');
                            } else {
                                log('âš ï¸ æœªæ‰¾åˆ° 2317|2025-07-30 è¨˜éŒ„', 'warn');
                                updateStatus('æœªæ‰¾åˆ°ç›®æ¨™è¨˜éŒ„');
                            }
                        } else {
                            log('âš ï¸ æ²’æœ‰ä»»ä½•è¨˜éŒ„', 'warn');
                            updateStatus('æ²’æœ‰è¨˜éŒ„');
                        }
                    };

                    getAllRequest.onerror = () => {
                        log('âŒ è®€å–è¨˜éŒ„å¤±æ•—', 'error');
                        updateStatus('è®€å–å¤±æ•—');
                    };

                    tx.oncomplete = () => db.close();
                };
            } catch (error) {
                log(`âŒ æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
                updateStatus('æª¢æŸ¥å¤±æ•—');
            }
        }

        // åˆå§‹åŒ–æç¤º
        log('ğŸš€ çœŸå¯¦ Worker æ¸¬è©¦å·¥å…·å·²å°±ç·’', 'log');
        log('ğŸ’¡ æ¸¬è©¦æ­¥é©Ÿ:', 'log');
        log('   1. é»æ“Šã€Œæ¸…é™¤è³‡æ–™åº«ã€', 'log');
        log('   2. é»æ“Šã€Œæ¸¬è©¦ Workerã€ä¸¦ç­‰å¾…å®Œæˆ', 'log');
        log('   3. é»æ“Šã€Œæª¢æŸ¥ IndexedDBã€æŸ¥çœ‹çµæœ', 'log');
        log('', 'log');
        log('ğŸ“Œ æ³¨æ„: è«‹ç¢ºä¿åœ¨ Console ä¸­æŸ¥çœ‹æ‰€æœ‰ Worker æ—¥èªŒ', 'warn');
        updateStatus('å°±ç·’');
    </script>
</body>

</html>