<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸå¯¦ Worker ç’°å¢ƒ IDB æ¸¬è©¦</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .log {
            margin: 5px 0;
            padding: 8px;
            background: #252526;
            border-left: 3px solid #007acc;
            font-size: 12px;
        }

        .success {
            border-left-color: #4ec9b0;
        }

        .error {
            border-left-color: #f48771;
        }

        .warn {
            border-left-color: #dcdcaa;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007acc;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #005a9e;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        pre {
            background: #2d2d2d;
            padding: 10px;
            overflow-x: auto;
            max-height: 400px;
        }

        #status {
            font-size: 14px;
            margin: 10px 0;
            padding: 10px;
            background: #2d2d2d;
        }
    </style>
</head>

<body>
    <h1>âœ… çœŸå¯¦ Worker ç’°å¢ƒ IDB æ¸¬è©¦</h1>
    <p><strong>æœ¬æ¸¬è©¦ä½¿ç”¨å¯¦éš›çš„ app/js/worker.js æ–‡ä»¶</strong></p>
    <p><strong>âš ï¸ ä¸éœ€è¦ Proxyï¼Œç›´æ¥æ¸¬è©¦ IDB å¯«å…¥åŠŸèƒ½</strong></p>

    <div id="status">ç‹€æ…‹: æœªé–‹å§‹</div>

    <button onclick="clearDB()">1. æ¸…é™¤è³‡æ–™åº«</button>
    <button onclick="testWorkerIDB()" id="testBtn">2. æ¸¬è©¦ Worker IDB</button>
    <button onclick="checkIDB()">3. æª¢æŸ¥ IndexedDB</button>

    <div id="output"></div>

    <script>
        let worker = null;

        function log(message, type = 'log') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            const timestamp = new Date().toISOString().substr(11, 12);
            div.textContent = `[${timestamp}] ${message}`;
            output.appendChild(div);
            console.log(message);
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = `ç‹€æ…‹: ${text}`;
        }

        async function clearDB() {
            log('â”â”â” æ¸…é™¤è³‡æ–™åº« â”â”â”', 'log');
            updateStatus('æ¸…é™¤ä¸­...');

            const deleteRequest = indexedDB.deleteDatabase('LazyBacktestDB');
            deleteRequest.onsuccess = () => {
                log('âœ… è³‡æ–™åº«å·²æ¸…é™¤', 'success');
                updateStatus('è³‡æ–™åº«å·²æ¸…é™¤');
            };
            deleteRequest.onerror = () => {
                log('âŒ æ¸…é™¤è³‡æ–™åº«å¤±æ•—', 'error');
                updateStatus('æ¸…é™¤å¤±æ•—');
            };
        }

        async function testWorkerIDB() {
            log('â”â”â” é–‹å§‹æ¸¬è©¦çœŸå¯¦ Worker IDB â”â”â”', 'log');
            log('âš ï¸ è«‹åœ¨ Console ä¸­æŸ¥çœ‹æ‰€æœ‰èª¿è©¦æ—¥èªŒï¼', 'warn');
            updateStatus('æ¸¬è©¦ä¸­...');
            document.getElementById('testBtn').disabled = true;

            try {
                // å‰µå»ºçœŸå¯¦çš„ Worker
                worker = new Worker('app/js/worker.js');

                // ç›£è½ Worker æ¶ˆæ¯
                worker.onmessage = (e) => {
                    const { type, data } = e.data;

                    if (type === 'testIDBResult') {
                        log('âœ… Worker IDB æ¸¬è©¦å®Œæˆ', 'success');
                        log(`ğŸ“Š çµæœ: ${JSON.stringify(data.results, null, 2)}`, 'log');

                        // æª¢æŸ¥æ¯å€‹æ¸¬è©¦çµæœ
                        data.results.forEach(r => {
                            if (r.success) {
                                log(`âœ… ${r.stockNo} ${r.date} - æˆåŠŸ`, 'success');
                            } else {
                                log(`âŒ ${r.stockNo} ${r.date} - å¤±æ•—: ${r.error}`, 'error');
                            }
                        });

                        updateStatus('Worker æ¸¬è©¦å®Œæˆ');
                        document.getElementById('testBtn').disabled = false;

                        log('ğŸ’¡ è«‹é»æ“Šã€Œ3. æª¢æŸ¥ IndexedDBã€æŸ¥çœ‹çµæœ', 'warn');
                    } else if (type === 'error') {
                        log(`âŒ Worker éŒ¯èª¤: ${data.message}`, 'error');
                        updateStatus('Worker éŒ¯èª¤');
                        document.getElementById('testBtn').disabled = false;
                    }
                };

                worker.onerror = (error) => {
                    log(`âŒ Worker éŒ¯èª¤: ${error.message}`, 'error');
                    updateStatus('Worker éŒ¯èª¤');
                    document.getElementById('testBtn').disabled = false;
                };

                // ç™¼é€æ¸¬è©¦æ¶ˆæ¯çµ¦ Worker
                log('ğŸ“¤ ç™¼é€ testIDB æ¶ˆæ¯åˆ° Worker...', 'log');
                worker.postMessage({
                    type: 'testIDB',
                    testCases: [
                        { stockNo: '2317', date: '2025-07-30' },
                        { stockNo: '2330', date: '2025-08-15' },
                        { stockNo: '2412', date: '2025-09-01' }
                    ]
                });

            } catch (error) {
                log(`âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                updateStatus('æ¸¬è©¦å¤±æ•—');
                document.getElementById('testBtn').disabled = false;
            }
        }

        async function checkIDB() {
            log('â”â”â” æª¢æŸ¥ IndexedDB å…§å®¹ â”â”â”', 'log');
            updateStatus('æª¢æŸ¥ä¸­...');

            try {
                const request = indexedDB.open('LazyBacktestDB', 4);

                request.onerror = () => {
                    log('âŒ ç„¡æ³•é–‹å•Ÿè³‡æ–™åº«', 'error');
                    updateStatus('æª¢æŸ¥å¤±æ•—');
                };

                request.onsuccess = () => {
                    const db = request.result;
                    log(`âœ… è³‡æ–™åº«ç‰ˆæœ¬: ${db.version}`, 'success');
                    log(`ğŸ“‚ Object Stores: ${Array.from(db.objectStoreNames).join(', ')}`, 'log');

                    if (!db.objectStoreNames.contains('permanentInvalidDates')) {
                        log('âš ï¸ permanentInvalidDates store ä¸å­˜åœ¨', 'warn');
                        updateStatus('Store ä¸å­˜åœ¨');
                        db.close();
                        return;
                    }

                    const tx = db.transaction(['permanentInvalidDates'], 'readonly');
                    const store = tx.objectStore('permanentInvalidDates');
                    const getAllRequest = store.getAll();

                    getAllRequest.onsuccess = () => {
                        const records = getAllRequest.result;
                        log(`âœ… permanentInvalidDates ä¸­å…±æœ‰ ${records.length} ç­†è¨˜éŒ„`, 'success');

                        if (records.length > 0) {
                            const pre = document.createElement('pre');
                            pre.textContent = JSON.stringify(records, null, 2);
                            document.getElementById('output').appendChild(pre);

                            // æª¢æŸ¥ç›®æ¨™è¨˜éŒ„
                            const targets = [
                                '2317|2025-07-30',
                                '2330|2025-08-15',
                                '2412|2025-09-01'
                            ];

                            let allFound = true;
                            targets.forEach(targetId => {
                                const record = records.find(r => r.id === targetId);
                                if (record) {
                                    log(`ğŸ¯ âœ… æ‰¾åˆ°: ${targetId}`, 'success');
                                } else {
                                    log(`âš ï¸ æœªæ‰¾åˆ°: ${targetId}`, 'warn');
                                    allFound = false;
                                }
                            });

                            if (allFound) {
                                log('ğŸ‰ æ‰€æœ‰æ¸¬è©¦è¨˜éŒ„éƒ½å·²æˆåŠŸå¯«å…¥ï¼', 'success');
                                updateStatus('âœ… æ¸¬è©¦å®Œå…¨æˆåŠŸï¼');
                            } else {
                                updateStatus('âš ï¸ éƒ¨åˆ†è¨˜éŒ„ç¼ºå¤±');
                            }
                        } else {
                            log('âš ï¸ æ²’æœ‰ä»»ä½•è¨˜éŒ„', 'warn');
                            updateStatus('æ²’æœ‰è¨˜éŒ„');
                        }
                    };

                    getAllRequest.onerror = () => {
                        log('âŒ è®€å–è¨˜éŒ„å¤±æ•—', 'error');
                        updateStatus('è®€å–å¤±æ•—');
                    };

                    tx.oncomplete = () => db.close();
                };
            } catch (error) {
                log(`âŒ æª¢æŸ¥å¤±æ•—: ${error.message}`, 'error');
                updateStatus('æª¢æŸ¥å¤±æ•—');
            }
        }

        // åˆå§‹åŒ–
        log('ğŸš€ çœŸå¯¦ Worker IDB æ¸¬è©¦å·¥å…·å·²å°±ç·’', 'log');
        log('ğŸ’¡ æ¸¬è©¦æ­¥é©Ÿ:', 'log');
        log('   1. é»æ“Šã€Œæ¸…é™¤è³‡æ–™åº«ã€', 'log');
        log('   2. é»æ“Šã€Œæ¸¬è©¦ Worker IDBã€', 'log');
        log('   3. é»æ“Šã€Œæª¢æŸ¥ IndexedDBã€', 'log');
        log('', 'log');
        log('ğŸ“Œ æœ¬æ¸¬è©¦ä½¿ç”¨çœŸå¯¦çš„ worker.jsï¼Œæ‡‰è©²èƒ½çœ‹åˆ°ï¼š', 'warn');
        log('   â€¢ [Worker IDB Debug] idbSetPermanentInvalid called for...', 'log');
        log('   â€¢ [Worker IDB Debug] DB initialized: true', 'log');
        log('   â€¢ [Worker IDB Debug] Creating transaction...', 'log');
        log('   â€¢ [Worker IDB Debug] Put request created', 'log');
        log('   â€¢ [Worker IDB] å·²è¨˜éŒ„æ°¸ä¹…ç„¡æ•ˆæ—¥æœŸ...', 'log');
        updateStatus('å°±ç·’');
    </script>
</body>

</html>