<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡æ–™å­˜æ´»æ™‚é–“ (TTL) èˆ‡å„²å­˜æµå‘åˆ†æå ±å‘Š</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .mermaid {
            margin: 30px 0;
            text-align: center;
        }

        .highlight-box {
            background-color: #e8f4f8;
            border-left: 5px solid #3498db;
            padding: 15px;
            margin: 20px 0;
        }

        .dynamic-cache-box {
            background-color: #fff8e1;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>

<body>

    <h1>è³‡æ–™å­˜æ´»æ™‚é–“ (TTL) èˆ‡å„²å­˜æµå‘åˆ†æå ±å‘Š</h1>

    <blockquote>
        <p><strong>æ—¥æœŸ</strong>: 2025-12-03<br>
            <strong>åˆ†æå°è±¡</strong>: LazyBacktest å‰ç«¯è³‡æ–™å¿«å–æ©Ÿåˆ¶ (Worker, IndexedDB, LocalStorage) èˆ‡é›²ç«¯å¿«å– (Netlify Blob/Proxy)
        </p>
    </blockquote>

    <h2>1. è³‡æ–™å„²å­˜å±¤ç´šèˆ‡ TTL ç¸½è¦½</h2>

    <p>ç³»çµ±æ¡ç”¨ä¸‰ç´šå¿«å–æ¶æ§‹ï¼š<strong>è¨˜æ†¶é«” (Memory/Blob)</strong>ã€<strong>IndexedDB (IDB)</strong>ã€<strong>LocalStorage
            (LS)</strong>ï¼Œä¸¦æ­é…é›²ç«¯ <strong>Netlify Blob</strong> èˆ‡ <strong>Proxy å‹•æ…‹å¿«å–</strong> é€²è¡Œè³‡æ–™åˆ†æµã€‚</p>

    <h3>ğŸ“Š å„²å­˜å±¤ç´šå°ç…§è¡¨</h3>

    <table>
        <thead>
            <tr>
                <th>å„²å­˜ä½ç½®</th>
                <th>è³‡æ–™é¡å‹</th>
                <th>è®Šæ•¸/Key åç¨±</th>
                <th>TTL (å­˜æ´»æ™‚é–“)</th>
                <th>å‚™è¨»</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>LocalStorage</strong></td>
                <td>å°è‚¡åç¨±å¿«å–</td>
                <td><code>LB_TW_NAME_CACHE_...</code></td>
                <td><strong>7 å¤©</strong></td>
                <td><code>LOCAL_STOCK_NAME_CACHE_TTL_MS</code></td>
            </tr>
            <tr>
                <td><strong>LocalStorage</strong></td>
                <td>ç¾è‚¡åç¨±å¿«å–</td>
                <td><code>LB_US_NAME_CACHE_...</code></td>
                <td><strong>3 å¤©</strong></td>
                <td><code>LOCAL_US_NAME_CACHE_TTL_MS</code></td>
            </tr>
            <tr>
                <td><strong>LocalStorage</strong></td>
                <td>å°è‚¡å®˜æ–¹æ¸…å–®</td>
                <td><code>LB_TW_DIRECTORY_CACHE_...</code></td>
                <td><strong>24 å°æ™‚</strong></td>
                <td><code>TAIWAN_DIRECTORY_CACHE_TTL_MS</code></td>
            </tr>
            <tr>
                <td><strong>IndexedDB</strong></td>
                <td>æ°¸ä¹…ç„¡æ•ˆæ—¥æœŸ</td>
                <td><code>permanentInvalidDates</code></td>
                <td><strong>24 å°æ™‚</strong></td>
                <td><code>PERMANENT_INVALID_TTL_MS</code></td>
            </tr>
            <tr>
                <td><strong>IndexedDB</strong></td>
                <td>é‚„åŸè‚¡åƒ¹å¿«å–</td>
                <td><code>stock_cache</code> (ADJ)</td>
                <td><strong>24 å°æ™‚</strong></td>
                <td><code>IDB_ADJ_TTL_MS</code></td>
            </tr>
            <tr>
                <td><strong>IndexedDB</strong></td>
                <td>å¹´åº¦è³‡æ–™æ¡¶</td>
                <td><code>SUP|...</code> (Year Superset)</td>
                <td><strong>7 å¤©</strong></td>
                <td><code>NON_CURRENT_MONTH_STALE_REVALIDATE_MS</code></td>
            </tr>
            <tr>
                <td><strong>Memory (Worker)</strong></td>
                <td>è£œé½Šå˜—è©¦è¨˜éŒ„</td>
                <td><code>patchAttemptCache</code></td>
                <td><strong>5 åˆ†é˜ / 1 å°æ™‚</strong></td>
                <td>åŒæ—¥ 5 åˆ† / ç¼ºäº¤æ˜“ 1 å°æ™‚</td>
            </tr>
            <tr>
                <td><strong>Memory (Worker)</strong></td>
                <td>è‚¡ç¥¨åç¨±æŸ¥æ‰¾</td>
                <td><code>stockNameLookupCache</code></td>
                <td><strong>12 å°æ™‚</strong></td>
                <td><code>STOCK_NAME_CACHE_TTL_MS</code></td>
            </tr>
            <tr>
                <td><strong>Memory (Worker)</strong></td>
                <td>ç•¶æœˆè³‡æ–™é©—è­‰</td>
                <td><code>workerMonthlyCache</code></td>
                <td><strong>18 å°æ™‚ (TW) / 12 å°æ™‚ (US)</strong></td>
                <td><code>MONTH_STALE_REVALIDATE_...</code></td>
            </tr>
            <tr>
                <td><strong>Cloud (Blob)</strong></td>
                <td>ç•¶æœˆè³‡æ–™å¿«å–</td>
                <td><code>twse_cache_store</code></td>
                <td><strong>24 å°æ™‚</strong></td>
                <td><code>TWSE_MONTH_TTL_MS</code> (stock-range.js)</td>
            </tr>
            <tr>
                <td><strong>Cloud (Blob)</strong></td>
                <td>å¹´åº¦è³‡æ–™å¿«å–</td>
                <td><code>stock_year_cache_store</code></td>
                <td><strong>2~3 å¤©</strong></td>
                <td>TWSE: 3å¤© / TPEX: 2å¤©</td>
            </tr>
            <tr>
                <td><strong>Cloud (Proxy)</strong></td>
                <td>å‹•æ…‹åˆ†ç´šå¿«å–</td>
                <td><code>Cache-Control</code> Header</td>
                <td><strong>1 å°æ™‚ / 1 å¹´</strong></td>
                <td>ä¾æ“šè³‡æ–™æ˜¯å¦ç‚ºæ­·å²è³‡æ–™å‹•æ…‹èª¿æ•´</td>
            </tr>
        </tbody>
    </table>

    <hr>

    <h2>2. é›²ç«¯å‹•æ…‹åˆ†ç´šå¿«å– (Dynamic Caching Strategy)</h2>

    <div class="dynamic-cache-box">
        <h3>ğŸš€ ç™¼ç¾ï¼šProxy å¯¦ä½œäº†ã€Œå‹•æ…‹åˆ†ç´šå¿«å–ã€ç­–ç•¥</h3>
        <p>åœ¨ <code>twse-proxy.js</code>, <code>tpex-proxy.js</code>, <code>us-proxy.js</code>
            ä¸­ï¼Œç³»çµ±æœƒæ ¹æ“šè«‹æ±‚çš„è³‡æ–™ç¯„åœæ˜¯å¦ç‚ºã€Œæ­·å²è³‡æ–™ã€ä¾†å‹•æ…‹è¨­å®š HTTP <code>Cache-Control</code> Headerã€‚</p>
    </div>

    <ul>
        <li><strong>åˆ¤æ–·é‚è¼¯</strong>: æª¢æŸ¥è«‹æ±‚çš„ <code>endDate</code> æ˜¯å¦å°æ–¼ <code>today</code> (ç•¶æ—¥é›¶æ™‚)ã€‚</li>
        <li><strong>æ­·å²è³‡æ–™ (Historical Data)</strong>:
            <ul>
                <li><strong>æ¢ä»¶</strong>: <code>endDate < today</code></li>
                <li><strong>TTL</strong>: <strong>1 å¹´ (31536000s)</strong></li>
                <li><strong>Header</strong>: <code>public, max-age=31536000, s-maxage=31536000, immutable</code></li>
                <li><strong>ç›®çš„</strong>: æ­·å²è³‡æ–™ä¸æœƒè®Šå‹•ï¼Œè¨­å®šæ¥µé•· TTL ä¸¦æ¨™è¨˜ <code>immutable</code> ä»¥æœ€å¤§åŒ– CDN å¿«å–æ•ˆç›Šã€‚</li>
            </ul>
        </li>
        <li><strong>ç•¶å‰/è¿‘æœŸè³‡æ–™ (Current Data)</strong>:
            <ul>
                <li><strong>æ¢ä»¶</strong>: <code>endDate >= today</code></li>
                <li><strong>TTL</strong>: <strong>1 å°æ™‚ (3600s)</strong></li>
                <li><strong>Header</strong>: <code>public, max-age=3600, s-maxage=3600</code></li>
                <li><strong>ç›®çš„</strong>: è¿‘æœŸè³‡æ–™å¯èƒ½éš¨ç›¤ä¸­æˆ–ç›¤å¾Œæ›´æ–°ï¼Œè¨­å®šè¼ƒçŸ­ TTL (1å°æ™‚) ä»¥ç¢ºä¿è³‡æ–™æ–°é®®åº¦ã€‚</li>
            </ul>
        </li>
    </ul>

    <hr>

    <h2>3. IDB è³‡æ–™åˆ†æµç¢ºèª (Historical vs Current)</h2>

    <div class="highlight-box">
        <h3>âœ… ç¢ºèªçµæœï¼šIndexedDB ç¢ºå¯¦æ¡ç”¨åˆ†æµå„²å­˜ç­–ç•¥</h3>
        <p>ç¶“ç¨‹å¼ç¢¼åˆ†æï¼Œç³»çµ±å°‡è³‡æ–™åˆ†ç‚ºã€Œæ­·å²è³‡æ–™ã€èˆ‡ã€Œç•¶æœˆ/è¿‘æœŸè³‡æ–™ã€ï¼Œä¸¦åˆ†åˆ¥å„²å­˜æ–¼ä¸åŒçš„ IDB çµæ§‹ä¸­ï¼Œæ“æœ‰ç¨ç«‹çš„ TTL è¨­å®šã€‚</p>
    </div>

    <h3>ğŸ“… æ­·å²è³‡æ–™ (Historical Data)</h3>
    <ul>
        <li><strong>å„²å­˜çµæ§‹</strong>: <code>Year Superset</code> (å¹´åº¦è³‡æ–™æ¡¶)</li>
        <li><strong>Key æ ¼å¼</strong>: <code>SUP|{Market}|{Stock}|{Year}|...</code></li>
        <li><strong>TTL</strong>: <strong>7 å¤©</strong> (<code>NON_CURRENT_MONTH_STALE_REVALIDATE_MS</code>)</li>
        <li><strong>æ©Ÿåˆ¶</strong>: é€é <code>idbSetYearSuperset</code> å¯«å…¥ï¼Œ<code>idbGetYearSuperset</code> è®€å–ã€‚</li>
    </ul>

    <h3>ğŸ“† ç•¶æœˆ/è¿‘æœŸè³‡æ–™ (Current Month Data)</h3>
    <ul>
        <li><strong>å„²å­˜çµæ§‹</strong>: <code>stock_cache</code> (ä¸€èˆ¬å¿«å–)</li>
        <li><strong>Key æ ¼å¼</strong>: <code>{Market}|{Stock}|{DateRange}...</code></li>
        <li><strong>TTL</strong>: <strong>18 å°æ™‚ (TW) / 12 å°æ™‚ (US)</strong> (<code>MONTH_STALE_REVALIDATE_...</code>)
        </li>
        <li><strong>æ©Ÿåˆ¶</strong>: é€é <code>setWorkerCacheEntry</code> (å‘¼å« <code>idbSet</code>) å¯«å…¥ã€‚</li>
    </ul>

    <hr>

    <h2>4. è³‡æ–™æµå‘åœ– (Data Flow Diagram)</h2>

    <p>ä»¥ä¸‹æµç¨‹åœ–å±•ç¤ºäº†è³‡æ–™å¾ä½¿ç”¨è€…è«‹æ±‚åˆ°æœ€çµ‚å‘ˆç¾çš„å®Œæ•´è·¯å¾‘åŠå„ç¯€é»çš„ TTLï¼ŒåŒ…å«é›²ç«¯ Proxy çš„å‹•æ…‹å¿«å–æ©Ÿåˆ¶ã€‚</p>

    <div class="mermaid">
        %%{init: {'theme': 'base', 'themeVariables': { 'fontSize': '24px', 'actorFontSize': '24px', 'noteFontSize':
        '24px', 'messageFontSize': '24px', 'fontFamily': 'Microsoft JhengHei'}}}%%
        sequenceDiagram
        autonumber
        participant User as ä½¿ç”¨è€…
        participant UI as å‰ç«¯ UI<br />(backtest.js)
        participant LS as LocalStorage
        participant Worker as Web Worker
        participant Mem as Memory<br />Cache
        participant IDB as IndexedDB
        participant Cloud as Netlify<br />Proxy/Blob

        User->>UI: ç™¼èµ·å›æ¸¬è«‹æ±‚<br />(StockNo, DateRange)

        rect rgb(200, 255, 200)
        Note over UI, LS: 1. æª¢æŸ¥åŸºç¤è³‡æ–™ (åŒæ­¥)
        UI->>LS: æŸ¥è©¢è‚¡ç¥¨åç¨±/æ¸…å–®
        LS-->>UI: å›å‚³ (TTL: 7å¤©/24h)
        opt Miss or Expired
        UI->>Cloud: è«‹æ±‚æœ€æ–°æ¸…å–®
        Cloud-->>UI: å›å‚³ä¸¦æ›´æ–° LS
        end
        end

        UI->>Worker: postMessage: runBacktest

        rect rgb(255, 240, 240)
        Note over Worker, Mem: 2. æª¢æŸ¥è¨˜æ†¶é«”å¿«å– (æœ€å¿«)
        Worker->>Mem: æŸ¥è©¢ workerMonthlyCache<br />stockNameLookup
        Mem-->>Worker: å›å‚³ (TTL: 18h/12h)
        end

        alt Memory Hit
        Worker-->>UI: ç«‹å³å›å‚³çµæœ
        else Memory Miss
        rect rgb(240, 240, 255)
        Note over Worker, IDB: 3. æª¢æŸ¥ IndexedDB<br />(æŒä¹…åŒ–å¿«å–)
        Worker->>IDB: æŸ¥è©¢ Year Superset<br />(æ­·å²è³‡æ–™)
        IDB-->>Worker: å›å‚³ (TTL: 7å¤©)

        Worker->>IDB: æŸ¥è©¢ stock_cache<br />(ç•¶æœˆè³‡æ–™)
        IDB-->>Worker: å›å‚³ (TTL: 18h/12h)

        Worker->>IDB: æŸ¥è©¢ permanentInvalidDates
        IDB-->>Worker: å›å‚³ç„¡æ•ˆæ—¥æœŸ (TTL: 24h)
        end

        alt IDB Hit (All Data)
        Worker->>Mem: æ›´æ–° Memory Cache
        Worker-->>UI: å›å‚³çµæœ
        else IDB Miss (Partial/Full)
        rect rgb(255, 250, 230)
        Note over Worker, Cloud: 4. é›²ç«¯è³‡æ–™è«‹æ±‚ (æœ€æ…¢)
        Worker->>Cloud: è«‹æ±‚ç¼ºæ¼è³‡æ–™<br />(Range Fetch)
        Note right of Cloud: Dynamic Caching<br />Historical: 1 Year<br />Current: 1 Hour
        Cloud-->>Worker: å›å‚³æœ€æ–°è‚¡åƒ¹è³‡æ–™
        end

        par æ›´æ–°å¿«å–
        Worker->>Mem: å¯«å…¥ Memory Cache
        Worker->>IDB: éåŒæ­¥å¯«å…¥<br />Year Superset (7å¤©)<br />stock_cache (18h)
        end

        Worker-->>UI: å›å‚³æœ€çµ‚çµæœ
        end
        end
    </div>

    <hr>

    <h2>5. é—œéµç™¼ç¾èˆ‡å»ºè­°</h2>

    <ol>
        <li><strong>å‹•æ…‹åˆ†ç´šå¿«å– (Dynamic Caching)</strong>:
            <ul>
                <li>Proxy å±¤å¯¦ä½œäº†éå¸¸æ¿€é€²çš„å¿«å–ç­–ç•¥ï¼šå°æ–¼<strong>æ­·å²è³‡æ–™</strong> (<code>endDate < today</code>)ï¼ŒTTL é•·é” <strong>1
                        å¹´</strong>ï¼Œä¸”æ¨™è¨˜ç‚º <code>immutable</code>ã€‚é€™æ¥µå¤§åœ°æ¸›å°‘äº†å°ä¸Šæ¸¸è³‡æ–™æº (FinMind/Yahoo) çš„é‡è¤‡è«‹æ±‚ã€‚</li>
                <li>å°æ–¼<strong>ç•¶å‰è³‡æ–™</strong>ï¼ŒTTL ç¸®çŸ­ç‚º <strong>1 å°æ™‚</strong>ï¼Œç¢ºä¿ä½¿ç”¨è€…èƒ½ç›¸å°å³æ™‚åœ°çœ‹åˆ°æœ€æ–°è‚¡åƒ¹ã€‚</li>
            </ul>
        </li>
        <li><strong>å¤šå±¤æ¬¡ TTL äº’è£œ</strong>:
            <ul>
                <li><strong>Client (IDB)</strong>: 7å¤© (æ­·å²) / 18å°æ™‚ (ç•¶å‰)</li>
                <li><strong>Cloud (Blob)</strong>: 2-3å¤© (æ­·å²) / 24å°æ™‚ (ç•¶å‰)</li>
                <li><strong>CDN (Proxy)</strong>: 1å¹´ (æ­·å²) / 1å°æ™‚ (ç•¶å‰)</li>
                <li>é€™ç¨®éšæ¢¯å¼çš„è¨­è¨ˆæ—¢ä¿è­·äº†å¾Œç«¯è³‡æºï¼Œåˆåœ¨å‰ç«¯æä¾›äº†åˆç†çš„æ›´æ–°é »ç‡ã€‚</li>
            </ul>
        </li>
    </ol>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>

</body>

</html>