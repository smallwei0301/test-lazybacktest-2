
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📈 LazyBacktest - 台股回測系統 v0.1.1</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VNX2RVHZ5K"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-VNX2RVHZ5K');
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter%3Awght%40400%3B500%3B700%3B900&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />
    <link rel="stylesheet" href="css/style.css">
    <style>
      :root {
        --background: #ffffff;
        --foreground: #4b5563;
        --card: #f9fafb;
        --card-foreground: #374151;
        --popover: #ffffff;
        --popover-foreground: #4b5563;
        --primary: #0891b2;
        --primary-foreground: #ffffff;
        --secondary: #f59e0b;
        --secondary-foreground: #ffffff;
        --muted: #b0b0b0;
        --muted-foreground: #4b5563;
        --accent: #f59e0b;
        --accent-foreground: #ffffff;
        --destructive: #dc2626;
        --destructive-foreground: #ffffff;
        --border: #e5e7eb;
        --input: #ffffff;
        --ring: rgba(8, 145, 178, 0.5);
        --radius: 0.5rem;
      }
      
      .card {
        background-color: var(--card);
        color: var(--card-foreground);
        border-radius: calc(var(--radius) + 2px);
        border: 1px solid var(--border);
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      }
      
      .card-header {
        padding: 1.5rem 1.5rem 0 1.5rem;
      }
      
      .card-content {
        padding: 1.5rem;
      }
      
      .card-title {
        font-weight: 600;
        line-height: 1;
        margin-bottom: 0.375rem;
        font-size: 1.125rem; /* 18px - 確保標題比內容大 */
      }
      
      /* 調整交易記錄的字體大小和樣式 */
      #trade-results {
        width: 100%;
      }
      
      .trade-list {
        width: 100%;
        background-color: var(--background);
        border: 1px solid var(--border);
        border-radius: 0.375rem;
        overflow: visible !important; /* 強制取消滾動，顯示所有內容 */
        overflow-x: visible !important;
        overflow-y: visible !important;
        height: auto !important; /* 強制自動高度 */
        max-height: none !important; /* 強制移除最大高度限制 */
        min-height: auto !important; /* 強制移除最小高度限制 */
      }
      
      .trade-list .trade-signal {
        font-size: 0.875rem;
        padding: 1.25rem 1.5rem; /* 增加上下左右的 padding */
        border-bottom: 1px solid var(--border);
        background-color: var(--card);
        transition: all 0.15s ease;
        margin-bottom: 0.5rem; /* 增加項目間距 */
      }
      
      .trade-list .trade-signal:hover {
        background-color: var(--muted);
      }
      
      .trade-list .trade-signal:last-child {
        border-bottom: none;
      }
      
      .trade-list .trade-signal .text-xs {
        font-size: 0.75rem !important;
        line-height: 1.4;
      }
      
      .trade-list .trade-signal .text-sm {
        font-size: 0.875rem !important;
        line-height: 1.4;
        font-weight: 500;
      }
      
      .trade-list .trade-signal .text-base {
        font-size: 1rem !important;
        line-height: 1.4;
      }
      
      /* 交易操作標籤樣式 */
      .trade-action {
        font-size: 0.75rem !important;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        white-space: nowrap;
      }
      
      /* 提示區域樣式 */
      #trade-hints, #trade-hints-mobile {
        font-size: 0.75rem;
        line-height: 1.5;
      }
      
      #trade-hints p, #trade-hints-mobile p {
        margin-bottom: 0.5rem;
        line-height: 1.5;
      }
      
      #trade-hints p:last-child, #trade-hints-mobile p:last-child {
        margin-bottom: 0;
      }
      
      /* 獨立滾動區域樣式 */
      @media (min-width: 1024px) {
        .lg\\:h-screen {
          height: calc(100vh - 12rem); /* 減去header和padding高度 */
        }
        
        /* 左側面板滾動樣式 */
        .lg\\:overflow-y-auto:first-child {
          padding-right: 0.5rem;
        }
        
        /* 右側面板滾動樣式 */
        .lg\\:overflow-y-auto:last-child {
          padding-left: 0.5rem;
        }
        
        /* Webkit滾動條樣式 */
        .lg\\:overflow-y-auto::-webkit-scrollbar {
          width: 8px;
        }
        
        .lg\\:overflow-y-auto::-webkit-scrollbar-track {
          background: var(--muted);
          border-radius: 4px;
        }
        
        .lg\\:overflow-y-auto::-webkit-scrollbar-thumb {
          background: var(--border);
          border-radius: 4px;
          transition: background 0.2s ease;
        }
        
        .lg\\:overflow-y-auto::-webkit-scrollbar-thumb:hover {
          background: var(--muted-foreground);
        }
        
        /* Firefox滾動條樣式 */
        .lg\\:overflow-y-auto {
          scrollbar-width: thin;
          scrollbar-color: var(--border) var(--muted);
        }
        
        /* 防止橫向滾動並確保寬度限制 */
        .main-grid {
          max-width: 100%;
          overflow-x: hidden;
        }
        
        .main-grid > * {
          min-width: 0;
          overflow-x: hidden;
        }
        
        /* 左側面板樣式 */
        .left-panel {
          padding-right: 0.75rem; /* 左側面板右邊距 */
        }
        
        .left-panel::-webkit-scrollbar {
          width: 8px;
        }
        
        .left-panel::-webkit-scrollbar-track {
          margin-right: 8px; /* 滾動軸軌道右側留白 */
        }
        
        /* 右側面板樣式 */
        .right-panel {
          padding-right: 2rem; /* 增加右側內距避免卡片被裁斷 */
          padding-left: 0.75rem; /* 右側面板左邊距 */
        }
        
        /* 右側面板內的卡片和內容確保不被裁斷 */
        .right-panel .card {
          max-width: 100%;
          margin-right: 0;
        }
        
        .right-panel .card-content {
          padding-right: 1.5rem;
        }
        
        /* Sticky 標題樣式 - 只對導航標籤生效 */
        .sticky-header {
          position: sticky;
          top: 0;
          z-index: 20;
          background-color: var(--background);
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          margin-bottom: 1.5rem;
        }
        
        /* 確保 sticky header 在滾動容器中正確顯示 */
        .sticky-header .card-header {
          background-color: var(--card);
          border-bottom: 1px solid var(--border);
        }
        
        /* 確保標籤內容區域有足夠空間，避免被 sticky header 遮擋 */
        .tab-content {
          padding-top: 0;
        }
        
        /* 移除標籤內容卡片的 sticky 設定，避免滾動衝突 */
        .tab-content .card {
          position: static; /* 確保所有卡片正常滾動 */
          z-index: auto;
        }
        
        .tab-content .card-header {
          background-color: var(--card);
          border-bottom: 1px solid var(--border);
        }
        
        /* 交易紀錄卡片特殊高度設定 */
        #trade-results {
          min-height: 900px; /* 原來 300px 的三倍 */
        }
      }
      
      /* 響應式調整 */
      @media (max-width: 1023px) {
        .grid.grid-cols-1.lg\\:grid-cols-12 {
          grid-template-columns: 1fr;
        }
      }
      
      .card-description {
        color: var(--muted-foreground);
        font-size: 0.875rem;
      }
      
      .btn-primary {
        background-color: var(--primary);
        color: var(--primary-foreground);
        border: 1px solid var(--primary);
      }
      
      .btn-primary:hover {
        background-color: color-mix(in srgb, var(--primary) 90%, black);
      }
      
      .btn-secondary {
        background-color: var(--secondary);
        color: var(--secondary-foreground);
        border: 1px solid var(--secondary);
      }
      
      .btn-outline {
        background-color: transparent;
        color: var(--foreground);
        border: 1px solid var(--border);
      }
      
      .btn-outline:hover {
        background-color: var(--accent);
        color: var(--accent-foreground);
      }
      
      .text-primary { color: var(--primary); }
      .text-secondary { color: var(--secondary); }
      .text-accent { color: var(--accent); }
      .text-muted { color: var(--muted-foreground); }
      .bg-primary { background-color: var(--primary); }
      .bg-secondary { background-color: var(--secondary); }
      .bg-accent { background-color: var(--accent); }
      .border-primary { border-color: var(--primary); }
      .border-secondary { border-color: var(--secondary); }
      .border-accent { border-color: var(--accent); }
      
      .lucide {
        width: 1.25rem;
        height: 1.25rem;
        stroke-width: 2;
      }
      
      .lucide-sm {
        width: 1rem;
        height: 1rem;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," /> <!-- From UI file -->
</head>
<body class="bg-white group/design-root" style='font-family: Inter, "Noto Sans", sans-serif;'>
    <div class="relative flex size-full min-h-screen flex-col overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <header class="border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 sticky top-0 z-50 shadow-sm">
                <div class="container mx-auto px-4 h-16 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center shadow-sm">
                            <div class="w-5 h-5 flex flex-col justify-between">
                                <div class="flex justify-between">
                                    <div class="w-1 h-1 bg-primary-foreground rounded-full" style="background-color: var(--primary-foreground);"></div>
                                    <div class="w-1 h-1 bg-primary-foreground rounded-full" style="background-color: var(--primary-foreground);"></div>
                                    <div class="w-1 h-1 bg-primary-foreground rounded-full" style="background-color: var(--primary-foreground);"></div>
                                </div>
                                <div class="flex justify-between items-end">
                                    <div class="w-1 h-2 bg-primary-foreground rounded-sm" style="background-color: var(--primary-foreground);"></div>
                                    <div class="w-1 h-3 bg-primary-foreground rounded-sm" style="background-color: var(--primary-foreground);"></div>
                                    <div class="w-1 h-1 bg-primary-foreground rounded-sm" style="background-color: var(--primary-foreground);"></div>
                                </div>
                            </div>
                        </div>
                        <div>
                                    <span class="text-lg font-bold text-foreground" style="color: var(--foreground);">LazyBacktest</span>
                            <div class="text-xs text-muted" style="color: var(--muted-foreground);">台股回測系統</div>
                        </div>
                    </div>
                    <nav class="hidden md:flex items-center space-x-6">
                        <div class="text-sm text-muted" style="color: var(--muted-foreground);">
                            鄉民內部測試版: 建議事項與 Bug，請聯絡信箱: <a href="mailto:smallwei0301@gmail.com" class="underline hover:text-primary" style="color: var(--foreground);">smallwei0301@gmail.com</a>
                        </div>
                    </nav>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 min-h-screen bg-gradient-to-br from-background via-primary/5 to-accent/5 flex flex-col" style="background: linear-gradient(135deg, var(--background) 0%, color-mix(in srgb, var(--primary) 5%, transparent) 50%, color-mix(in srgb, var(--accent) 5%, transparent) 100%);">
                <!-- Hero Section -->
                <div class="bg-background border-b flex-shrink-0" style="background-color: var(--background); border-color: var(--border);">
                    <div class="container mx-auto px-4 py-12">
                        <div class="text-center flex flex-col items-center gap-8">
                            <div class="space-y-6 max-w-3xl">
                                <h1 class="text-4xl lg:text-5xl font-bold text-foreground" style="color: var(--foreground);">
                                    股票回測工具
                                </h1>
                                <p class="text-lg text-muted mx-auto" style="color: var(--muted-foreground);">
                                    透過歷史數據驗證您的交易策略，做出更明智的投資決策
                                </p>
                            </div>

                            <div class="flex flex-col sm:flex-row items-center justify-center gap-3 w-full sm:w-auto">
                                <!-- 一鍵回測按鈕 -->
                                <button
                                    id="quickBacktestBtn"
                                    class="btn-primary px-8 py-4 text-lg font-semibold rounded-lg transition duration-150 ease-in-out flex items-center justify-center"
                                    style="background-color: var(--primary); color: var(--primary-foreground); border: 1px solid var(--primary);"
                                    aria-label="一鍵回測台積電（可編輯）"
                                    data-state="idle"
                                >
                                    <i data-lucide="zap" class="lucide mr-3"></i>
                                    <span id="quickBacktestDefaultLabel" class="flex items-center gap-2">
                                        一鍵回測
                                        <span
                                            id="quickBacktestKeyword"
                                            class="quick-backtest-editable"
                                            contenteditable="true"
                                            spellcheck="false"
                                            role="textbox"
                                            aria-live="polite"
                                            aria-label="輸入想回測的股票名稱或代碼"
                                            tabindex="0"
                                            data-placeholder="輸入股票或代碼"
                                        >台積電</span>
                                    </span>
                                    <span id="quickBacktestStatusText" class="hidden items-center gap-2 text-base font-semibold"></span>
                                </button>

                                <button
                                    id="developerAreaToggle"
                                    type="button"
                                    class="btn-outline px-6 py-4 text-sm font-semibold rounded-lg transition duration-150 ease-in-out flex items-center justify-center"
                                    style="color: var(--foreground); border: 1px solid var(--border); background-color: var(--input);"
                                    aria-expanded="false"
                                    aria-controls="developerAreaWrapper"
                                >
                                    <i data-lucide="wrench" class="lucide mr-2"></i>
                                    開發者區域
                                </button>
                            </div>

                            <p id="quickBacktestHint" class="quick-backtest-hint text-center sm:text-left">
                                將使用 2330（台積電）進行一鍵回測。
                            </p>

                            <div
                                id="developerAreaWrapper"
                                class="hidden w-full max-w-4xl text-left mx-auto developer-area-wrapper"
                                aria-hidden="true"
                            >
                                <div class="card hero-developer-card" id="developerAreaCard">
                                    <div class="card-header">
                                        <h3 class="card-title flex items-center gap-2">
                                            <i data-lucide="wrench" class="lucide text-primary" style="color: var(--primary);"></i>
                                            開發者區域
                                        </h3>
                                        <p class="card-description">診斷資料流程、測試來源與 Blob 用量</p>
                                    </div>
                                    <div class="card-content space-y-4">
                                        <div class="space-y-2" id="dataSourceTesterContainer">
                                            <button
                                                id="toggleDataSourceTester"
                                                type="button"
                                                class="px-3 py-2 text-xs font-medium rounded-md border flex items-center gap-1 transition-colors"
                                                style="color: var(--foreground); border-color: var(--border); background-color: var(--background);"
                                            >
                                                <i data-lucide="radar" class="lucide w-4 h-4"></i>
                                                測試資料來源
                                            </button>
                                            <div id="dataSourceTester" class="hidden border rounded-md bg-white/70 shadow-sm" style="border-color: var(--border);">
                                                <div class="flex items-center justify-between px-3 py-2 border-b" style="border-color: var(--border);">
                                                    <div class="text-[11px] font-medium" id="dataSourceTesterMode" style="color: var(--foreground);"></div>
                                                    <button id="closeDataSourceTester" type="button" class="text-[11px] text-muted-foreground hover:text-foreground transition-colors" style="color: var(--muted-foreground);">關閉</button>
                                                </div>
                                                <div class="px-3 py-3 space-y-3">
                                                    <div id="dataSourceTesterHint" class="text-[11px] text-muted-foreground" style="color: var(--muted-foreground);"></div>
                                                    <div id="dataSourceTesterButtons" class="flex flex-wrap gap-2"></div>
                                                    <div id="dataSourceTesterResult" class="text-xs hidden"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="space-y-2" id="dataDiagnosticsContainer">
                                            <button
                                                id="toggleDataDiagnostics"
                                                type="button"
                                                class="px-3 py-2 text-xs font-medium rounded-md border flex items-center gap-1 transition-colors"
                                                style="color: var(--foreground); border-color: var(--border); background-color: var(--background);"
                                            >
                                                <i data-lucide="bug" class="lucide w-4 h-4"></i>
                                                診斷資料暖身
                                            </button>
                                            <div id="dataDiagnosticsPanel" class="hidden border rounded-md bg-white/70 shadow-sm" style="border-color: var(--border);">
                                                <div class="flex items-center justify-between px-3 py-2 border-b" style="border-color: var(--border);">
                                                    <div class="text-[11px] font-medium" id="dataDiagnosticsTitle" style="color: var(--foreground);">資料暖身診斷</div>
                                                    <button id="closeDataDiagnostics" type="button" class="text-[11px] text-muted-foreground hover:text-foreground transition-colors" style="color: var(--muted-foreground);">關閉</button>
                                                </div>
                                                <div class="px-3 py-3 space-y-3 text-[11px]" id="dataDiagnosticsBody">
                                                    <div id="dataDiagnosticsHint" class="text-[11px]" style="color: var(--muted-foreground);">請先執行回測後，再查看暖身與快取診斷資訊。</div>
                                                    <div id="dataDiagnosticsContent" class="hidden space-y-3">
                                                        <div>
                                                            <h5 class="font-medium mb-1" style="color: var(--foreground);">名稱與清單資訊</h5>
                                                            <div id="dataDiagnosticsName" class="space-y-1"></div>
                                                        </div>
                                                        <div>
                                                            <h5 class="font-medium mb-1" style="color: var(--foreground);">資料摘要</h5>
                                                            <div id="dataDiagnosticsSummary" class="space-y-1"></div>
                                                            <div id="dataDiagnosticsInvalidSamples" class="space-y-1 mt-2"></div>
                                                        </div>
                                                        <div>
                                                            <h5 class="font-medium mb-1" style="color: var(--foreground);">暖身與指標設定</h5>
                                                            <div id="dataDiagnosticsWarmup" class="space-y-1"></div>
                                                        </div>
                                                        <div>
                                                            <h5 class="font-medium mb-1" style="color: var(--foreground);">使用者起點鄰近樣本</h5>
                                                            <div id="dataDiagnosticsPreview" class="space-y-1"></div>
                                                        </div>
                                                        <div>
                                                            <h5 class="font-medium mb-1" style="color: var(--foreground);">買入持有檢查</h5>
                                                            <div id="dataDiagnosticsBuyHold" class="space-y-1"></div>
                                                            <div id="dataDiagnosticsBuyHoldSamples" class="space-y-1 mt-2"></div>
                                                        </div>
                                                        <div>
                                                            <h5 class="font-medium mb-1" style="color: var(--foreground);">月度抓取紀錄</h5>
                                                            <div id="dataDiagnosticsFetchSummary" class="space-y-1"></div>
                                                            <div id="dataDiagnosticsFetchMonths" class="space-y-2 mt-2"></div>
                                                        </div>
                                                        <div>
                                                            <h5 class="font-medium mb-1" style="color: var(--foreground);">手動測試指引</h5>
                                                            <div id="dataDiagnosticsTesting" class="space-y-1"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="space-y-2" id="dataSourceSummaryContainer">
                                            <div class="flex items-center justify-between">
                                                <div class="text-sm font-medium flex items-center gap-2" style="color: var(--foreground);">
                                                    <i data-lucide="layers" class="lucide w-4 h-4"></i>
                                                    數據來源摘要
                                                </div>
                                                <span id="dataSourceSummaryTag" class="text-[11px] text-muted-foreground" style="color: var(--muted-foreground);"></span>
                                            </div>
                                            <div class="rounded-md border bg-white/70 shadow-sm" style="border-color: var(--border);">
                                                <div id="dataSourceDisplay" class="px-3 py-3 space-y-2 text-[11px]" style="color: var(--foreground);"></div>
                                            </div>
                                        </div>
                                        <div class="space-y-2" id="todaySuggestionLogContainer">
                                            <div class="flex items-center justify-between">
                                                <div class="text-sm font-medium flex items-center gap-2" style="color: var(--foreground);">
                                                    <i data-lucide="message-square-warning" class="lucide w-4 h-4"></i>
                                                    今日建議記錄
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <button
                                                        id="todaySuggestionLogToggle"
                                                        type="button"
                                                        class="px-2 py-1 text-[11px] rounded-md border transition-colors flex items-center gap-1"
                                                        style="color: var(--foreground); border-color: var(--border); background-color: var(--background);"
                                                        aria-expanded="false"
                                                        aria-controls="todaySuggestionLogPanel"
                                                    >
                                                        <span class="toggle-indicator">＋</span>
                                                        <span class="toggle-label">展開</span>
                                                    </button>
                                                    <button
                                                        id="todaySuggestionLogClear"
                                                        type="button"
                                                        class="px-2 py-1 text-[11px] rounded-md border transition-colors"
                                                        style="color: var(--muted-foreground); border-color: var(--border); background-color: var(--background);"
                                                    >
                                                        清除紀錄
                                                    </button>
                                                </div>
                                            </div>
                                            <div
                                                id="todaySuggestionLogPanel"
                                                class="rounded-md border bg-white/70 shadow-sm hidden"
                                                style="border-color: var(--border);"
                                                aria-hidden="true"
                                            >
                                                <div
                                                    id="today-suggestion-log-body"
                                                    class="px-3 py-3 space-y-3 text-[11px]"
                                                    style="color: var(--foreground);"
                                                ></div>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex items-center justify-between">
                                                <div class="text-sm font-medium flex items-center gap-2" style="color: var(--foreground);">
                                                    <i data-lucide="database" class="lucide w-4 h-4"></i>
                                                    Blob 使用監控
                                                </div>
                                                <div id="blobUsageUpdatedAt" class="text-[11px]" style="color: var(--muted-foreground);"></div>
                                            </div>
                                            <div class="rounded-md border bg-white/70 shadow-sm" style="border-color: var(--border);">
                                                <div id="blobUsageContent" class="px-3 py-3 space-y-3 text-[11px]" style="color: var(--foreground);"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="container mx-auto px-4 py-8 flex-1 overflow-hidden">
                    <div class="main-grid h-full overflow-hidden overflow-x-hidden">
                        <!-- Left Panel - Settings and Controls -->
                        <div class="space-y-6 lg:overflow-y-auto lg:h-screen lg:sticky lg:top-0 lg:pb-8 overflow-x-hidden left-panel" style="scrollbar-width: thin; scrollbar-color: var(--muted) var(--background);">

                            <!-- Settings Cards -->
                            <div class="space-y-6">
                                <!-- Basic Settings Card -->
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title flex items-center gap-2">
                                            <i data-lucide="settings" class="lucide text-primary" style="color: var(--primary);"></i>
                                            <span class="tooltip">
                                                基本設定
                                                <span class="tooltiptext">更改代碼或日期範圍會觸發重新獲取數據。</span>
                                            </span>
                                        </h3>
                                        <p class="card-description">設定股票代碼、時間範圍和初始資金</p>
                                    </div>
                                    <div class="card-content space-y-4">
                                        <div>
                                            <label for="stockNo" class="block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">台灣/美國股票代碼 (目前無提供指數)</label>
                                            <div class="flex flex-wrap items-center gap-2">
                                                <div class="flex-1 min-w-[160px] sm:min-w-[200px]">
                                                    <input
                                                        id="stockNo"
                                                        type="text"
                                                        value="2330"
                                                        placeholder="例如: 2330, 0050, AAPL"
                                                        class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm"
                                                        style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                    />
                                                </div>
                                                <div class="flex items-center gap-2 text-xs shrink-0 min-w-[150px]">
                                                    <span class="text-muted-foreground" style="color: var(--muted-foreground);">市場:</span>
                                                    <select
                                                        id="marketSelect"
                                                        class="px-3 py-1 border border-border rounded-md text-xs bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring pr-8"
                                                        style="border-color: var(--border); background-color: var(--input); color: var(--foreground); min-width: 6.5rem;"
                                                    >
                                                        <option value="TWSE">上市</option>
                                                        <option value="TPEX">上櫃</option>
                                                        <option value="US">美股</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div id="marketAdjustedHint" class="mt-1 text-[11px] text-amber-600 hidden">
                                                美股回測目前採用原始股價，已自動停用除權息還原與拆分選項。
                                            </div>
                                            <div id="stockNameDisplay" class="mt-1 text-xs" style="display: none;">
                                                <!-- 股票名稱和市場切換提示將顯示在這裡 -->
                                            </div>
                                            <div
                                                id="pricePipelineSteps"
                                                class="mt-1 hidden space-y-1"
                                                style="color: var(--muted-foreground);"
                                            ></div>
                            </div>
                            <!-- Patch Tag: LB-ADJ-SWITCH-20240922A -->
                                        <!-- Patch Tag: LB-ADJ-SPLIT-20250518A -->
                                        <div class="flex items-center gap-4">
                                            <div class="flex items-center">
                                                <input type="checkbox" id="adjustedPriceCheckbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded mr-2" />
                                                <label for="adjustedPriceCheckbox" class="text-xs text-muted" style="color: var(--muted-foreground);">除權息還原股價</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input type="checkbox" id="splitAdjustmentCheckbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded mr-2" />
                                                <label for="splitAdjustmentCheckbox" class="text-xs text-muted" style="color: var(--muted-foreground);">股票拆分還原</label>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label for="startDate" class="block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">開始日期</label>
                                                <input 
                                                    type="date" 
                                                    id="startDate" 
                                                    class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm"
                                                    style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                />
                                            </div>
                                            <div>
                                                <label for="endDate" class="block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">結束日期</label>
                                                <input 
                                                    type="date" 
                                                    id="endDate" 
                                                    class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm"
                                                    style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                />
                                            </div>
                                        </div>
                                        <div class="flex items-end gap-2">
                                            <div class="flex-grow">
                                                <label for="recentYears" class="block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">最近N年</label>
                                                <input 
                                                    type="number" 
                                                    id="recentYears" 
                                                    value="5" 
                                                    min="1" 
                                                    max="50" 
                                                    step="1" 
                                                    class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm"
                                                    style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                />
                                            </div>
                                            <button id="applyYearsBtn" title="設定開始日期" class="px-3 py-2 bg-primary hover:bg-primary text-white text-xs rounded-md transition duration-150 ease-in-out whitespace-nowrap" style="background-color: var(--primary);">套用</button>
                                        </div>
                                        <div>
                                            <label for="initialCapital" class="block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">初始本金 (元)</label>
                                            <input 
                                                type="number" 
                                                id="initialCapital" 
                                                value="100000" 
                                                step="1000" 
                                                class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm"
                                                style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                            />
                                        </div>
                                    </div>
                                </div>
                                <!-- Trading Settings Card -->
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title flex items-center gap-2">
                                            <i data-lucide="trending-up" class="lucide text-accent" style="color: var(--accent);"></i>
                                            交易設定
                                        </h3>
                                        <p class="card-description">設定交易時機和手續費</p>
                                    </div>
                                    <div class="card-content">
                                        <div class="space-y-3 mb-4 pb-3 border-b" style="border-color: var(--border);">
                                            <p class="text-xs font-medium text-foreground" style="color: var(--foreground);">買賣時間點</p>
                                            <div class="flex items-center">
                                                <input type="radio" id="tradeTimingClose" name="tradeTiming" value="close" checked class="h-4 w-4 text-accent border-border focus:ring-accent mr-2" style="border-color: var(--border); color: var(--accent);">
                                                <label for="tradeTimingClose" class="tooltip text-xs text-foreground" style="color: var(--foreground);">
                                                    當日 (N) 收盤價
                                                    <span class="tooltiptext">使用信號產生當日的收盤價交易。</span>
                                                </label>
                                            </div>
                                            <div class="flex items-center">
                                                <input type="radio" id="tradeTimingOpen" name="tradeTiming" value="open" class="h-4 w-4 text-accent border-border focus:ring-accent mr-2" style="border-color: var(--border); color: var(--accent);">
                                                <label for="tradeTimingOpen" class="tooltip text-xs text-foreground" style="color: var(--foreground);">
                                                    隔日 (N+1) 開盤價
                                                    <span class="tooltiptext">使用信號產生次日的開盤價交易。</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="space-y-4">
                                            <p class="text-xs font-medium text-foreground" style="color: var(--foreground);">交易成本設定 (%)</p>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label for="buyFee" class="tooltip block text-xs font-medium text-muted mb-1" style="color: var(--muted-foreground);">
                                                        買入手續費 (%)
                                                        <span class="tooltiptext">預設會根據股票/ETF代碼自動判斷。一般股票為0.1425%，ETF 通常為 0.1% (但依券商可能不同)。可自行修改。</span>
                                                    </label>
                                                    <input type="number" id="buyFee" value="0.1425" min="0" max="5" step="0.0001" class="w-full px-2 py-1 border border-border rounded-md shadow-sm text-sm focus:ring-accent focus:border-accent bg-input text-foreground" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);">
                                                </div>
                                                <div>
                                                    <label for="sellFee" class="tooltip block text-xs font-medium text-muted mb-1" style="color: var(--muted-foreground);">
                                                        賣出手續費+稅 (%)
                                                        <span class="tooltiptext">預設會根據代碼自動判斷。一般股票為 0.1425% 手續費 + 0.3% 交易稅 = 0.4425%。ETF 為 0.1% 手續費 + 0.1% 交易稅 = 0.2%。可自行修改。</span>
                                                    </label>
                                                    <input type="number" id="sellFee" value="0.4425" min="0" max="5" step="0.0001" class="w-full px-2 py-1 border border-border rounded-md shadow-sm text-sm focus:ring-accent focus:border-accent bg-input text-foreground" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Risk Management Card -->
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title flex items-center gap-2">
                                            <i data-lucide="shield" class="lucide text-destructive" style="color: var(--destructive);"></i>
                                            風險管理
                                        </h3>
                                        <p class="card-description">設定部位大小和停損停利 (多空共用)</p>
                                    </div>
                                    <div class="card-content space-y-4">
                                        <div class="space-y-2">
                                            <label class="tooltip block text-xs font-medium text-foreground" style="color: var(--foreground);">
                                                部位大小計算基準
                                                <span class="tooltiptext">選擇每次進場時，用於計算投入金額的基準：<br>- 初始本金：固定使用最開始設定的本金計算部位大小。<br>- 總資金：使用當下模擬帳戶的總資產 (包含已實現損益) 計算部位大小，部位會隨著獲利放大或虧損縮小 (複利效果)。</span>
                                            </label>
                                            <div class="flex items-center gap-4">
                                                <div class="flex items-center">
                                                    <input type="radio" id="positionBasisInitial" name="positionBasis" value="initialCapital" checked class="h-4 w-4 text-accent border-border focus:ring-accent mr-1" style="border-color: var(--border); color: var(--accent);">
                                                    <label for="positionBasisInitial" class="text-xs text-foreground" style="color: var(--foreground);">初始本金</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input type="radio" id="positionBasisTotal" name="positionBasis" value="totalCapital" class="h-4 w-4 text-accent border-border focus:ring-accent mr-1" style="border-color: var(--border); color: var(--accent);">
                                                    <label for="positionBasisTotal" class="text-xs text-foreground" style="color: var(--foreground);">總資金</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="positionSize" class="tooltip block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">
                                                部位大小 (%)
                                                <span class="tooltiptext">單次進場使用的 **計算基準** (上方選擇) 的百分比 (多空獨立計算)。</span>
                                            </label>
                                            <input type="number" id="positionSize" value="100" min="1" max="100" class="w-full px-3 py-2 border border-border rounded-md shadow-sm text-sm focus:ring-accent focus:border-accent bg-input text-foreground" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);">
                                        </div>

                                        <div class="space-y-2" id="multiStagePanel">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs font-medium text-foreground" style="color: var(--foreground);">多次進出場</span>
                                                <button
                                                    type="button"
                                                    id="multiStageToggle"
                                                    class="flex h-6 w-6 items-center justify-center rounded-full border border-border text-xs font-semibold leading-none transition-colors"
                                                    style="border-color: var(--border); color: var(--foreground);"
                                                    aria-label="切換多次進出場設定"
                                                    aria-expanded="false"
                                                    aria-controls="multiStageContent"
                                                >
                                                    <span id="multiStageToggleIcon" aria-hidden="true">+</span>
                                                </button>
                                            </div>
                                            <div
                                                id="multiStageContent"
                                                class="hidden space-y-3 border-t border-border pt-3"
                                                style="border-color: var(--border);"
                                            >
                                                <div class="space-y-3" id="stagedEntryContainer">
                                                    <div class="space-y-2">
                                                        <div class="flex items-center justify-between">
                                                            <label class="block text-xs font-medium" style="color: var(--foreground);">
                                                                分段進場 (%)
                                                            </label>
                                                            <button type="button" id="addEntryStageButton" class="text-xs font-medium px-2 py-1 rounded border transition-colors" style="border-color: var(--border); color: var(--accent);">
                                                                新增分段
                                                            </button>
                                                        </div>
                                                        <p class="text-[11px] leading-snug" style="color: var(--muted-foreground);">
                                                            預設與上方部位大小同步。新增分段後可依序設定不同百分比，例如 50%、60%，系統將依照觸發順序分批投入。
                                                        </p>
                                                        <div id="entryStageList" class="space-y-2"></div>
                                                    </div>
                                                    <div class="space-y-1.5">
                                                        <label for="entryStagingMode" class="block text-xs font-medium" style="color: var(--foreground);">
                                                            分段觸發條件
                                                        </label>
                                                        <select
                                                            id="entryStagingMode"
                                                            class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-xs"
                                                            style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                        >
                                                            <option value="signal_repeat">策略訊號再觸發（有條件買）</option>
                                                            <option value="price_pullback">價格回落加碼（更便宜買）</option>
                                                        </select>
                                                        <p class="text-[11px] leading-snug" style="color: var(--muted-foreground);">
                                                            「價格回落加碼」會在首次進場後、收盤價跌破前一段的成交價時自動投入下一段；「策略訊號再觸發」則需策略條件再次成立才會加碼。
                                                        </p>
                                                    </div>
                                                    <div class="space-y-3" id="stagedExitContainer">
                                                        <div class="space-y-2">
                                                            <div class="flex items-center justify-between">
                                                                <label class="block text-xs font-medium" style="color: var(--foreground);">
                                                                    分段出場 (%)
                                                                </label>
                                                                <button type="button" id="addExitStageButton" class="text-xs font-medium px-2 py-1 rounded border transition-colors" style="border-color: var(--border); color: var(--accent);">
                                                                    新增分段
                                                                </button>
                                                            </div>
                                                            <p class="text-[11px] leading-snug" style="color: var(--muted-foreground);">
                                                                預設一次出清。新增分段後可依序設定部分獲利，例如 40%、30%、30%，系統會按照觸發順序分批出場。
                                                            </p>
                                                            <div id="exitStageList" class="space-y-2"></div>
                                                        </div>
                                                        <div class="space-y-1.5">
                                                            <label for="exitStagingMode" class="block text-xs font-medium" style="color: var(--foreground);">
                                                                分段出場條件
                                                            </label>
                                                            <select
                                                                id="exitStagingMode"
                                                                class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-xs"
                                                                style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                            >
                                                                <option value="signal_repeat">策略訊號再觸發（有條件賣）</option>
                                                                <option value="price_rally">價格走高分批出場（更貴賣）</option>
                                                            </select>
                                                            <p class="text-[11px] leading-snug" style="color: var(--muted-foreground);">
                                                                「價格走高分批出場」會在首次賣出後、收盤價突破前一段的成交價時自動出清下一段；「策略訊號再觸發」則需策略條件次成立才會續賣。
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="stopLoss" class="tooltip block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">
                                                固定停損 (%)
                                                <span class="tooltiptext">虧損達此%強制出場(多單停損/空單回補),優先於策略信號。0=不啟用。</span>
                                            </label>
                                            <input type="number" id="stopLoss" value="0" min="0" max="100" step="0.5" class="w-full px-3 py-2 border border-border rounded-md shadow-sm text-sm focus:ring-accent focus:border-accent bg-input text-foreground" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);">
                                        </div>
                                        <div>
                                            <label for="takeProfit" class="tooltip block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">
                                                固定停利 (%)
                                                <span class="tooltiptext">獲利達此%強制出場(多單停利/空單回補),優先於策略信號。0=不啟用。</span>
                                            </label>
                                            <input type="number" id="takeProfit" value="0" min="0" max="1000" step="0.5" class="w-full px-3 py-2 border border-border rounded-md shadow-sm text-sm focus:ring-accent focus:border-accent bg-input text-foreground" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);">
                                        </div>
                                    </div>
                                </div>
                                <!-- Strategy Settings Card -->
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title flex items-center gap-2">
                                            <i data-lucide="target" class="lucide text-primary" style="color: var(--primary);"></i>
                                            策略設定
                                        </h3>
                                        <p class="card-description">設定進場和出場條件</p>
                                    </div>
                                    <div class="card-content space-y-6">
                                        <div class="grid md:grid-cols-2 gap-6">
                                            <div>
                                                <label for="entryStrategy" class="block text-xs font-medium text-foreground mb-2" style="color: var(--foreground);">
                                                    <i data-lucide="arrow-up-circle" class="lucide-sm inline mr-1 text-green-600"></i>
                                                    做多進場策略
                                                </label>
                                                <select
                                                    id="entryStrategy"
                                                    class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm"
                                                    style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                >
                                                    <option value="ma_cross">均線黃金交叉</option>
                                                    <option value="ma_above">價格突破均線</option>
                                                    <option value="rsi_oversold">RSI超賣</option>
                                                    <option value="macd_cross">MACD黃金交叉 (DI版)</option>
                                                    <option value="bollinger_breakout">布林通道突破</option>
                                                    <option value="k_d_cross">KD黃金交叉 (D&lt;X)</option>
                                                    <option value="volume_spike">成交量暴增</option>
                                                    <option value="price_breakout">價格突破前高</option>
                                                    <option value="williams_oversold">威廉指標超賣</option>
                                                    <option value="turtle_breakout">海龜突破 (僅進場)</option>
                                                </select>
                                                <div id="entryParams" class="mt-4 space-y-3"></div>
                                            </div>

                                            <div class="space-y-3">
                                                <label for="exitStrategy" class="block text-xs font-medium text-foreground mb-2" style="color: var(--foreground);">
                                                    <i data-lucide="arrow-down-circle" class="lucide-sm inline mr-1 text-red-600"></i>
                                                    做多出場策略
                                                </label>
                                                <select
                                                    id="exitStrategy"
                                                    class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm"
                                                    style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                >
                                                    <option value="ma_cross">均線死亡交叉</option>
                                                    <option value="ma_below">價格跌破均線</option>
                                                    <option value="rsi_overbought">RSI超買</option>
                                                    <option value="macd_cross">MACD死亡交叉 (DI版)</option>
                                                    <option value="bollinger_reversal">布林通道反轉</option>
                                                    <option value="k_d_cross">KD死亡交叉 (D&gt;Y)</option>
                                                    <option value="volume_spike">成交量暴增</option>
                                                    <option value="price_breakdown">價格跌破前低</option>
                                                    <option value="williams_overbought">威廉指標超買</option>
                                                    <option value="turtle_stop_loss">海龜停損 (N日低)</option>
                                                    <option value="trailing_stop">移動停損 (%)</option>
                                                    <option value="fixed_stop_loss">(由風險管理控制)</option>
                                                </select>
                                                <div id="exitParams" class="mt-4 space-y-3"></div>
                                            </div>
                                        </div>

                                        <!-- Short Selling Option -->
                                        <div class="border-t pt-4" style="border-color: var(--border);">
                                            <label class="flex items-center mb-4">
                                                <input type="checkbox" id="enableShortSelling" class="mr-2" />
                                                <span class="text-xs font-medium text-foreground" style="color: var(--foreground);">
                                                    <i data-lucide="trending-down" class="lucide-sm inline mr-1 text-red-600"></i>
                                                    啟用做空交易
                                                </span>
                                            </label>

                                            <div id="short-strategy-area" class="hidden space-y-4">
                                                <div class="grid md:grid-cols-2 gap-4">
                                                    <div>
                                                        <label for="shortEntryStrategy" class="block text-xs font-medium text-foreground mb-2" style="color: var(--foreground);">做空進場策略</label>
                                                        <select
                                                            id="shortEntryStrategy"
                                                            class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm"
                                                            style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                        >
                                                            <option value="short_ma_cross">均線死亡交叉 (做空)</option>
                                                            <option value="short_ma_below">價格跌破均線 (做空)</option>
                                                            <option value="short_rsi_overbought">RSI超買 (做空)</option>
                                                            <option value="short_macd_cross">MACD死亡交叉 (DI版) (做空)</option>
                                                            <option value="short_bollinger_reversal">布林通道反轉 (做空)</option>
                                                            <option value="short_k_d_cross">KD死亡交叉 (D&gt;Y) (做空)</option>
                                                            <option value="short_price_breakdown">價格跌破前低 (做空)</option>
                                                            <option value="short_williams_overbought">威廉指標超買 (做空)</option>
                                                            <option value="short_turtle_stop_loss">海龜N日低 (做空)</option>
                                                        </select>
                                                        <div id="shortEntryParams" class="mt-3 space-y-2"></div>
                                                    </div>

                                                    <div>
                                                        <label for="shortExitStrategy" class="block text-xs font-medium text-foreground mb-2" style="color: var(--foreground);">回補出場策略</label>
                                                        <select
                                                            id="shortExitStrategy"
                                                            class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm"
                                                            style="border-color: var(--border); background-color: var(--input); color: var(--foreground);"
                                                        >
                                                            <option value="cover_ma_cross">均線黃金交叉 (回補)</option>
                                                            <option value="cover_ma_above">價格突破均線 (回補)</option>
                                                            <option value="cover_rsi_oversold">RSI超賣 (回補)</option>
                                                            <option value="cover_macd_cross">MACD黃金交叉 (DI版) (回補)</option>
                                                            <option value="cover_bollinger_breakout">布林通道突破 (回補)</option>
                                                            <option value="cover_k_d_cross">KD黃金交叉 (D&lt;X) (回補)</option>
                                                            <option value="cover_price_breakout">價格突破前高 (回補)</option>
                                                            <option value="cover_williams_oversold">威廉指標超賣 (回補)</option>
                                                            <option value="cover_turtle_breakout">海龜N日高 (回補)</option>
                                                            <option value="cover_trailing_stop">移動停損 (%) (空單停損)</option>
                                                            <option value="cover_fixed_stop_loss">(由風險管理控制)</option>
                                                        </select>
                                                        <div id="shortExitParams" class="mt-3 space-y-2"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Strategy Management -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title flex items-center gap-2">
                                        <i data-lucide="file-text" class="lucide text-accent" style="color: var(--accent);"></i>
                                        <span class="tooltip">
                                            策略管理
                                            <span class="tooltiptext">儲存、載入、刪除您的回測策略設定 (包含風險管理)。指標會儲存最後回測結果。</span>
                                        </span>
                                    </h3>
                                </div>
                                <div class="card-content space-y-3">
                                    <div>
                                        <label for="loadStrategySelect" class="block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">已儲存策略 (名稱 | 年化% | 夏普值)</label>
                                        <select id="loadStrategySelect" class="w-full px-3 py-2 border border-border rounded-md shadow-sm text-sm focus:ring-accent focus:border-accent bg-input text-foreground" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);">
                                            <option value="">-- 選擇要載入的策略 --</option>
                                        </select>
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        <button id="saveStrategyBtn" class="px-3 py-2 bg-transparent text-primary hover:bg-accent border border-primary text-sm rounded-md transition duration-150 ease-in-out flex-grow sm:flex-grow-0" style="color: var(--primary); border-color: var(--primary);">
                                            <i data-lucide="save" class="lucide-sm mr-1"></i>儲存目前
                                        </button>
                                        <button id="loadStrategyBtn" class="px-3 py-2 bg-transparent text-primary hover:bg-accent border border-primary text-sm rounded-md transition duration-150 ease-in-out flex-grow sm:flex-grow-0" style="color: var(--primary); border-color: var(--primary);">
                                            <i data-lucide="folder-open" class="lucide-sm mr-1"></i>載入選定
                                        </button>
                                        <button id="deleteStrategyBtn" class="px-3 py-2 bg-transparent text-primary hover:bg-accent border border-primary text-sm rounded-md transition duration-150 ease-in-out flex-grow sm:flex-grow-0" style="color: var(--primary); border-color: var(--primary);">
                                            <i data-lucide="trash-2" class="lucide-sm mr-1"></i>刪除選定
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Results -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title flex items-center gap-2">
                                        <i data-lucide="zap" class="lucide text-accent" style="color: var(--accent);"></i>
                                        快速結果
                                    </h3>
                                </div>
                                <div class="card-content">
                                    <div
                                        id="result"
                                        class="text-sm text-muted min-h-[100px] flex items-center justify-center border-2 border-dashed rounded-lg p-4"
                                        style="color: var(--muted-foreground); border-color: var(--card);"
                                    >
                                        執行回測後將顯示結果摘要
                                    </div>
                                </div>
                            </div>

                            <!-- Today Suggestion -->
                            <div class="card hidden" id="today-suggestion-area" aria-live="polite">
                                <div class="card-header pb-2">
                                    <h3 class="card-title flex items-center gap-2">
                                        <i data-lucide="lightbulb" class="lucide text-accent" style="color: var(--accent);"></i>
                                        今日建議
                                    </h3>
                                </div>
                                <div class="card-content pt-0 space-y-4">
                                    <div id="today-suggestion-empty" class="today-suggestion-empty">
                                        執行回測後將依最新資料推導今日的操作指引
                                    </div>
                                    <div id="today-suggestion-body" class="today-suggestion-body hidden">
                                        <div id="today-suggestion-banner" class="today-suggestion-highlight">
                                            <div class="today-suggestion-topline">
                                                <span id="today-suggestion-label" class="today-suggestion-chip">計算中</span>
                                                <span id="today-suggestion-date" class="today-suggestion-date">—</span>
                                            </div>
                                            <div id="today-suggestion-message" class="today-suggestion-message">—</div>
                                        </div>
                                        <div id="today-suggestion-controls" class="today-suggestion-controls">
                                            <button
                                                id="today-suggestion-stats-toggle"
                                                type="button"
                                                class="today-suggestion-toggle"
                                                aria-expanded="false"
                                                aria-controls="today-suggestion-stats-wrapper"
                                            >
                                                <span class="toggle-indicator">＋</span>
                                                <span class="toggle-label">展開部位概況</span>
                                            </button>
                                        </div>
                                        <div id="today-suggestion-stats-wrapper" class="today-suggestion-stats-wrapper hidden" aria-hidden="true">
                                            <dl class="today-suggestion-stats">
                                                <div class="today-suggestion-stat">
                                                    <dt class="today-suggestion-stat-label">多單概況</dt>
                                                    <dd id="today-suggestion-long" class="today-suggestion-stat-value">—</dd>
                                                </div>
                                                <div class="today-suggestion-stat">
                                                    <dt class="today-suggestion-stat-label">空單概況</dt>
                                                    <dd id="today-suggestion-short" class="today-suggestion-stat-value">—</dd>
                                                </div>
                                                <div class="today-suggestion-stat">
                                                    <dt class="today-suggestion-stat-label">整體部位</dt>
                                                    <dd id="today-suggestion-position" class="today-suggestion-stat-value">—</dd>
                                                </div>
                                                <div class="today-suggestion-stat">
                                                    <dt class="today-suggestion-stat-label">資產估值</dt>
                                                    <dd id="today-suggestion-portfolio" class="today-suggestion-stat-value">—</dd>
                                                </div>
                                            </dl>
                                        </div>
                                        <div id="today-suggestion-notes-container" class="today-suggestion-notes hidden">
                                            <div class="today-suggestion-notes-title">備註</div>
                                            <ul id="today-suggestion-notes" class="today-suggestion-notes-list"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Loading/Progress -->
                            <div class="card hidden" id="loading">
                                <div class="card-header">
                                    <h3 class="card-title">執行中...</h3>
                                </div>
                                <div class="card-content">
                                    <div class="space-y-3">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="loading-mascot-wrapper square w-14 h-14 overflow-hidden flex items-center justify-center"
                                                aria-hidden="true"
                                            >
                                                <div
                                                    id="loadingGif"
                                                    class="loading-mascot-canvas"
                                                    data-mascot-src="https://tenor.com/zh-TW/view/hachiware-gif-1718069610368761676"
                                                >
                                                    <img
                                                        class="loading-mascot-image"
                                                        src="https://tenor.com/zh-TW/view/hachiware-gif-1718069610368761676"
                                                        alt="LazyBacktest 進度吉祥物動畫"
                                                        decoding="async"
                                                        loading="eager"
                                                        referrerpolicy="no-referrer"
                                                        aria-hidden="true"
                                                    />
                                                </div>
                                            </div>
                                            <p
                                                id="loadingText"
                                                class="text-sm text-muted"
                                                style="color: var(--muted-foreground);"
                                            >
                                                準備中...
                                            </p>
                                        </div>
                                        <div class="w-full bg-muted rounded-full h-2" style="background-color: var(--muted);">
                                            <div
                                                id="progressBar"
                                                class="bg-primary h-2 rounded-full transition-all duration-300"
                                                style="width: 0%; background-color: var(--primary);"
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="card shadow-lg border-2 border-primary/20" style="border-color: color-mix(in srgb, var(--primary) 20%, transparent);">
                                <div class="card-header">
                                    <h3 class="card-title flex items-center gap-2 text-primary" style="color: var(--primary);">
                                        <i data-lucide="play" class="lucide"></i>
                                        執行回測
                                    </h3>
                                </div>
                                <div class="card-content space-y-4">
                                    <button
                                        id="backtestBtn"
                                        class="w-full btn-primary text-lg py-6 rounded-lg font-semibold transition duration-150 ease-in-out flex items-center justify-center"
                                    >
                                        <i data-lucide="play" class="lucide mr-2"></i>
                                        開始回測
                                    </button>

                                    <div class="grid grid-cols-1 gap-2">
                                        <button id="resetBtn" class="btn-outline text-sm py-2 rounded-md font-medium transition duration-150 ease-in-out flex items-center justify-center">
                                            <i data-lucide="refresh-cw" class="lucide-sm mr-1"></i>
                                            重置設定
                                        </button>
                                        <button id="randomizeBtn" class="btn-outline text-sm py-2 rounded-md font-medium transition duration-150 ease-in-out flex items-center justify-center">
                                            <i data-lucide="shuffle" class="lucide-sm mr-1"></i>
                                            隨機參數
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Right Panel - Tabs Content -->
                        <div class="space-y-6 lg:overflow-y-auto lg:h-screen lg:pb-8 overflow-x-hidden right-panel" style="scrollbar-width: thin; scrollbar-color: var(--muted) var(--background);">
                            <!-- Tab Navigation -->
                            <div class="card sticky-header">
                                <div class="card-header pb-4">
                                    <div class="border-b border-border" style="border-color: var(--border);">
                                        <nav class="flex space-x-8 overflow-x-auto">
                                            <button
                                                class="tab py-4 px-1 border-b-2 border-primary text-primary font-medium text-xs whitespace-nowrap"
                                                style="color: var(--primary); border-color: var(--primary);"
                                                data-tab="summary"
                                                aria-current="page"
                                            >
                                                <i data-lucide="clipboard-list" class="lucide-sm inline mr-1"></i>摘要
                                            </button>
                                            <button
                                                class="tab py-4 px-1 border-b-2 border-transparent text-muted hover:text-foreground font-medium text-xs whitespace-nowrap"
                                                style="color: var(--muted-foreground);"
                                                data-tab="staging-optimizer"
                                            >
                                                <i data-lucide="wand-2" class="lucide-sm inline mr-1"></i>分段優化
                                            </button>
                                            <button
                                                class="tab py-4 px-1 border-b-2 border-transparent text-muted hover:text-foreground font-medium text-xs whitespace-nowrap"
                                                style="color: var(--muted-foreground);"
                                                data-tab="performance"
                                            >
                                                <i data-lucide="bar-chart-3" class="lucide-sm inline mr-1"></i>績效分析
                                            </button>
                                            <button
                                                class="tab py-4 px-1 border-b-2 border-transparent text-muted hover:text-foreground font-medium text-xs whitespace-nowrap"
                                                style="color: var(--muted-foreground);"
                                                data-tab="trades"
                                            >
                                                <i data-lucide="receipt" class="lucide-sm inline mr-1"></i>交易記錄
                                            </button>
                                            <button
                                                class="tab py-4 px-1 border-b-2 border-transparent text-muted hover:text-foreground font-medium text-xs whitespace-nowrap"
                                                style="color: var(--muted-foreground);"
                                                data-tab="optimization"
                                            >
                                                <i data-lucide="sliders-horizontal" class="lucide-sm inline mr-1"></i>參數優化
                                            </button>
                                            <button
                                                class="tab py-4 px-1 border-b-2 border-transparent text-muted hover:text-foreground font-medium text-xs whitespace-nowrap"
                                                style="color: var(--muted-foreground);"
                                                data-tab="batch-optimization"
                                            >
                                                <i data-lucide="users" class="lucide-sm inline mr-1"></i>批量優化
                                            </button>
                                            <button
                                                class="tab py-4 px-1 border-b-2 border-transparent text-muted hover:text-foreground font-medium text-xs whitespace-nowrap"
                                                style="color: var(--muted-foreground);"
                                                data-tab="rolling-test"
                                            >
                                                <i data-lucide="repeat" class="lucide-sm inline mr-1"></i>滾動測試
                                            </button>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Summary Tab -->
                            <div class="tab-content active space-y-6" id="summary-tab">
                                <!-- Strategy Status Card -->
                                <div class="card shadow-lg summary-card" id="strategy-status-card">
                                    <div class="card-header pb-4">
                                        <div class="space-y-2">
                                            <div class="flex items-center gap-2">
                                                <span id="strategy-status-badge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-semibold tracking-wider uppercase" style="background-color: color-mix(in srgb, var(--muted) 28%, transparent); color: var(--muted-foreground);">等待開賽</span>
                                                <span id="strategy-status-diff" class="text-xs font-semibold hidden" style="color: var(--muted-foreground);"></span>
                                            </div>
                                            <h3 id="strategy-status-title" class="text-lg font-semibold" style="color: var(--foreground);">策略戰況尚未更新</h3>
                                            <p id="strategy-status-subtitle" class="text-xs leading-relaxed" style="color: var(--muted-foreground);">
                                                完成回測後，這張戰報會綜合策略與買入持有的差距、指標體檢與建議行動，請優先回到此卡片檢視結果。
                                            </p>
                                        </div>
                                    </div>
                                    <div class="card-content space-y-3">
                                        <div id="strategy-status-detail" class="text-sm leading-relaxed space-y-2" style="color: var(--muted-foreground);">
                                            <p>• 等待您啟動回測，我們會追蹤策略與買入持有的差距並提出指標體檢。</p>
                                            <p>• 回測完成後，這裡會用條列式寫給散戶看的戰況懶人包。</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chart Area -->
                                <div class="card shadow-lg summary-card">
                                    <div class="card-header">
                                        <h3 class="card-title">淨值曲線圖</h3>
                                    </div>
                                    <div class="card-content">
                                        <div id="chart-container" class="h-96 bg-muted/20 rounded-lg flex items-center justify-center border-2 border-dashed relative" style="background-color: color-mix(in srgb, var(--muted) 20%, transparent); border-color: var(--card);">
                                            <canvas id="chart" class="w-full h-full absolute inset-0"></canvas>
                                            <div class="text-muted text-center" style="color: var(--muted-foreground);">
                                                <i data-lucide="bar-chart-3" class="lucide w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                                <p>執行回測後將顯示淨值曲線</p>
                                            </div>
                                        </div>
                                        <div id="priceInspectorControls" class="mt-4 hidden flex flex-wrap items-center gap-2 justify-between sm:justify-start">
                                            <button
                                                type="button"
                                                id="openPriceInspector"
                                                class="px-3 py-1.5 text-[11px] font-medium rounded-md border transition-colors"
                                                style="border-color: var(--border); color: var(--foreground); background-color: var(--background);"
                                            >
                                                查看區間價格
                                            </button>
                                            <span
                                                id="priceInspectorSummary"
                                                class="text-[11px] text-muted-foreground"
                                                style="color: var(--muted-foreground);"
                                            ></span>
                                        </div>
                                        <div id="trend-legend" class="mt-3 hidden flex items-center gap-3 text-xs text-muted-foreground overflow-x-auto whitespace-nowrap" aria-hidden="true">
                                            <div class="flex items-center gap-2 shrink-0">
                                                <span class="w-3 h-3 rounded-sm border" style="background-color: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.38);"></span>
                                                <span>牛市・高波動</span>
                                            </div>
                                            <div class="flex items-center gap-2 shrink-0">
                                                <span class="w-3 h-3 rounded-sm border" style="background-color: rgba(148, 163, 184, 0.18); border-color: rgba(148, 163, 184, 0.38);"></span>
                                                <span>盤整區域</span>
                                            </div>
                                            <div class="flex items-center gap-2 shrink-0">
                                                <span class="w-3 h-3 rounded-sm border" style="background-color: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.35);"></span>
                                                <span>熊市・高波動</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card shadow-lg summary-card" id="trend-analysis-card" data-collapsed="true">
                                    <div class="card-header">
                                        <button
                                            id="trendAnalysisToggle"
                                            type="button"
                                            class="w-full flex items-center justify-between gap-3 text-left"
                                            aria-expanded="false"
                                            aria-controls="trend-analysis-content"
                                        >
                                            <span class="card-title flex items-center gap-3">
                                                <span class="trend-toggle-indicator" aria-hidden="true">＋</span>
                                                <i data-lucide="line-chart" class="lucide-sm" aria-hidden="true"></i>
                                                <span>趨勢區間評估</span>
                                            </span>
                                            <span class="text-xs text-muted-foreground" data-trend-toggle-label>展開分析</span>
                                        </button>
                                    </div>
                                    <div id="trend-analysis-content" class="card-content space-y-4 hidden" aria-hidden="true">
                                        <p class="text-xs leading-relaxed" style="color: var(--muted-foreground);">
                                            將價格序列拆成牛市・高波動、熊市・高波動與盤整三態，結合 ADX、布林帶寬與 ATR 比率作為趨勢／盤整門檻，並以二維 HMM 訓練趨勢狀態；滑桿 0→10 經 1000 組覆蓋率測試校準，可快速切換預設最佳值 5 附近的信心門檻，數值越高門檻越寬鬆、趨勢覆蓋越接近 80% 以上。
                                        </p>
                                        <div id="trend-card-legend" class="flex items-center gap-3 text-xs text-muted-foreground overflow-x-auto whitespace-nowrap">
                                            <div class="flex items-center gap-2 shrink-0">
                                                <span class="w-3 h-3 rounded-sm border" style="background-color: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.38);"></span>
                                                <span>牛市・高波動</span>
                                            </div>
                                            <div class="flex items-center gap-2 shrink-0">
                                                <span class="w-3 h-3 rounded-sm border" style="background-color: rgba(148, 163, 184, 0.18); border-color: rgba(148, 163, 184, 0.38);"></span>
                                                <span>盤整區域</span>
                                            </div>
                                            <div class="flex items-center gap-2 shrink-0">
                                                <span class="w-3 h-3 rounded-sm border" style="background-color: rgba(34, 197, 94, 0.2); border-color: rgba(34, 197, 94, 0.35);"></span>
                                                <span>熊市・高波動</span>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <div class="flex items-center justify-between">
                                                <label for="trendSensitivitySlider" class="text-xs font-medium" style="color: var(--foreground);">狀態精細度</label>
                                                <span id="trendSensitivityValue" class="text-xs font-semibold" style="color: var(--primary);">平均狀態信心：—</span>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <span class="text-[11px]" style="color: var(--muted-foreground);">0 精細</span>
                                                <input type="range" id="trendSensitivitySlider" min="0" max="10" step="0.1" value="5" class="flex-1 trend-slider">
                                                <span class="text-[11px]" style="color: var(--muted-foreground);">10 寬鬆</span>
                                            </div>
                                            <p id="trend-threshold-text" class="text-[11px] leading-relaxed hidden" style="color: var(--muted-foreground);"></p>
                                        </div>
                                        <div id="trend-summary-placeholder" class="rounded-lg border border-dashed p-4 text-xs" style="border-color: color-mix(in srgb, var(--border) 80%, transparent); color: var(--muted-foreground);">
                                            執行回測後會顯示牛市・高波動／盤整／熊市・高波動三態的覆蓋率、複利報酬與 Sigmoid 補償統計。
                                        </div>
                                        <div id="trend-summary-meta" class="hidden text-[11px]" style="color: var(--muted-foreground);"></div>
                                        <div id="trend-summary-container" class="trend-summary-grid"></div>
                                    </div>
                                </div>

                                <div class="card shadow-lg summary-card">
                                    <div class="card-header">
                                        <h3 class="card-title">回測摘要</h3>
                                    </div>
                                    <div class="card-content">
                                        <div id="backtest-result" class="summary-result-container">
                                            <div id="backtest-result-placeholder" class="backtest-result-placeholder">
                                                執行回測後將顯示詳細結果
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Summary Results -->
                            </div>

                            <!-- Staging Optimizer Tab -->
                            <div class="tab-content hidden" id="staging-optimizer-tab">
                                <div class="card shadow-lg mb-6">
                                    <div class="card-header">
                                        <h3 class="card-title flex items-center gap-2">
                                            <i data-lucide="sparkles" class="lucide text-accent" style="color: var(--accent);"></i>
                                            分段優化助手
                                        </h3>
                                        <p class="card-description">自動評估多組進場與出場分段，尋找較佳的資金配置方式</p>
                                    </div>
                                    <div class="card-content space-y-5">
                                        <p class="text-sm leading-relaxed" style="color: var(--muted-foreground);">
                                            系統會針對目前策略參數依序測試不同的進出場分段組合，使用年化報酬、夏普比率與最大回撤做為評估依據，協助您快速找出較穩健的資金調度節奏。
                                        </p>
                                        <div class="flex flex-wrap items-center gap-3">
                                            <button
                                                id="stagingOptimizationBtn"
                                                class="btn-primary flex items-center gap-2 text-sm px-4 py-2 rounded-md font-semibold"
                                            >
                                                <i data-lucide="play-circle" class="lucide-sm"></i>
                                                一鍵優化分段策略
                                            </button>
                                            <button
                                                id="applyStagingOptimizationBtn"
                                                class="btn-outline flex items-center gap-2 text-sm px-4 py-2 rounded-md font-medium"
                                                disabled
                                            >
                                                <i data-lucide="check" class="lucide-sm"></i>
                                                套用推薦分段
                                            </button>
                                            <span class="text-[11px]" style="color: var(--muted-foreground);">
                                                建議先執行一次回測或確認參數無誤，再啟動自動優化。
                                            </span>
                                        </div>
                                        <div id="staging-optimization-status" class="text-sm" style="color: var(--muted-foreground);">
                                            尚未執行分段優化。
                                        </div>
                                        <div id="staging-optimization-progress" class="hidden space-y-2">
                                            <div class="w-full bg-muted rounded-full h-2" style="background-color: var(--muted);">
                                                <div id="staging-optimization-progress-bar" class="bg-accent h-2 rounded-full transition-all duration-300" style="width: 0%; background-color: var(--accent);"></div>
                                            </div>
                                        </div>
                                        <div id="staging-optimization-results" class="hidden space-y-4">
                                            <div id="staging-optimization-summary" class="text-sm" style="color: var(--foreground);"></div>
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full divide-y divide-border text-sm" style="border-color: var(--border);">
                                                    <thead class="bg-muted" style="background-color: var(--muted);">
                                                        <tr>
                                                            <th class="px-3 py-2 text-left font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">排名</th>
                                                            <th class="px-3 py-2 text-left font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">進場分段 (%)</th>
                                                            <th class="px-3 py-2 text-left font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">進場條件</th>
                                                            <th class="px-3 py-2 text-left font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">出場分段 (%)</th>
                                                            <th class="px-3 py-2 text-left font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">出場條件</th>
                                                            <th class="px-3 py-2 text-left font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">年化報酬</th>
                                                            <th class="px-3 py-2 text-left font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">夏普比率</th>
                                                            <th class="px-3 py-2 text-left font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">最大回撤</th>
                                                            <th class="px-3 py-2 text-left font-medium uppercase tracking-wider" style="color: var(--muted-foreground);">交易次數</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="staging-optimization-table-body" class="bg-background divide-y divide-border" style="background-color: var(--background); border-color: var(--border);"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card border border-dashed" style="border-color: color-mix(in srgb, var(--border) 65%, transparent);">
                                    <div class="card-header pb-3">
                                        <h4 class="card-title text-sm font-semibold">評估邏輯與建議</h4>
                                    </div>
                                    <div class="card-content space-y-3 text-sm" style="color: var(--muted-foreground);">
                                        <p>• 進場測試覆蓋單段滿倉、兩段拉回加碼、三段金字塔與倒金字塔等常見配置，出場則評估等分分批、前重後輕與梯形獲利方式；每一組配置都會再套用「價格回落加碼 / 策略訊號再觸發」與「價格走高分批出場 / 策略訊號再觸發」條件，總計最多 4 × 42 組測試。若進場或出場僅有單段 100% 配置，系統會自動略過條件排列僅執行一次基準測試，加快評估速度。</p>
                                        <p>• 排序以年化報酬為主、夏普比率為次、最大回撤為輔，若報酬相近會優先推薦回撤較小且風險調整後報酬較佳的組合。</p>
                                        <p>• 結果表新增「進場條件」「出場條件」欄位，協助辨識使用價格或訊號觸發；套用推薦分段時會同步更新對應條件，仍可再微調百分比或模式，建議重新回測確認與個人風險承受度是否一致。</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Tab -->
                            <div class="tab-content hidden" id="performance-tab">
                                <div class="card shadow-lg">
                                    <div class="card-header">
                                        <h3 class="card-title">期間績效分析</h3>
                                    </div>
                                    <div class="card-content">
                                        <div
                                            id="performance-table-container"
                                            class="overflow-x-auto min-h-[200px] flex items-center justify-center border-2 border-dashed rounded-lg"
                                            style="border-color: var(--card);"
                                        >
                                            <p class="text-muted" style="color: var(--muted-foreground);">請先執行回測以生成期間績效數據。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Trades Tab -->
                            <div class="tab-content hidden" id="trades-tab">
                                <div class="card shadow-lg">
                                    <div class="card-header">
                                        <h3 class="card-title">交易記錄</h3>
                                    </div>
                                    <div class="card-content">
                                        <div
                                            id="trade-results"
                                            class="min-h-[900px] w-full border-2 border-dashed rounded-lg p-6 overflow-y-auto"
                                            style="border-color: var(--card);"
                                        >
                                            <div class="w-full h-full flex items-center justify-center">
                                                <p class="text-xs text-muted-foreground" style="color: var(--muted-foreground);">執行回測後將顯示交易明細</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Optimization Tab -->
                            <div class="tab-content hidden" id="optimization-tab">
                                <div class="card shadow-lg">
                                    <div class="card-header">
                                        <h3 class="card-title flex items-center gap-2">
                                            <i data-lucide="zap" class="lucide text-accent" style="color: var(--accent);"></i>
                                            參數優化
                                        </h3>
                                        <p class="card-description">自動尋找最佳參數組合</p>
                                    </div>
                                    <div class="card-content space-y-6">
                                        <!-- 優化控制區域 -->
                                        <div class="card bg-background border border-border" style="background-color: var(--background); border-color: var(--border);">
                                            <div class="card-header">
                                                <h4 class="card-title flex items-center gap-2">
                                                    <i data-lucide="sliders-horizontal" class="lucide text-primary" style="color: var(--primary);"></i>
                                                    優化控制
                                                </h4>
                                            </div>
                                            <div class="card-content">
                                                <!-- 做多策略優化 -->
                                                <div class="mb-6">
                                                    <h5 class="text-md font-semibold text-foreground mb-3" style="color: var(--foreground);">做多策略優化</h5>
                                                    <div class="grid md:grid-cols-3 gap-4">
                                                        <div class="flex items-center border border-border rounded-md" style="border-color: var(--border);">
                                                            <button id="optimizeEntryBtn" class="btn-primary text-sm font-medium rounded-l-md px-4 py-2 flex items-center whitespace-nowrap border-r border-border" style="border-color: var(--border);">
                                                                <i data-lucide="settings" class="lucide-sm mr-1"></i>
                                                                優化進場
                                                            </button>
                                                            <select
                                                                id="optimizeEntryParamSelect"
                                                                class="flex-grow px-2 py-2 bg-input text-foreground text-sm rounded-r-md focus:outline-none"
                                                                style="background-color: var(--input); color: var(--foreground);"
                                                            ></select>
                                                        </div>

                                                        <div class="flex items-center border border-border rounded-md" style="border-color: var(--border);">
                                                            <button id="optimizeExitBtn" class="btn-secondary text-sm font-medium rounded-l-md px-4 py-2 flex items-center whitespace-nowrap border-r border-border" style="border-color: var(--border);">
                                                                <i data-lucide="wrench" class="lucide-sm mr-1"></i>
                                                                優化出場
                                                            </button>
                                                            <select
                                                                id="optimizeExitParamSelect"
                                                                class="flex-grow px-2 py-2 bg-input text-foreground text-sm rounded-r-md focus:outline-none"
                                                                style="background-color: var(--input); color: var(--foreground);"
                                                            ></select>
                                                        </div>

                                                        <div class="flex items-center border border-border rounded-md" style="border-color: var(--border);">
                                                            <button id="optimizeRiskBtn" class="btn-outline text-sm font-medium rounded-l-md px-4 py-2 flex items-center whitespace-nowrap border-r border-border" style="border-color: var(--border);">
                                                                <i data-lucide="sliders-horizontal" class="lucide-sm mr-1"></i>
                                                                優化風控
                                                            </button>
                                                            <select
                                                                id="optimizeRiskParamSelect"
                                                                class="flex-grow px-2 py-2 bg-input text-foreground text-sm rounded-r-md focus:outline-none"
                                                                style="background-color: var(--input); color: var(--foreground);"
                                                            >
                                                                <option value="stopLoss">停損 (%)</option>
                                                                <option value="takeProfit">停利 (%)</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 做空策略優化 -->
                                                <div>
                                                    <h5 class="text-md font-semibold text-foreground mb-3" style="color: var(--foreground);">做空策略優化</h5>
                                                    <div class="grid md:grid-cols-2 gap-4">
                                                        <div class="flex items-center border border-border rounded-md" style="border-color: var(--border);">
                                                            <button id="optimizeShortEntryBtn" class="btn-outline text-sm font-medium rounded-l-md px-4 py-2 flex items-center whitespace-nowrap border-r border-border" style="border-color: var(--border);">
                                                                <i data-lucide="trending-down" class="lucide-sm mr-1"></i>
                                                                優化做空進場
                                                            </button>
                                                            <select
                                                                id="optimizeShortEntryParamSelect"
                                                                class="flex-grow px-2 py-2 bg-input text-foreground text-sm rounded-r-md focus:outline-none"
                                                                style="background-color: var(--input); color: var(--foreground);"
                                                            ></select>
                                                        </div>
                                                        <div class="flex items-center border border-border rounded-md" style="border-color: var(--border);">
                                                            <button id="optimizeShortExitBtn" class="btn-outline text-sm font-medium rounded-l-md px-4 py-2 flex items-center whitespace-nowrap border-r border-border" style="border-color: var(--border);">
                                                                <i data-lucide="trending-up" class="lucide-sm mr-1"></i>
                                                                優化回補出場
                                                            </button>
                                                            <select
                                                                id="optimizeShortExitParamSelect"
                                                                class="flex-grow px-2 py-2 bg-input text-foreground text-sm rounded-r-md focus:outline-none"
                                                                style="background-color: var(--input); color: var(--foreground);"
                                                            ></select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 優化進度區域 -->
                                        <div id="optimization-progress-section" class="card bg-primary/5 border-2 border-primary/20 hidden" style="background-color: color-mix(in srgb, var(--primary) 5%, transparent); border-color: color-mix(in srgb, var(--primary) 20%, transparent);">
                                            <div class="card-header">
                                                <h4 class="card-title flex items-center gap-2">
                                                    <i data-lucide="loader" class="lucide text-primary animate-spin" style="color: var(--primary);"></i>
                                                    優化進行中
                                                </h4>
                                            </div>
                                            <div class="card-content">
                                                <div class="mb-3">
                                                    <span id="optimization-status-text" class="text-foreground font-medium" style="color: var(--foreground);">⌛ 準備優化...</span>
                                                </div>
                                                <div class="w-full bg-muted rounded-full h-3 shadow-inner" style="background-color: var(--muted);">
                                                    <div 
                                                        id="optimization-progress-bar" 
                                                        class="bg-primary h-3 rounded-full transition-all duration-500 ease-out"
                                                        style="width: 0%; background-color: var(--primary);"
                                                    ></div>
                                                </div>
                                                <div class="mt-2 text-sm text-muted font-medium" style="color: var(--muted-foreground);">
                                                    進度: <span id="optimization-progress-text" class="text-primary" style="color: var(--primary);">0%</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 優化結果區域 -->
                                        <div class="card bg-background border border-border" style="background-color: var(--background); border-color: var(--border);">
                                            <div class="card-header">
                                                <h4 id="optimization-title" class="card-title flex items-center gap-2">
                                                    <i data-lucide="trending-up" class="lucide text-primary" style="color: var(--primary);"></i>
                                                    優化結果
                                                </h4>
                                            </div>
                                            <div class="card-content">
                                                <div id="optimization-results" class="optimization-results">
                                                    <p class="text-muted" style="color: var(--muted-foreground);">請選擇要優化的策略參數，然後點選優化按鈕開始優化。</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Batch Optimization Tab -->
                            <div class="tab-content hidden" id="batch-optimization-tab">
                                <div class="card shadow-lg">
                                    <div class="card-header">
                                        <h3 class="card-title flex items-center gap-2">
                                            <i data-lucide="users" class="lucide text-primary" style="color: var(--primary);"></i>
                                            批量策略優化
                                        </h3>
                                        <p class="card-description">同時測試多種策略組合</p>
                                    </div>
                                    <div class="card-content space-y-6">
                                        <div id="batch-optimization-content">
                                            <div class="space-y-6">
                                                <!-- 策略選擇區域 -->
                                                <div class="card bg-background border border-border" style="background-color: var(--background); border-color: var(--border);">
                                                    <div class="card-header">
                                                        <h4 class="card-title flex items-center gap-2">
                                                            <i data-lucide="settings" class="lucide text-primary" style="color: var(--primary);"></i>
                                                            策略組合選擇
                                                        </h4>
                                                    </div>
                                                    <div class="card-content">
                                                        <div class="grid md:grid-cols-2 gap-4">
                                                            <div>
                                                                <label class="block text-xs font-medium text-foreground mb-2" style="color: var(--foreground);">買入策略 (可多選)</label>
                                                                <div id="buy-strategies-list" class="space-y-2 max-h-48 overflow-y-auto border border-border rounded-md p-3" style="border-color: var(--border);">
                                                                    <!-- 動態生成買入策略選項 -->
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <label class="block text-xs font-medium text-foreground mb-2" style="color: var(--foreground);">賣出策略 (可多選)</label>
                                                                <div id="sell-strategies-list" class="space-y-2 max-h-48 overflow-y-auto border border-border rounded-md p-3" style="border-color: var(--border);">
                                                                    <!-- 動態生成賣出策略選項 -->
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center gap-2 mt-4">
                                                            <button id="select-all-buy" class="btn-outline text-sm py-2 px-3 rounded">全選買入</button>
                                                            <button id="select-all-sell" class="btn-outline text-sm py-2 px-3 rounded">全選賣出</button>
                                                            <button id="clear-all" class="btn-outline text-sm py-2 px-3 rounded">清除全部</button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- 優化設定區域 -->
                                                <div class="card bg-background border border-border" style="background-color: var(--background); border-color: var(--border);">
                                                    <div class="card-header">
                                                        <h4 class="card-title flex items-center gap-2">
                                                            <i data-lucide="sliders-horizontal" class="lucide text-accent" style="color: var(--accent);"></i>
                                                            優化設定
                                                        </h4>
                                                    </div>
                                                    <div class="card-content space-y-4">
                                                        <div>
                                                            <h4 class="font-medium text-foreground mb-3" style="color: var(--foreground);">優化目標指標</h4>
                                                            <div class="flex flex-wrap gap-4">
                                                                <label class="flex items-center">
                                                                    <input type="radio" name="batch-target-metric" value="annualizedReturn" checked class="mr-2" />
                                                                    <span class="text-sm" style="color: var(--foreground);">年化報酬率</span>
                                                                </label>
                                                                <label class="flex items-center">
                                                                    <input type="radio" name="batch-target-metric" value="sharpeRatio" class="mr-2" />
                                                                    <span class="text-sm" style="color: var(--foreground);">夏普比率</span>
                                                                </label>
                                                                <label class="flex items-center">
                                                                    <input type="radio" name="batch-target-metric" value="sortinoRatio" class="mr-2" />
                                                                    <span class="text-sm" style="color: var(--foreground);">索提諾比率</span>
                                                                </label>
                                                                <label class="flex items-center">
                                                                    <input type="radio" name="batch-target-metric" value="maxDrawdown" class="mr-2" />
                                                                    <span class="text-sm" style="color: var(--foreground);">最大回撤</span>
                                                                </label>
                                                            </div>
                                                        </div>
                                                        <div class="grid md:grid-cols-3 gap-4">
                                                            <div>
                                                                <label for="batch-optimize-parameter-trials" class="block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">參數優化次數</label>
                                                                <input type="number" id="batch-optimize-parameter-trials" value="100" min="10" max="1000" step="10" class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);" />
                                                                <p class="text-xs text-muted-foreground mt-1" style="color: var(--muted-foreground);">對每個策略進行參數優化的測試次數</p>
                                                            </div>
                                                            <div>
                                                                <label for="batch-optimize-concurrency" class="block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">優化併發數</label>
                                                                <input type="number" id="batch-optimize-concurrency" value="4" min="1" max="32" step="1" title="建議設定為 CPU 實體/邏輯核心數（navigator.hardwareConcurrency），較高併發會增加 CPU 與記憶體負載" class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);" />
                                                                <p class="text-xs text-muted-foreground mt-1" style="color: var(--muted-foreground);">建議值：≤ CPU 核心數（若瀏覽器支援）。預設 4。</p>
                                                            </div>
                                                            <div>
                                                                <label for="batch-optimize-iteration-limit" class="block text-xs font-medium text-foreground mb-1" style="color: var(--foreground);">迭代上限 (迭代次數上限)</label>
                                                                <input type="number" id="batch-optimize-iteration-limit" value="6" min="1" max="100" step="1" class="w-full px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);" />
                                                                <p class="text-xs text-muted-foreground mt-1" style="color: var(--muted-foreground);">控制每個組合在 "交替優化" 流程中的最大迭代次數。預設 6。</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- 執行按鈕 -->
                                            <div class="flex justify-center gap-4 mb-6 mt-6">
                                                <button id="start-batch-optimization" class="btn-primary px-8 py-3 rounded-lg font-semibold transition duration-150 ease-in-out flex items-center" style="background: linear-gradient(135deg, var(--primary), var(--accent));">
                                                    <i data-lucide="rocket" class="lucide mr-2"></i>
                                                    開始批量優化
                                                </button>
                                                <button id="stop-batch-optimization" class="btn-outline px-8 py-3 rounded-lg font-semibold transition duration-150 ease-in-out flex items-center hidden" style="border-color: var(--destructive); color: var(--destructive);">
                                                    <i data-lucide="square" class="lucide mr-2"></i>
                                                    停止優化
                                                </button>
                                            </div>
                                            
                                            <!-- 進度顯示 -->
                                            <div id="batch-optimization-progress" class="hidden mb-6">
                                                <div class="card bg-muted/20" style="background-color: color-mix(in srgb, var(--primary) 5%, transparent);">
                                                    <div class="card-header pb-3">
                                                        <div class="flex items-center justify-between">
                                                            <h5 class="card-title text-sm font-medium flex items-center">
                                                                <i id="batch-progress-hourglass" data-lucide="hourglass" class="lucide mr-2 animate-spin text-primary" style="color: var(--primary);"></i>
                                                                優化進度
                                                            </h5>
                                                            <span id="batch-progress-text" class="text-sm text-primary" style="color: var(--primary);">0%</span>
                                                        </div>
                                                    </div>
                                                    <div class="card-content space-y-4">
                                                        <div class="w-full bg-muted rounded-full h-3" style="background-color: var(--muted);">
                                                            <div id="batch-progress-bar" class="bg-primary h-3 rounded-full transition-all duration-300" style="width: 0%; background-color: var(--primary);"></div>
                                                        </div>
                                                        <div class="text-sm space-y-1">
                                                            <div id="batch-progress-detail" class="text-primary" style="color: var(--primary);">準備中...</div>
                                                            <div id="batch-progress-combination" class="font-medium text-primary" style="color: var(--primary);"></div>
                                                            <div id="batch-time-estimate" class="font-medium text-foreground" style="color: var(--foreground);"></div>
                                                            <div id="batch-long-wait-notice" class="hidden p-2 bg-accent/10 border border-accent/20 rounded text-accent" style="background-color: color-mix(in srgb, var(--accent) 10%, transparent); border-color: color-mix(in srgb, var(--accent) 20%, transparent); color: var(--accent);">
                                                                <i data-lucide="clock" class="lucide mr-1"></i>
                                                                由於測試次數與選擇策略較多，預估需要較長等待時間，請耐心等候...
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Worker 狀態面板 -->
                                            <div id="batch-worker-status-panel" class="hidden mb-6">
                                                <div class="card bg-background border border-border" style="background-color: var(--background); border-color: var(--border);">
                                                    <div class="card-header">
                                                        <div class="flex items-center justify-between">
                                                            <h5 class="card-title text-sm font-medium">運行狀態</h5>
                                                            <div class="text-xs text-muted-foreground" style="color: var(--muted-foreground);">
                                                                <span>併發上限: <strong id="batch-current-concurrency">-</strong></span>
                                                                <span class="ml-3">運行中: <strong id="batch-inflight-count">0</strong></span>
                                                            </div>
                                                        </div>
                                                        <div class="text-xs text-muted-foreground mt-1" style="color: var(--muted-foreground);">以下列出目前正在執行或剛完成的組合 (如多則顯示最新若干筆)</div>
                                                    </div>
                                                    <div class="card-content">
                                                        <div class="overflow-x-auto">
                                                            <table id="batch-worker-status-list" class="min-w-full divide-y divide-border text-sm" style="border-color: var(--border);">
                                                                <thead class="bg-muted" style="background-color: var(--muted);">
                                                                    <tr>
                                                                        <th class="px-2 py-1 text-left text-xs font-medium text-muted-foreground uppercase" style="color: var(--muted-foreground);">#</th>
                                                                        <th class="px-2 py-1 text-left text-xs font-medium text-muted-foreground uppercase" style="color: var(--muted-foreground);">買入策略</th>
                                                                        <th class="px-2 py-1 text-left text-xs font-medium text-muted-foreground uppercase" style="color: var(--muted-foreground);">賣出策略</th>
                                                                        <th class="px-2 py-1 text-left text-xs font-medium text-muted-foreground uppercase" style="color: var(--muted-foreground);">狀態</th>
                                                                        <th class="px-2 py-1 text-left text-xs font-medium text-muted-foreground uppercase" style="color: var(--muted-foreground);">執行時間</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="batch-worker-status-tbody" class="bg-background divide-y divide-border" style="background-color: var(--background); border-color: var(--border);"></tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 交叉優化進度顯示 -->
                                            <div id="cross-optimization-progress" class="hidden mb-6">
                                                <div class="card bg-muted/20" style="background-color: color-mix(in srgb, var(--accent) 5%, transparent);">
                                                    <div class="card-header pb-3">
                                                        <div class="flex items-center justify-between">
                                                            <h5 class="card-title text-sm font-medium flex items-center">
                                                                <i id="cross-progress-icon" data-lucide="arrow-right-left" class="lucide mr-2 animate-pulse text-accent" style="color: var(--accent);"></i>
                                                                交叉優化進度
                                                            </h5>
                                                            <span id="cross-progress-text" class="text-sm text-accent" style="color: var(--accent);">0%</span>
                                                        </div>
                                                    </div>
                                                    <div class="card-content space-y-4">
                                                        <div class="w-full bg-muted rounded-full h-3" style="background-color: var(--muted);">
                                                            <div id="cross-progress-bar" class="bg-accent h-3 rounded-full transition-all duration-300" style="width: 0%; background-color: var(--accent);"></div>
                                                        </div>
                                                        <div class="text-sm space-y-1">
                                                            <div id="cross-progress-detail" class="text-accent" style="color: var(--accent);">準備中...</div>
                                                            <div id="cross-progress-status" class="font-medium text-accent" style="color: var(--accent);"></div>
                                                            <div id="cross-time-estimate" class="font-medium text-foreground" style="color: var(--foreground);"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 結果顯示 -->
                                            <div id="batch-optimization-results" class="hidden">
                                                <div class="card bg-background border border-border" style="background-color: var(--background); border-color: var(--border);">
                                                    <div class="card-header">
                                                        <div class="flex items-center justify-between">
                                                            <h4 class="card-title text-lg font-semibold">優化結果</h4>
                                                            <div class="flex items-center gap-2">
                                                                <label class="text-xs text-muted-foreground" style="color: var(--muted-foreground);">排序依據:</label>
                                                                <select id="batch-sort-key" class="px-3 py-1 border border-border rounded text-sm bg-input text-foreground" style="border-color: var(--border); background-color: var(--input); color: var(--foreground);">
                                                                    <option value="annualizedReturn">年化報酬率</option>
                                                                    <option value="sharpeRatio">夏普比率</option>
                                                                    <option value="maxDrawdown">最大回撤</option>
                                                                    <option value="tradeCount">交易次數</option>
                                                                </select>
                                                                <button id="batch-sort-direction" class="px-2 py-1 btn-outline rounded text-sm">
                                                                    <i data-lucide="arrow-down" class="lucide"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-content">
                                                        <div class="overflow-x-auto">
                                                            <table id="batch-results-table" class="min-w-full divide-y divide-border" style="border-color: var(--border);">
                                                                <thead class="bg-muted" style="background-color: var(--muted);">
                                                                    <tr>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">排名</th>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">類型</th>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">買入策略</th>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">賣出策略</th>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">年化報酬率</th>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">夏普比率</th>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">索提諾比率</th>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">最大回撤</th>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">交易次數</th>
                                                                        <th class="px-3 py-2 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider" style="color: var(--muted-foreground);">操作</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="batch-results-tbody" class="bg-background divide-y divide-border" style="background-color: var(--background); border-color: var(--border);"></tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-content hidden" id="rolling-test-tab">
                                <div class="space-y-6">
                                    <div class="card">
                                        <div class="card-header flex flex-col gap-2">
                                            <h3 class="card-title text-base">滾動測試設定</h3>
                                            <p class="text-xs leading-relaxed" style="color: var(--muted-foreground);">
                                                參考國際量化機構常見的 Walk-Forward 測試（先以固定視窗訓練，再用下一段資料驗證），快速檢查策略在不同市況的穩健度。
                                                建議先在左側執行一次完整回測，以建立快取資料後再進行滾動測試。
                                            </p>
                                        </div>
                                        <div class="card-content">
                                            <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
                                                <label class="flex flex-col gap-1 text-xs font-medium" style="color: var(--foreground);">
                                                    訓練視窗（月）
                                                    <input id="rolling-training-months" data-rolling-input type="number" min="6" max="120" step="1" value="36" class="px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm" style="border-color: var(--border); background-color: var(--input);" />
                                                    <span class="text-[11px] font-normal" style="color: var(--muted-foreground);">多數 CTA 以 24~36 個月作為參數優化的基礎視窗。</span>
                                                </label>
                                                <label class="flex flex-col gap-1 text-xs font-medium" style="color: var(--foreground);">
                                                    測試視窗（月）
                                                    <input id="rolling-testing-months" data-rolling-input type="number" min="3" max="36" step="1" value="12" class="px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm" style="border-color: var(--border); background-color: var(--input);" />
                                                    <span class="text-[11px] font-normal" style="color: var(--muted-foreground);">常見做法為 6~12 個月，觀察策略換季後的續航力。</span>
                                                </label>
                                                <label class="flex flex-col gap-1 text-xs font-medium" style="color: var(--foreground);">
                                                    視窗平移（月）
                                                    <input id="rolling-step-months" data-rolling-input type="number" min="1" max="24" step="1" value="6" class="px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm" style="border-color: var(--border); background-color: var(--input);" />
                                                    <span class="text-[11px] font-normal" style="color: var(--muted-foreground);">建議設為測試視窗的長度，形成不重疊的 Walk-Forward 迭代。</span>
                                                </label>
                                                <label class="flex flex-col gap-1 text-xs font-medium" style="color: var(--foreground);">
                                                    測試至少成交筆數
                                                    <input id="rolling-min-trades" data-rolling-input type="number" min="1" max="200" step="1" value="10" class="px-3 py-2 border border-border rounded-md bg-input text-foreground focus:outline-none focus:ring-2 focus:ring-ring text-sm" style="border-color: var(--border); background-color: var(--input);" />
                                                    <span class="text-[11px] font-normal" style="color: var(--muted-foreground);">若小於門檻，將標註樣本不足。</span>
                                                </label>
                                                <fieldset class="flex flex-col gap-2 text-xs" style="color: var(--foreground);">
                                                    <legend class="font-medium">通過門檻（滾動測試）</legend>
                                                    <div class="grid gap-2 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5">
                                                        <label class="flex items-center gap-2">
                                                            <span class="min-w-[70px]">年化%</span>
                                                            <input id="rolling-threshold-ann" data-rolling-input type="number" min="0" max="100" step="0.1" value="8" class="w-full px-2 py-1 border border-border rounded-md bg-input text-foreground text-xs focus:outline-none focus:ring-1 focus:ring-ring" style="border-color: var(--border); background-color: var(--input);" />
                                                        </label>
                                                        <label class="flex items-center gap-2">
                                                            <span class="min-w-[70px]">Sharpe</span>
                                                            <input id="rolling-threshold-sharpe" data-rolling-input type="number" min="0" max="5" step="0.1" value="1" class="w-full px-2 py-1 border border-border rounded-md bg-input text-foreground text-xs focus:outline-none focus:ring-1 focus:ring-ring" style="border-color: var(--border); background-color: var(--input);" />
                                                        </label>
                                                        <label class="flex items-center gap-2">
                                                            <span class="min-w-[70px]">Sortino</span>
                                                            <input id="rolling-threshold-sortino" data-rolling-input type="number" min="0" max="6" step="0.1" value="1.2" class="w-full px-2 py-1 border border-border rounded-md bg-input text-foreground text-xs focus:outline-none focus:ring-1 focus:ring-ring" style="border-color: var(--border); background-color: var(--input);" />
                                                        </label>
                                                        <label class="flex items-center gap-2">
                                                            <span class="min-w-[70px]">MaxDD%</span>
                                                            <input id="rolling-threshold-maxdd" data-rolling-input type="number" min="1" max="80" step="0.1" value="25" class="w-full px-2 py-1 border border-border rounded-md bg-input text-foreground text-xs focus:outline-none focus:ring-1 focus:ring-ring" style="border-color: var(--border); background-color: var(--input);" />
                                                        </label>
                                                        <label class="flex items-center gap-2">
                                                            <span class="min-w-[70px]">勝率%</span>
                                                            <input id="rolling-threshold-win" data-rolling-input type="number" min="0" max="100" step="0.1" value="45" class="w-full px-2 py-1 border border-border rounded-md bg-input text-foreground text-xs focus:outline-none focus:ring-1 focus:ring-ring" style="border-color: var(--border); background-color: var(--input);" />
                                                        </label>
                                                    </div>
                                                    <p class="text-[11px]" style="color: var(--muted-foreground);">門檻參考 QuantConnect、Tradestation、CME 顧問公司常見的 Walk-Forward 合格標準：Sharpe ≥ 1、Sortino ≥ 1.2、最大回撤 ≤ 25%。</p>
                                                </fieldset>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-header flex flex-col gap-2">
                                            <h3 class="card-title text-base">視窗規劃預覽</h3>
                                            <p class="text-xs" id="rolling-plan-range" style="color: var(--muted-foreground);"></p>
                                        </div>
                                        <div class="card-content space-y-4">
                                            <div class="flex flex-wrap items-center gap-3 text-xs" style="color: var(--muted-foreground);">
                                                <span id="rolling-plan-summary">尚未建立視窗</span>
                                                <span id="rolling-plan-warning" class="hidden px-2 py-1 rounded bg-amber-100 text-amber-700">請先執行一次主回測以產生快取資料</span>
                                            </div>
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full divide-y divide-border text-xs" style="border-color: var(--border);">
                                                    <thead class="bg-muted/40" style="background-color: color-mix(in srgb, var(--muted) 20%, transparent); color: var(--foreground);">
                                                        <tr>
                                                            <th class="px-3 py-2 text-left font-semibold">迭代</th>
                                                            <th class="px-3 py-2 text-left font-semibold">訓練期間</th>
                                                            <th class="px-3 py-2 text-left font-semibold">測試期間</th>
                                                            <th class="px-3 py-2 text-left font-semibold">測試交易日</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="rolling-plan-tbody" class="divide-y divide-border" style="border-color: var(--border);"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-content flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                                            <div>
                                                <h3 class="text-sm font-semibold" style="color: var(--foreground);">執行 Walk-Forward 測試</h3>
                                                <p class="text-xs mt-1 max-w-xl" style="color: var(--muted-foreground);">系統會依序重播每個滾動視窗，採用現有策略參數計算訓練期與測試期的報酬、風險與交易密度。過程中請勿關閉頁面。</p>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <button id="start-rolling-test" class="btn-primary px-6 py-2.5 rounded-lg font-semibold flex items-center gap-2" style="background: linear-gradient(135deg, var(--primary), color-mix(in srgb, var(--accent) 60%, var(--primary)));">
                                                    <i data-lucide="shuffle" class="lucide w-4 h-4"></i>
                                                    開始滾動測試
                                                </button>
                                                <button id="stop-rolling-test" class="btn-outline px-6 py-2.5 rounded-lg font-semibold hidden" style="border-color: var(--destructive); color: var(--destructive);">
                                                    <i data-lucide="square" class="lucide w-4 h-4"></i>
                                                    停止
                                                </button>
                                            </div>
                                        </div>
                                        <div id="rolling-progress-panel" class="card-content border-t hidden" style="border-color: var(--border);">
                                            <div class="flex flex-col gap-3">
                                                <div class="flex items-center justify-between text-xs" style="color: var(--foreground);">
                                                    <span id="rolling-progress-text">準備中...</span>
                                                    <span id="rolling-progress-percent">0%</span>
                                                </div>
                                                <div class="w-full h-2 rounded-full bg-muted" style="background-color: color-mix(in srgb, var(--muted) 20%, transparent);">
                                                    <div id="rolling-progress-bar" class="h-2 rounded-full" style="background-color: var(--primary); width: 0%;"></div>
                                                </div>
                                                <div class="flex flex-wrap items-center gap-3 text-[11px]" style="color: var(--muted-foreground);">
                                                    <span id="rolling-progress-phase">尚未開始</span>
                                                    <span id="rolling-progress-elapsed" class="hidden"></span>
                                                    <span id="rolling-progress-eta" class="hidden"></span>
                                                </div>
                                                <div id="rolling-progress-alert" class="hidden text-[11px] px-3 py-2 rounded border" style="border-color: color-mix(in srgb, var(--accent) 30%, transparent); color: var(--accent); background-color: color-mix(in srgb, var(--accent) 12%, transparent);"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="rolling-test-report" class="card hidden">
                                        <div class="card-header flex flex-col gap-2">
                                            <h3 class="card-title text-base">滾動測試報告</h3>
                                            <p id="rolling-report-intro" class="text-xs" style="color: var(--muted-foreground);"></p>
                                        </div>
                                        <div class="card-content space-y-6">
                                            <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-4" id="rolling-scoreboard"></div>
                                            <div class="p-4 border rounded-lg" style="border-color: var(--border); background-color: color-mix(in srgb, var(--primary) 4%, transparent);">
                                                <h4 class="text-sm font-semibold mb-2" style="color: var(--foreground);">總結</h4>
                                                <p id="rolling-score-summary" class="text-xs leading-relaxed" style="color: var(--muted-foreground);"></p>
                                            </div>
                                            <div>
                                                <h4 class="text-sm font-semibold mb-2" style="color: var(--foreground);">逐窗指標</h4>
                                                <div class="overflow-x-auto">
                                                    <table class="min-w-full divide-y divide-border text-xs" style="border-color: var(--border);">
                                                        <thead class="bg-muted/40" style="background-color: color-mix(in srgb, var(--muted) 20%, transparent); color: var(--foreground);">
                                                            <tr>
                                                                <th class="px-3 py-2 text-left font-semibold">迭代</th>
                                                                <th class="px-3 py-2 text-left font-semibold">測試期間</th>
                                                                <th class="px-3 py-2 text-right font-semibold">年化%</th>
                                                                <th class="px-3 py-2 text-right font-semibold">Sharpe</th>
                                                                <th class="px-3 py-2 text-right font-semibold">Sortino</th>
                                                                <th class="px-3 py-2 text-right font-semibold">MaxDD%</th>
                                                                <th class="px-3 py-2 text-right font-semibold">勝率%</th>
                                                                <th class="px-3 py-2 text-right font-semibold">交易數</th>
                                                                <th class="px-3 py-2 text-left font-semibold">評語</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="rolling-window-report" class="divide-y divide-border" style="border-color: var(--border);"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="text-[11px] leading-relaxed" style="color: var(--muted-foreground);">
                                                <p>評分公式結合多家券商及資產管理公司的 Walk-Forward 檢核：Sharpe 與 Sortino 反映報酬風險比，年化報酬衡量增長速度，最大回撤控制風險敞口，勝率確保樣本可靠性。總分 ≥ 85 為「專業合格」、70~84 屬於「可進一步驗證」、55~69 建議調整參數或加上風控，低於 55 則視為未通過。</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <footer class="py-12 mt-16" style="background-color: #f3f4f6; color: #374151;">
                <div class="container mx-auto px-4">
                    <div class="grid md:grid-cols-4 gap-8">
                        <div>
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center shadow-sm" style="background-color: #ffffff;">
                                    <!-- simple brand mark -->
                                    <svg width="28" height="20" viewBox="0 0 28 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden>
                                        <rect width="28" height="20" rx="4" fill="#0EA5A4" />
                                    </svg>
                                </div>
                                <div>
                                    <span class="text-lg font-bold" style="color: #0f172a;">LazyBacktest</span>
                                    <div class="text-xs" style="color: #6b7280;">台股回測系統</div>
                                </div>
                            </div>
                            <p class="text-sm mb-4" style="color: #6b7280;">先恭喜您，投資賺錢！</br> 如果這個網站幫助您投資順利</br> 或者單純想支持一下韭菜胖叔叔</br>歡迎斗內讓我可以上車繼續更新</br> 用奶粉發電，不再用愛發電</p>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-4" style="color: #374151;">Donate (斗內/贊助)</h4>
                            <ul class="space-y-2 text-sm">
                                <li>
                                    <a href="https://payment.opay.tw/Broadcaster/Donate/C0EB7741A027F28BA11ED9BDBEAD263A" target="_blank" rel="noopener" class="transition-colors" style="color: #6b7280;">歐付寶</a>
                                </li>
                                <li>
                                    <a href="https://p.ecpay.com.tw/8AB5D6F" target="_blank" rel="noopener" class="transition-colors" style="color: #6b7280;">綠界</a>
                                </li>
                                <li>
                                    <a href="https://www.paypal.com/ncp/payment/79RNTHL69MAPE" target="_blank" rel="noopener" class="transition-colors" style="color: #6b7280;">PayPal</a>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-4" style="color: #374151;">支援與幫助</h4>
                            <ul class="space-y-2 text-sm">
                                <li><a href="#" class="transition-colors" style="color: #6b7280;">使用教學</a></li>
                                <li><a href="#" class="transition-colors" style="color: #6b7280;">常見問題</a></li>
                                <li><a href="#" class="transition-colors" style="color: #6b7280;">寄信給我</a></li>
                                <li><a href="#" class="transition-colors" style="color: #6b7280;">社群討論</a></li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-4" style="color: #374151;">其他說明</h4>
                            <ul class="space-y-2 text-sm">
                                <li><a href="#" class="transition-colors" style="color: #6b7280;">隱私政策</a></li>
                                <li><a href="#" class="transition-colors" style="color: #6b7280;">免責聲明</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="border-t mt-8 pt-8 text-center text-sm" style="border-color: rgba(0,0,0,0.06); color: #6b7280;">
                        <p style="color: #6b7280;">鄉民內部測試版: 建議事項與 Bug，請聯絡信箱: <a href="mailto:smallwei0301@gmail.com" class="underline" style="color: #374151;">smallwei0301@gmail.com</a></p>
                        <p style="color: #9ca3af;">© 2025 LazyBacktest. 僅供教育與研究用途，不構成投資建議。</p>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script src="js/shared-lookback.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script src="js/backtest.js"></script>
    <script src="js/loader.js"></script>
    <script src="js/batch-optimization.js"></script>
    <script src="js/rolling-test.js"></script>
    
    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // 一鍵回測台積電功能
            const QUICK_BACKTEST_VERSION = 'LB-QUICK-KEYIN-20251114A';
            const quickBacktestBtn = document.getElementById('quickBacktestBtn');
            const quickBacktestKeywordEl = document.getElementById('quickBacktestKeyword');
            const quickBacktestDefaultLabelEl = document.getElementById('quickBacktestDefaultLabel');
            const quickBacktestStatusTextEl = document.getElementById('quickBacktestStatusText');
            const quickBacktestHintEl = document.getElementById('quickBacktestHint');

            if (quickBacktestBtn && quickBacktestKeywordEl && quickBacktestStatusTextEl) {
                const QUICK_DEFAULT = { keyword: '台積電', code: '2330', market: 'TWSE', name: '台積電' };
                const quickBacktestState = {
                    keyword: QUICK_DEFAULT.keyword,
                    resolution: { code: QUICK_DEFAULT.code, market: QUICK_DEFAULT.market, name: QUICK_DEFAULT.name },
                };
                let progressInterval = null;
                let currentProgress = 0;

                const refreshLucideIcons = () => {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                };

                const refreshButtonLabel = () => {
                    quickBacktestBtn.setAttribute(
                        'aria-label',
                        `一鍵回測${quickBacktestState.keyword || QUICK_DEFAULT.keyword}（可編輯）`
                    );
                };

                const setCaretVisibility = (isHidden) => {
                    if (!quickBacktestKeywordEl) return;
                    if (isHidden) {
                        quickBacktestKeywordEl.setAttribute('data-caret-hidden', 'true');
                    } else {
                        quickBacktestKeywordEl.removeAttribute('data-caret-hidden');
                    }
                };

                const sanitizeQuickKeyword = (raw) => {
                    if (typeof raw !== 'string') return '';
                    return raw
                        .replace(/[\n\r\t]+/g, ' ')
                        .replace(/\u00A0/g, ' ')
                        .replace(/\s{2,}/g, ' ')
                        .trim()
                        .slice(0, 18);
                };

                const toggleButtonState = (state, options = {}) => {
                    quickBacktestBtn.dataset.state = state;
                    if (state === 'idle') {
                        quickBacktestBtn.disabled = false;
                        quickBacktestBtn.style.opacity = '1';
                        quickBacktestStatusTextEl.classList.add('hidden');
                        if (quickBacktestDefaultLabelEl) {
                            quickBacktestDefaultLabelEl.classList.remove('hidden');
                        }
                        quickBacktestStatusTextEl.innerHTML = '';
                        refreshLucideIcons();
                        return;
                    }

                    if (state === 'progress') {
                        quickBacktestBtn.disabled = true;
                        quickBacktestBtn.style.opacity = '0.7';
                        if (quickBacktestDefaultLabelEl) {
                            quickBacktestDefaultLabelEl.classList.add('hidden');
                        }
                        quickBacktestStatusTextEl.classList.remove('hidden');
                        const progressText = Math.round(options.progress ?? 0);
                        quickBacktestStatusTextEl.innerHTML = `
                            <i data-lucide="loader-2" class="lucide mr-3 animate-spin"></i>
                            回測中...${progressText}%
                        `;
                        refreshLucideIcons();
                        return;
                    }

                    if (state === 'success') {
                        quickBacktestBtn.disabled = false;
                        quickBacktestBtn.style.opacity = '1';
                        if (quickBacktestDefaultLabelEl) {
                            quickBacktestDefaultLabelEl.classList.add('hidden');
                        }
                        quickBacktestStatusTextEl.classList.remove('hidden');
                        const message = options.message || '完成！請看下面績效表現';
                        quickBacktestStatusTextEl.innerHTML = `
                            <i data-lucide="check-circle" class="lucide mr-3"></i>
                            ${message}
                        `;
                        refreshLucideIcons();
                        return;
                    }

                    if (state === 'error') {
                        quickBacktestBtn.disabled = false;
                        quickBacktestBtn.style.opacity = '1';
                        if (quickBacktestDefaultLabelEl) {
                            quickBacktestDefaultLabelEl.classList.remove('hidden');
                        }
                        quickBacktestStatusTextEl.classList.add('hidden');
                        quickBacktestStatusTextEl.innerHTML = '';
                        refreshLucideIcons();
                    }
                };

                const updateHintDisplay = (resolution) => {
                    if (!quickBacktestHintEl) return;
                    if (resolution && resolution.code) {
                        const marketLabel = resolution.market && typeof getMarketDisplayName === 'function'
                            ? getMarketDisplayName(resolution.market)
                            : resolution.market || '';
                        const marketText = marketLabel ? `（${marketLabel}）` : '';
                        const displayName = resolution.name
                            ? resolution.name
                            : (resolution.code !== quickBacktestState.keyword ? quickBacktestState.keyword : '');
                        const nameText = displayName ? `（${displayName}）` : '';
                        quickBacktestHintEl.textContent = `將使用 ${resolution.code}${nameText}${marketText}進行一鍵回測。`;
                        quickBacktestHintEl.dataset.status = 'resolved';
                    } else {
                        quickBacktestHintEl.textContent = `找不到「${quickBacktestState.keyword}」對應的官方代碼，將以原文字嘗試回測。`;
                        quickBacktestHintEl.dataset.status = 'unresolved';
                    }
                };

                const setStockInputValue = (stockCode, options = {}) => {
                    const stockInput = document.getElementById('stockNo');
                    if (!stockInput) return;
                    const normalized = options.keepCase
                        ? (stockCode || '').trim()
                        : (stockCode || '').trim().toUpperCase();
                    if (!normalized) return;
                    if (stockInput.value.trim() === normalized) return;
                    stockInput.value = normalized;
                    stockInput.dispatchEvent(new Event('input', { bubbles: true }));
                };

                const updateMarketSelect = (market) => {
                    if (!market) return;
                    const marketSelect = document.getElementById('marketSelect');
                    if (!marketSelect) return;
                    if (marketSelect.value === market) return;
                    marketSelect.value = market;
                    marketSelect.dispatchEvent(new Event('change', { bubbles: true }));
                };

                const detectDirectStockCode = (keyword) => {
                    const raw = (keyword || '').trim();
                    if (!raw) return null;
                    const upper = raw.toUpperCase();
                    if (/^\d{4}$/.test(upper)) {
                        return { code: upper, market: 'TWSE' };
                    }
                    if (/^\d{5,6}$/.test(upper)) {
                        return { code: upper, market: upper.startsWith('00') ? 'TWSE' : null };
                    }
                    if (/^\d{4}[A-Z]$/.test(upper)) {
                        return { code: upper, market: null };
                    }
                    if (/^[A-Z]{1,6}(?:\.[A-Z]{1,3}|-[A-Z]{1,2})?$/.test(upper)) {
                        return { code: upper, market: 'US' };
                    }
                    return null;
                };

                const resolveKeywordToStock = async (keyword) => {
                    const trimmed = (keyword || '').trim();
                    if (!trimmed) {
                        return { ...QUICK_DEFAULT };
                    }

                    const direct = detectDirectStockCode(trimmed);
                    if (direct) {
                        const cached = typeof resolveCachedStockNameInfo === 'function'
                            ? resolveCachedStockNameInfo(direct.code, direct.market)
                            : null;
                        return {
                            code: direct.code,
                            market: cached?.market || direct.market || null,
                            name: cached?.info?.name || null,
                        };
                    }

                    if (trimmed.length < 2) {
                        return null;
                    }

                    const tokens = trimmed
                        .replace(/[，、,]+/g, ' ')
                        .split(/\s+/)
                        .map((token) => token.trim())
                        .filter(Boolean);

                    if (tokens.length === 0) {
                        return null;
                    }

                    if (typeof ensureTaiwanDirectoryReady === 'function') {
                        try {
                            await ensureTaiwanDirectoryReady({});
                        } catch (error) {
                            console.warn(`[${QUICK_BACKTEST_VERSION}] 台股官方清單載入失敗:`, error);
                        }
                    }

                    const directoryEntries = (typeof taiwanDirectoryState !== 'undefined'
                        && taiwanDirectoryState.entries instanceof Map)
                        ? Array.from(taiwanDirectoryState.entries.values())
                        : [];

                    let bestMatch = null;
                    for (const entry of directoryEntries) {
                        if (!entry || !entry.name || !entry.stockId) continue;
                        const entryName = entry.name;
                        const normalizedName = entryName.replace(/\s+/g, '');
                        const upperId = entry.stockId.toUpperCase();
                        let score = 0;
                        for (const token of tokens) {
                            const upperToken = token.toUpperCase();
                            if (upperId.includes(upperToken)) {
                                score += 6;
                            }
                            if (entryName.includes(token)) {
                                score += entryName.startsWith(token) ? 6 : 4;
                            } else if (normalizedName.includes(token)) {
                                score += 3;
                            }
                        }
                        if (score > 0) {
                            if (!bestMatch || score > bestMatch.score || (
                                score === bestMatch.score
                                && upperId < bestMatch.entry.stockId
                            )) {
                                bestMatch = { entry, score };
                            }
                        }
                    }

                    if (!bestMatch) {
                        return null;
                    }

                    return {
                        code: bestMatch.entry.stockId,
                        market: bestMatch.entry.market || null,
                        name: bestMatch.entry.name || null,
                    };
                };

                const commitQuickKeyword = async (options = {}) => {
                    const rawValue = quickBacktestKeywordEl.textContent || '';
                    const sanitized = sanitizeQuickKeyword(rawValue);
                    if (sanitized !== rawValue) {
                        quickBacktestKeywordEl.textContent = sanitized;
                    }
                    const keyword = sanitized || QUICK_DEFAULT.keyword;
                    if (!sanitized) {
                        quickBacktestKeywordEl.textContent = QUICK_DEFAULT.keyword;
                    }
                    quickBacktestState.keyword = keyword;
                    refreshButtonLabel();

                    const resolution = await resolveKeywordToStock(keyword);
                    if (resolution && resolution.code) {
                        quickBacktestState.resolution = resolution;
                        quickBacktestKeywordEl.removeAttribute('aria-invalid');
                        updateHintDisplay(resolution);
                        setStockInputValue(resolution.code);
                        updateMarketSelect(resolution.market);
                        return resolution;
                    }

                    quickBacktestState.resolution = { code: null, market: null, name: null };
                    quickBacktestKeywordEl.setAttribute('aria-invalid', 'true');
                    updateHintDisplay(null);
                    setStockInputValue(keyword, { keepCase: true });
                    if (!options.silent && typeof showStockName === 'function') {
                        showStockName(`找不到「${keyword}」對應的代碼`, 'error');
                    }
                    return null;
                };

                const startProgressCycle = () => {
                    currentProgress = 0;
                    toggleButtonState('progress', { progress: currentProgress });
                    if (progressInterval) {
                        clearInterval(progressInterval);
                    }
                    progressInterval = setInterval(() => {
                        currentProgress += Math.random() * 15 + 5;
                        if (currentProgress > 95) {
                            currentProgress = 95;
                        }
                        toggleButtonState('progress', { progress: currentProgress });
                    }, 800);
                };

                const stopProgressCycle = () => {
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                };

                const scheduleCompletionWatcher = () => {
                    const checkBacktestComplete = () => {
                        const resultElement = document.getElementById('backtest-result');
                        if (resultElement && resultElement.textContent.trim() !== '執行回測後將顯示詳細結果') {
                            stopProgressCycle();
                            toggleButtonState('success');
                            setTimeout(() => {
                                toggleButtonState('idle');
                            }, 3000);
                        } else {
                            setTimeout(checkBacktestComplete, 500);
                        }
                    };
                    setTimeout(checkBacktestComplete, 1800);
                };

                quickBacktestKeywordEl.addEventListener('focus', () => {
                    setCaretVisibility(true);
                });

                quickBacktestKeywordEl.addEventListener('blur', () => {
                    setCaretVisibility(false);
                    commitQuickKeyword({ silent: true });
                });

                quickBacktestKeywordEl.addEventListener('keydown', (event) => {
                    event.stopPropagation();
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        quickBacktestKeywordEl.blur();
                    }
                });

                quickBacktestKeywordEl.addEventListener('input', () => {
                    const sanitized = sanitizeQuickKeyword(quickBacktestKeywordEl.textContent || '');
                    if (quickBacktestKeywordEl.textContent !== sanitized) {
                        quickBacktestKeywordEl.textContent = sanitized;
                        const range = document.createRange();
                        range.selectNodeContents(quickBacktestKeywordEl);
                        range.collapse(false);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                    quickBacktestState.keyword = sanitized || QUICK_DEFAULT.keyword;
                    refreshButtonLabel();
                });

                quickBacktestKeywordEl.addEventListener('paste', (event) => {
                    event.preventDefault();
                    const text = sanitizeQuickKeyword((event.clipboardData || window.clipboardData).getData('text') || '');
                    const selection = window.getSelection();
                    if (!selection || selection.rangeCount === 0) return;
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(document.createTextNode(text));
                    range.collapse(false);
                    quickBacktestKeywordEl.dispatchEvent(new Event('input'));
                });

                quickBacktestKeywordEl.addEventListener('click', (event) => {
                    event.stopPropagation();
                });

                quickBacktestBtn.addEventListener('click', async () => {
                    if (quickBacktestBtn.dataset.state === 'progress') {
                        return;
                    }

                    stopProgressCycle();
                    await commitQuickKeyword({ silent: false });
                    const stockInput = document.getElementById('stockNo');
                    const targetCode = stockInput ? stockInput.value.trim() : '';
                    if (!targetCode) {
                        toggleButtonState('error');
                        return;
                    }

                    startProgressCycle();

                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setFullYear(endDate.getFullYear() - 1);

                    const startDateInput = document.getElementById('startDate');
                    const endDateInput = document.getElementById('endDate');
                    if (startDateInput) {
                        startDateInput.value = startDate.toISOString().split('T')[0];
                    }
                    if (endDateInput) {
                        endDateInput.value = endDate.toISOString().split('T')[0];
                    }

                    const backtestBtn = document.getElementById('backtestBtn');
                    if (backtestBtn) {
                        backtestBtn.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });
                        setTimeout(() => {
                            backtestBtn.click();
                            scheduleCompletionWatcher();
                        }, 800);
                    } else {
                        stopProgressCycle();
                        toggleButtonState('idle');
                    }
                });

                // 初始化提示與輸入框狀態
                quickBacktestKeywordEl.textContent = QUICK_DEFAULT.keyword;
                refreshButtonLabel();
                updateHintDisplay(quickBacktestState.resolution);
            }
            
            // Tab switching functionality with updated design
            document.querySelectorAll('[data-tab]').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Update button states
                    document.querySelectorAll('[data-tab]').forEach(btn => {
                        btn.className = 'tab py-4 px-1 border-b-2 border-transparent text-muted hover:text-foreground font-medium text-xs whitespace-nowrap';
                        btn.style.color = 'var(--muted-foreground)';
                        btn.style.borderColor = 'transparent';
                    });
                    this.className = 'tab py-4 px-1 border-b-2 border-primary text-primary font-medium text-xs whitespace-nowrap';
                    this.style.color = 'var(--primary)';
                    this.style.borderColor = 'var(--primary)';
                    
                    // Show corresponding content
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.add('hidden');
                        tab.classList.remove('active');
                    });
                    const targetTab = document.getElementById(tabName + '-tab');
                    if (targetTab) {
                        targetTab.classList.remove('hidden');
                        targetTab.classList.add('active');
                    }
                });
            });
            
            // Enhanced hover effects for tabs
            document.querySelectorAll('[data-tab]').forEach(button => {
                button.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('border-primary')) {
                        this.style.color = 'var(--foreground)';
                        this.style.borderColor = 'color-mix(in srgb, var(--border) 60%, transparent)';
                    }
                });
                
                button.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('border-primary')) {
                        this.style.color = 'var(--muted-foreground)';
                        this.style.borderColor = 'transparent';
                    }
                });
            });
            
            // Enhanced button hover effects
            document.querySelectorAll('.btn-outline').forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'var(--accent)';
                    this.style.color = 'var(--accent-foreground)';
                    this.style.borderColor = 'var(--accent)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = 'var(--foreground)';
                    this.style.borderColor = 'var(--border)';
                });
            });
            
            // Primary button hover effects
            document.querySelectorAll('.btn-primary').forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'color-mix(in srgb, var(--primary) 90%, black)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'var(--primary)';
                });
            });
            
            // Secondary button hover effects  
            document.querySelectorAll('.btn-secondary').forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'color-mix(in srgb, var(--secondary) 90%, black)';
                });
                
                button.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'var(--secondary)';
                });
            });
            
            // Initialize default tab (summary)
            const defaultTabButton = document.querySelector('[data-tab="summary"]');
            if (defaultTabButton) {
                defaultTabButton.className = 'tab py-4 px-1 border-b-2 border-primary text-primary font-medium text-xs whitespace-nowrap';
                defaultTabButton.style.color = 'var(--primary)';
                defaultTabButton.style.borderColor = 'var(--primary)';
            }
            
            const defaultTabContent = document.getElementById('summary-tab');
            if (defaultTabContent) {
                defaultTabContent.classList.remove('hidden');
                defaultTabContent.classList.add('active');
            }
        });
    </script>
    <div
        id="priceInspectorModal"
        class="fixed inset-0 z-40 hidden"
        style="background-color: rgba(15, 23, 42, 0.35);"
    >
        <div class="w-full h-full flex items-center justify-center p-4">
            <div
                class="w-full max-w-5xl max-h-[80vh] bg-background border rounded-lg shadow-xl flex flex-col"
                style="background-color: var(--card); border-color: var(--border); color: var(--foreground);"
            >
                <div class="flex items-start justify-between gap-4 px-4 py-3 border-b" style="border-color: var(--border);">
                    <div>
                        <h2 class="text-sm font-semibold">區間價格明細</h2>
                        <p id="priceInspectorSubtitle" class="text-[11px] mt-1" style="color: var(--muted-foreground);"></p>
                    </div>
                    <button
                        type="button"
                        id="closePriceInspector"
                        class="text-[11px] px-2 py-1 rounded-md border"
                        style="border-color: var(--border); color: var(--muted-foreground); background-color: var(--background);"
                    >
                        關閉
                    </button>
                </div>
                <div class="flex-1 overflow-hidden">
                    <div
                        id="priceInspectorDebugPanel"
                        class="px-4 py-3 border-b hidden"
                        style="border-color: var(--border); color: var(--muted-foreground);"
                    ></div>
                    <div class="overflow-auto max-h-[60vh]" tabindex="0">
                        <table class="min-w-full text-xs">
                            <thead style="background-color: var(--muted); color: var(--foreground);">
                                <tr id="priceInspectorHeaderRow"></tr>
                            </thead>
                            <tbody id="priceInspectorTableBody" class="divide-y" style="border-color: var(--border);"></tbody>
                        </table>
                    </div>
                </div>
                <div class="px-4 py-2 text-[11px]" style="color: var(--muted-foreground);">
                    計算公式以「原始收盤價 × 還原因子 = 還原收盤價」呈現；若顯示「未調整」或還原因子為空值，代表該筆價格沿用原始資料。
                </div>
            </div>
        </div>
    </div>
</body>
</html>
