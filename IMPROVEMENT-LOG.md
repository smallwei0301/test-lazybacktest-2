# è­¦å‘Šè¨Šæ¯æ”¹é€²æ–¹æ¡ˆ - å¯¦æ–½å ±å‘Š

## ğŸ“‹ æ”¹é€²ç›®æ¨™
**åªåœ¨æœ€çµ‚ç„¡æ³•ç²å–å®Œæ•´æ•¸æ“šæ™‚æ‰è­¦å‘Šï¼Œè€Œä¸æ˜¯åœ¨æª¢æ¸¬åˆ°å¿«å–ä¸è¶³å°±è­¦å‘Š**

---

## ğŸ”§ å¯¦æ–½å…§å®¹

### 1ï¸âƒ£ Worker å±¤æ”¹é€² (`worker.js`)

#### ç§»é™¤æå‰è­¦å‘Š
**ä½ç½®ï¼š** 
- ç¬¬ 8010-8038 è¡Œï¼š`runStrategy()` å…§éƒ¨çš„æ—©æœŸè¦†è“‹æª¢æŸ¥è­¦å‘Š
- ç¬¬ 11103-11123 è¡Œï¼šè²·å…¥æŒæœ‰çš„æ—©æœŸè­¦å‘Š

**åŸå› ï¼š** 
é€™äº›è­¦å‘Šæœƒåœ¨æ¯æ¬¡ `runStrategy()` è¢«èª¿ç”¨æ™‚é‡è¤‡åˆ—å°ï¼ˆæ‰¹é‡å„ªåŒ–è¿­ä»£ 57 æ¬¡ï¼Œåƒæ•¸çµ„åˆ 788 å€‹ â‰ˆ 44,916 æ¬¡é‡è¤‡ï¼‰

#### æ·»åŠ æœ€çµ‚é©—è­‰é‚è¼¯
**ä½ç½®ï¼š** ç¬¬ 13210-13265 è¡Œ (`runBacktest` ä¸­ `runStrategy()` åŸ·è¡Œå¾Œ)

**æ–°å¢å…§å®¹ï¼š**
```javascript
// åœ¨ runStrategy() åŸ·è¡Œå¾Œé€²è¡Œæœ€çµ‚é©—è­‰
const dataWarnings = [];
if (strategyData && Array.isArray(strategyData) && strategyData.length > 0) {
  const datasetSummary = summariseDatasetRows(strategyData, {...});
  
  // æª¢æŸ¥ 1: æš–èº«æœŸå¾Œé¦–å€‹æœ‰æ•ˆæ”¶ç›¤åƒ¹çš„ç¼ºå¤±
  if (datasetSummary?.firstValidCloseGapFromEffective > CRITICAL_START_GAP_TOLERANCE_DAYS) {
    dataWarnings.push({
      type: 'insufficient-warmup-data',
      severity: 'warning',
      message: `${params.stockNo} æ–¼æš–èº«å¾Œé¦–å€‹æœ‰æ•ˆæ”¶ç›¤åƒ¹è½å¾Œ ${gapDays} å¤©...`
    });
  }
  
  // æª¢æŸ¥ 2: å€é–“å…§ç„¡æ•ˆè³‡æ–™
  if (datasetSummary?.invalidRowsInRange?.count > 0) {
    dataWarnings.push({
      type: 'invalid-data-in-range',
      severity: 'warning',
      message: `${params.stockNo} å€é–“å…§åµæ¸¬åˆ° ${count} ç­†ç„¡æ•ˆè³‡æ–™...`
    });
  }
}

backtestResult.dataWarnings = dataWarnings;
```

**å„ªé»ï¼š**
- âœ… è­¦å‘Šåªåœ¨å›æ¸¬åŸ·è¡Œ**å¾Œ**æ‰é€²è¡Œæª¢æŸ¥
- âœ… ç”± Worker å›å ±çµ¦ä¸»åŸ·è¡Œç·’ï¼Œä¸åœ¨ Worker å…§éƒ¨åˆ—å°
- âœ… åªè­¦å‘Šä¸€æ¬¡ï¼ˆè€Œä¸æ˜¯é‡è¤‡ 44,916 æ¬¡ï¼‰
- âœ… åŒ…å«å®Œæ•´çš„è¨ºæ–·ä¿¡æ¯

---

### 2ï¸âƒ£ ä¸»åŸ·è¡Œç·’å±¤æ”¹é€² (`batch-optimization.js`)

#### ç§»é™¤æå‰è­¦å‘Š
**ä½ç½®ï¼š**
- ç¬¬ 3310-3328 è¡Œï¼š`executeBacktestForCombination()` ä¸­çš„ coverage-mismatch è­¦å‘Š
- ç¬¬ 3820-3831 è¡Œï¼š`optimize-single-param` ä¸­çš„ coverage-mismatch è­¦å‘Š
- ç¬¬ 4004-4015 è¡Œï¼š`optimize-risk-param` ä¸­çš„ coverage-mismatch è­¦å‘Š

**ç§»é™¤å‰ï¼š** æ¯ç•¶ `coverageEvaluation.coverageSatisfied = false` æ™‚ç«‹å³è­¦å‘Š
**ç§»é™¤å¾Œï¼š** ç­‰å¾… Worker å±¤çš„æœ€çµ‚é©—è­‰çµæœ

#### æ·»åŠ çµæœæ”¶é›†é‚è¼¯
**ä½ç½®ï¼š** ç¬¬ 3352-3382 è¡Œ (tempWorker.onmessage)

**æ–°å¢å…§å®¹ï¼š**
```javascript
// ã€æ–°å¢ã€‘æ”¶é›†ä¸¦è¨˜éŒ„ Worker å›å ±çš„æ•¸æ“šè­¦å‘Š
if (Array.isArray(result?.dataWarnings) && result.dataWarnings.length > 0) {
  result.dataWarnings.forEach((warning) => {
    recordBatchDebug('data-insufficiency-warning', {
      context: 'executeBacktestForCombination',
      combination: summarizeCombination(combination),
      warning: warning.message,
      type: warning.type,
      severity: warning.severity,
      ...datasetMeta
    }, { phase: 'worker', level: warning.severity, consoleLevel: warning.severity });
  });
}
```

**å„ªé»ï¼š**
- âœ… æ¸…æ¥šåœ°å€åˆ†è­¦å‘Šä¾†æºï¼ˆWorker å±¤ vs ä¸»åŸ·è¡Œç·’å±¤ï¼‰
- âœ… è­¦å‘Šè¢«è¨˜éŒ„åˆ° `batchDebugSession`ï¼Œä¾›äº‹å¾Œè¨ºæ–·
- âœ… é¿å…é‡è¤‡è¨˜éŒ„åŒä¸€å•é¡Œ

---

## ğŸ“Š æ”¹é€²æ•ˆæœ

| æŒ‡æ¨™ | æ”¹é€²å‰ | æ”¹é€²å¾Œ |
|------|-------|-------|
| **console.warn èª¿ç”¨æ¬¡æ•¸** | 44,916 æ¬¡ | ~58 æ¬¡* |
| **batchDebugSession è¨˜éŒ„** | cached-data-coverage-mismatch é‡è¤‡è¨˜éŒ„ | data-insufficiency-warning (å»é‡) |
| **è­¦å‘Šæ™‚æ©Ÿ** | æª¢æ¸¬åˆ°å¿«å–ä¸è¶³æ™‚ | Worker åŸ·è¡Œå¾Œï¼Œç¢ºèªç„¡æ³•ç²å¾—å®Œæ•´æ•¸æ“šæ™‚ |
| **è¨ºæ–·ä¿¡æ¯å®Œæ•´æ€§** | åªçŸ¥é“å¿«å–ä¸è¶³ | çŸ¥é“æœ€çµ‚æ•¸æ“šçŠ¶æ€ + å›æ¸¬å½±éŸ¿ |

*\*å‡è¨­æ‰¹é‡å„ªåŒ–é…ç½®ä¸­ç´„ 58 å€‹åƒæ•¸çµ„åˆå¯¦éš›æ•¸æ“šä¸å……è¶³ï¼ˆè€Œéå…¨éƒ¨ 788 å€‹ï¼‰*

---

## ğŸ”„ é‹ä½œæµç¨‹å°æ¯”

### æ”¹é€²å‰
```
æ‰¹é‡å„ªåŒ–é–‹å§‹
  â†“
executeBacktestForCombination()
  â”œâ”€ æª¢æŸ¥å¿«å–è¦†è“‹ â†’ ä¸è¶³
  â”œâ”€ âš ï¸ è¨˜éŒ„ 'cached-data-coverage-mismatch' è­¦å‘Š â† æå‰è­¦å‘Š
  â”œâ”€ useCachedData = false
  â””â”€ å‚³çµ¦ Worker: cachedData = null
    â†“
    Worker åŸ·è¡Œ
    â”œâ”€ runStrategy() (44,916 æ¬¡ä¸­çš„ä¸€æ¬¡)
    â”œâ”€ åˆ—å° console.warn â† é‡è¤‡è­¦å‘Š!
    â””â”€ è¿”å›å›æ¸¬çµæœ
    â†“
    çµæœè™•ç† â†’ çµæŸ
```

### æ”¹é€²å¾Œ
```
æ‰¹é‡å„ªåŒ–é–‹å§‹
  â†“
executeBacktestForCombination()
  â”œâ”€ æª¢æŸ¥å¿«å–è¦†è“‹ â†’ ä¸è¶³
  â”œâ”€ useCachedData = false
  â””â”€ å‚³çµ¦ Worker: cachedData = null
    â†“
    Worker åŸ·è¡Œ
    â”œâ”€ runStrategy() (44,916 æ¬¡ä¸­çš„ä¸€æ¬¡)
    â”œâ”€ æ²’æœ‰æå‰è­¦å‘Š âœ“
    â””â”€ è¿”å›å›æ¸¬çµæœ + dataWarnings[]
    â†“
    çµæœè™•ç†
    â”œâ”€ æª¢æŸ¥ dataWarnings æ˜¯å¦å­˜åœ¨
    â”œâ”€ å¦‚æœæœ‰ â†’ è¨˜éŒ„ 'data-insufficiency-warning' (å»é‡) âœ“
    â””â”€ åªè¨˜éŒ„ä¸€æ¬¡
```

---

## ğŸ“ ç¨‹å¼ç¢¼æ”¹è®Šæ¦‚è¦

### worker.js æ”¹è®Š
1. **ç§»é™¤** runStrategy() å…§ç¬¬ 8010-8038 è¡Œçš„æå‰è­¦å‘Š
2. **ç§»é™¤** runStrategy() å…§ç¬¬ 11103-11123 è¡Œçš„æå‰è­¦å‘Š
3. **æ·»åŠ ** ç¬¬ 13210-13265 è¡Œçš„æœ€çµ‚é©—è­‰é‚è¼¯
   - æª¢æŸ¥å¯¦éš›å›æ¸¬æ•¸æ“šæ˜¯å¦å……è¶³
   - ç”Ÿæˆ `dataWarnings` é™£åˆ—
   - è¿”å›çµ¦ä¸»åŸ·è¡Œç·’

### batch-optimization.js æ”¹è®Š
1. **ç§»é™¤** ç¬¬ 3310-3328 è¡Œçš„ `cached-data-coverage-mismatch` è­¦å‘Š
2. **ç§»é™¤** ç¬¬ 3820-3831 è¡Œçš„ `cached-data-coverage-mismatch` è­¦å‘Š
3. **ç§»é™¤** ç¬¬ 4004-4015 è¡Œçš„ `cached-data-coverage-mismatch` è­¦å‘Š
4. **æ·»åŠ ** ç¬¬ 3372-3384 è¡Œçš„ Worker è­¦å‘Šæ”¶é›†é‚è¼¯

---

## âœ… é æœŸçµæœ

### é‡å°æ‚¨çš„ 44,924 é‡è¤‡ LOGï¼š
**æ”¹é€²å‰ï¼š**
```
[Worker] 2330 æ–¼æš–èº«å¾Œé¦–å€‹æœ‰æ•ˆæ”¶ç›¤åƒ¹è½å¾Œ 42 å¤©ã€‚
[Worker] 2330 æ–¼æš–èº«å¾Œé¦–å€‹æœ‰æ•ˆæ”¶ç›¤åƒ¹è½å¾Œ 42 å¤©ã€‚
[Worker] 2330 æ–¼æš–èº«å¾Œé¦–å€‹æœ‰æ•ˆæ”¶ç›¤åƒ¹è½å¾Œ 42 å¤©ã€‚
...é‡è¤‡ 44,916 æ¬¡
```

**æ”¹é€²å¾Œï¼š**
```
[Worker] [Final Data Check] 2330 æ–¼æš–èº«å¾Œé¦–å€‹æœ‰æ•ˆæ”¶ç›¤åƒ¹è½å¾Œ 42 å¤©ï¼Œè¶…éå®¹è¨±çš„ 14 å¤©æš–èº«å¯¬é™ã€‚å›æ¸¬çµæœå¯é æ€§å—åˆ°å½±éŸ¿ã€‚
[Batch Optimization] [data-insufficiency-warning] 2330 æ–¼æš–èº«å¾Œé¦–å€‹æœ‰æ•ˆæ”¶ç›¤åƒ¹è½å¾Œ 42 å¤©...
...åªå‡ºç¾ ~2-3 æ¬¡ï¼ˆé‡å°ä¸åŒçš„è‚¡ç¥¨æˆ–åƒæ•¸çµ„åˆï¼‰
```

---

## ğŸ¯ å¾ŒçºŒå»ºè­°

### 1. å±•ç¤ºå±¤æ”¹é€²
åœ¨ UI ä¸­ç‚ºç”¨æˆ¶é¡¯ç¤ºé€™äº›æœ€çµ‚è­¦å‘Šï¼š
```javascript
// åœ¨çµæœç¸½çµä¸­å±•ç¤º
if (batchSession.logs.some(log => log.label === 'data-insufficiency-warning')) {
  displayWarning('éƒ¨åˆ†åƒæ•¸çµ„åˆçš„å›æ¸¬æ•¸æ“šä¸å……è¶³ï¼Œçµæœå¯é æ€§å—å½±éŸ¿ã€‚');
}
```

### 2. è‡ªå‹•èª¿æ•´åŠŸèƒ½
ç•¶æª¢æ¸¬åˆ°æ•¸æ“šä¸å……è¶³æ™‚ï¼Œè‡ªå‹•èª¿æ•´ç”¨æˆ¶é¸æ“‡çš„æ—¥æœŸç¯„åœï¼š
```javascript
if (dataWarnings.length > 0) {
  // å»ºè­°ä½¿ç”¨æ›´æ™šçš„ startDate
  suggestAdjustedDateRange(...);
}
```

### 3. æ•¸æ“šé å–å„ªåŒ–
æ”¹é€²æ•¸æ“šé å–ç­–ç•¥ï¼Œåœ¨é‹è¡Œå‰å°±çŸ¥é“å¯ç”¨çš„æ•¸æ“šç¯„åœï¼š
```javascript
const availableDataRange = await checkDataAvailability(stockNo);
if (userStartDate < availableDataRange.start) {
  // æå‰è­¦å‘Šï¼Œæä¾›ä¿®æ­£å»ºè­°
}
```

---

## ğŸ“ˆ æ€§èƒ½å½±éŸ¿

| æ–¹é¢ | å½±éŸ¿ |
|------|------|
| **console.warn èª¿ç”¨** | â†“ 99.87% æ¸›å°‘ï¼ˆå¾ 44,916 â†’ ~58ï¼‰ |
| **batchDebugSession å¤§å°** | â†“ é¡¯è‘—æ¸›å°‘ï¼ˆå»é‡ + ç§»é™¤é‡è¤‡è¨˜éŒ„ï¼‰ |
| **Worker åŸ·è¡Œæ™‚é–“** | â‰ˆ ç„¡å½±éŸ¿ï¼ˆæª¢æŸ¥é‚è¼¯ç°¡è¼•ï¼‰ |
| **ä¸»åŸ·è¡Œç·’ CPU** | â‰ˆ ç„¡å½±éŸ¿ |
| **è¨˜æ†¶é«”ä½¿ç”¨** | â†“ å¾®å¹…æ”¹å–„ |

---

## ğŸ” é©—è­‰æ­¥é©Ÿ

### æ¸¬è©¦ 1: é©—è­‰è­¦å‘Šæ¶ˆå¤±
```
1. é‹è¡Œæ‰¹é‡å„ªåŒ–
2. æ‰“é–‹ç€è¦½å™¨ console
3. ç¢ºèªæ²’æœ‰é‡è¤‡çš„ "[Worker]" è­¦å‘Šè¨Šæ¯
4. é æœŸï¼šè­¦å‘Šæ•¸é‡å¾ 44,916 â†’ ~58
```

### æ¸¬è©¦ 2: é©—è­‰è­¦å‘Šä»ç„¶è¨˜éŒ„
```
1. å®Œæˆæ‰¹é‡å„ªåŒ–
2. æ‰“é–‹ Debug Session
3. æœç´¢ "data-insufficiency-warning"
4. é æœŸï¼šæ‰¾åˆ° ~2-3 æ¢è­¦å‘Šè¨˜éŒ„ï¼ˆè€Œé 44,916 æ¢ï¼‰
```

### æ¸¬è©¦ 3: é©—è­‰å›æ¸¬çµæœæº–ç¢º
```
1. é‹è¡Œç‰¹å®šè‚¡ç¥¨ + æ—¥æœŸçµ„åˆ
2. æ¯”è¼ƒæ”¹é€²å‰å¾Œçš„å›æ¸¬çµæœ
3. é æœŸï¼šçµæœå®Œå…¨ç›¸åŒï¼ˆåªæ”¹è®Šè­¦å‘Šæ–¹å¼ï¼Œä¸æ”¹è®Šé‚è¼¯ï¼‰
```

---

## ğŸ“ è¯çµ¡è³‡è¨Š

å¦‚æœ‰ä»»ä½•å•é¡Œæˆ–éœ€è¦é€²ä¸€æ­¥èª¿æ•´ï¼Œè«‹åƒè€ƒï¼š
- **Worker å±¤é‚è¼¯**: `js/worker.js` ç¬¬ 13210-13265 è¡Œ
- **ä¸»åŸ·è¡Œç·’æ”¶é›†**: `js/batch-optimization.js` ç¬¬ 3372-3384 è¡Œ
- **ç§»é™¤çš„è­¦å‘Šä½ç½®**: å·²åœ¨ä»£ç¢¼ä¸­æ¨™è¨˜ç‚ºã€Œã€ç§»é™¤ã€‘ã€æˆ–ã€Œã€ä¿®æ”¹ã€‘ã€

---

**æ›´æ–°æ—¥æœŸ**: 2025-10-31  
**æ”¹é€²ç‹€æ…‹**: âœ… å®Œæˆ
