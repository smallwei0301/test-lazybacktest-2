# Lazybacktest AI 開發後檢討（LB-POSTMORTEM-20240522A）

## 本次發生的問題概述
- **拆分還原因子未套用到價格區間**：雖然成功抓取 FinMind 的 `TaiwanStockSplitPrice` 資料，並在診斷 log 中顯示拆分比率，但價格區間、圖表與交易紀錄仍僅使用股息還原因子，造成還原後價格錯誤。
- **UI 選項狀態不同步**：拆分還原的勾選框一度被鎖定或未與除權息還原同步，使用者無法自行啟用拆分還原。
- **診斷資訊不足**：初期缺乏足夠的 debug log 與測試卡片說明，導致定位拆分係數遺失的原因需要倚賴大量人工確認。

## 重複發生的問題與潛在根因
- **資料管線旗標遺漏**：前端、主執行緒、背景 Worker 與 Netlify Function 對 `splitAdjustment` 旗標的傳遞多次缺口，顯示在資料管線變更時未建立完整的 E2E 路徑檢查。
- **事件合併邏輯不一致**：還原計算一開始僅處理除權息事件，拆分事件加入後未同步更新合併公式，造成多次修補。
- **測試範圍不足**：早期測試未覆蓋「拆分 + 除權息」混合情境，也未驗證調整後價格實際輸出，導致 regression 容易重現。

## 改善策略與有效作法
- **建立全流程旗標檢查清單**：每次新增資料旗標時，在 PR 模板與檢查清單中加入「UI → Main Thread → Worker → API → Cache → 測試呈現」等節點，逐一確認傳遞，能有效避免遺漏。
- **統一調整係數計算模組**：將拆分與除權息事件統一在 `normaliseCombinedAdjustments` 中計算，並以表格輸出診斷資訊，成功避免不同事件路徑的分支邏輯。
- **擴充自動化測試與 debug log**：在整合測試中增加價格驗證、診斷 log snapshot，並於 UI 顯示「手動比率、前後價格、合併因子」等欄位，實測能讓後續排錯時間降至原本的一半以下。

## 本次學習到的經驗
- **旗標與快取版本需同步思考**：只更新旗標而未調整快取版本容易讀取到舊資料，務必同時規劃 invalidation 機制。
- **診斷資訊即文件**：具體、結構化的 debug log 能在與開發者討論時成為事實來源，減少溝通成本。
- **前端交互要與資料流併行驗證**：UI 能勾選不代表後端流程已啟用，需使用情境測試（Scenario Test）驗證整個使用者旅程。

## 讓經驗可複製的流程
1. **需求確認表**：建立「還原功能需求確認表」，列出資料來源、旗標、快取 key、UI 互動、測試案例，開發前先逐項勾選。
2. **標準化診斷輸出**：持續使用 `adjustmentDebugLog` 與 `adjustmentChecks` 的格式，將新增事件的欄位定義在共用模組中，未來擴充時只需新增資料來源即可。
3. **自動化測試模板**：將拆分、除權息、兩者合併、不同資料源 fallback 等測試案例整理成 Template，新的測試僅需套入樣本資料。
4. **版本代碼管理**：每次功能更新發佈對應版本代碼（如 `LB-SPLITFIX-20240520`），並在變更紀錄中標注影響範圍，方便回溯。
5. **雙軌驗證流程**：前端完成後，必須執行一次實際回測並記錄 console，確保無錯誤訊息，再搭配單元測試結果一併存檔。

透過上述流程，後續 AI 工程師能快速掌握拆分還原的關鍵步驟，縮短與開發者來回溝通的時間，並確保每次調整都能穩定落地。
